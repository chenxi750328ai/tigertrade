# åè®®ç‰ˆæœ¬ç®¡ç†å’Œè‡ªåŠ¨é€šçŸ¥æœºåˆ¶

## é—®é¢˜1: åè®®å˜æ›´å¦‚ä½•é€šçŸ¥å…¶ä»–Agentï¼Ÿ

---

## ğŸ”´ é—®é¢˜çš„ä¸¥é‡æ€§

**åœºæ™¯**ï¼š
```
Masteræ›´æ–°äº†åè®®ï¼ˆå¢åŠ propose_taskåŠŸèƒ½ï¼‰
   â†“
Worker_A: ä½¿ç”¨æ—§ç‰ˆåè®®ï¼Œä¸çŸ¥é“æ–°åŠŸèƒ½
Worker_B: ä½¿ç”¨æ–°ç‰ˆåè®®
   â†“
ç»“æœ: æ··ä¹±ï¼Worker_Aå¯èƒ½é”™è¯¯æ“ä½œæˆ–åŠŸèƒ½ç¼ºå¤±
```

è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»å…¸é—®é¢˜ï¼š**åè®®ä¸ä¸€è‡´**

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šåè®®ç‰ˆæœ¬ç®¡ç† + è‡ªåŠ¨é€šçŸ¥

### æ¶æ„è®¾è®¡

```
1. åè®®æ–‡æ¡£åŒ–ï¼ˆPROTOCOL.mdï¼‰
2. ç‰ˆæœ¬å·ç®¡ç†ï¼ˆsemantic versioningï¼‰
3. çŠ¶æ€æ–‡ä»¶è®°å½•ç‰ˆæœ¬
4. Workerå¯åŠ¨æ—¶æ£€æŸ¥ç‰ˆæœ¬
5. Masterä¸»åŠ¨é€šçŸ¥åè®®æ›´æ–°
6. Workeræ‹‰å–æ–°åè®®æ–‡æ¡£
```

---

## å®ç°æ–¹æ¡ˆ

### 1. åè®®æ–‡æ¡£åŒ–

**æ–‡ä»¶**: `/home/cx/tigertrade/PROTOCOL.md`

```markdown
# TigerTradeå¤šAgentåè®®è§„èŒƒ

## ç‰ˆæœ¬: v2.0.0

### å˜æ›´å†å²
- v2.0.0 (2025-01-21): å¢åŠ propose_task, approve_taskæœºåˆ¶
- v1.1.0 (2025-01-20): å¢åŠ request_help, progress_update
- v1.0.0 (2025-01-19): åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€ä»»åŠ¡åˆ†é…

### æ¶ˆæ¯ç±»å‹

#### Worker â†’ Master

| æ¶ˆæ¯ç±»å‹ | ç‰ˆæœ¬ | å¿…éœ€å­—æ®µ | è¯´æ˜ |
|---------|------|---------|------|
| worker_ready | v1.0+ | - | Workeræ³¨å†Œ |
| task_complete | v1.0+ | task_id, result | ä»»åŠ¡å®Œæˆ |
| task_failed | v1.1+ | task_id, error | ä»»åŠ¡å¤±è´¥ |
| request_help | v1.1+ | problem | è¯·æ±‚å¸®åŠ© |
| progress_update | v1.1+ | task_id, progress | è¿›åº¦æ›´æ–° |
| **task_proposal** | **v2.0+** | type, description, reason | **æè®®ä»»åŠ¡** |

#### Master â†’ Worker

| æ¶ˆæ¯ç±»å‹ | ç‰ˆæœ¬ | å¿…éœ€å­—æ®µ | è¯´æ˜ |
|---------|------|---------|------|
| task_assign | v1.0+ | task_id, type | åˆ†é…ä»»åŠ¡ |
| guidance | v1.1+ | message | æä¾›æŒ‡å¯¼ |
| **task_approved** | **v2.0+** | task_id | **ä»»åŠ¡å·²æ‰¹å‡†** |
| **task_rejected** | **v2.0+** | task_id, reason | **ä»»åŠ¡è¢«æ‹’ç»** |
```

### 2. çŠ¶æ€æ–‡ä»¶ä¸­è®°å½•åè®®ç‰ˆæœ¬

```json
{
  "protocol_version": "2.0.0",
  "last_updated": 1737123456.789,
  "agents": { ... },
  "messages": [ ... ]
}
```

### 3. Workerå¯åŠ¨æ—¶æ£€æŸ¥ç‰ˆæœ¬

```python
#!/usr/bin/env python3
"""Worker Agent - å¸¦åè®®ç‰ˆæœ¬æ£€æŸ¥"""
import json, time
from pathlib import Path

WORKER_ID = "worker_lingma"
WORKER_PROTOCOL_VERSION = "1.0.0"  # Workerå½“å‰æ”¯æŒçš„åè®®ç‰ˆæœ¬
STATE_FILE = Path("/tmp/tigertrade_agent_state.json")

def check_protocol_version():
    """æ£€æŸ¥åè®®ç‰ˆæœ¬å…¼å®¹æ€§"""
    state = json.loads(STATE_FILE.read_text())
    
    system_version = state.get("protocol_version", "1.0.0")
    
    # è§£æç‰ˆæœ¬å·
    system_major = int(system_version.split('.')[0])
    worker_major = int(WORKER_PROTOCOL_VERSION.split('.')[0])
    
    if system_major > worker_major:
        # ä¸»ç‰ˆæœ¬ä¸å…¼å®¹ï¼
        print(f"\nâš ï¸  åè®®ç‰ˆæœ¬ä¸å…¼å®¹ï¼")
        print(f"   ç³»ç»Ÿç‰ˆæœ¬: {system_version}")
        print(f"   Workerç‰ˆæœ¬: {WORKER_PROTOCOL_VERSION}")
        print(f"\n   ğŸ“š è¯·é˜…è¯»æ–°åè®®æ–‡æ¡£ï¼š")
        print(f"      /home/cx/tigertrade/PROTOCOL.md")
        print(f"      /home/cx/tigertrade/CHANGELOG.md")
        
        # è¯·æ±‚åè®®æ›´æ–°
        request_protocol_update()
        return False
    
    elif system_version != WORKER_PROTOCOL_VERSION:
        # æ¬¡ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½æœ‰æ–°åŠŸèƒ½
        print(f"\nğŸ’¡ æ£€æµ‹åˆ°åè®®æ›´æ–°")
        print(f"   å½“å‰: {WORKER_PROTOCOL_VERSION} â†’ ç³»ç»Ÿ: {system_version}")
        print(f"   å¯ä»¥ç»§ç»­å·¥ä½œï¼Œä½†å»ºè®®æ›´æ–°ä»¥ä½¿ç”¨æ–°åŠŸèƒ½")
    
    return True

def request_protocol_update():
    """è¯·æ±‚åè®®æ–‡æ¡£"""
    state = json.loads(STATE_FILE.read_text())
    
    state["messages"].append({
        "id": f"msg_{time.time()}",
        "from": WORKER_ID,
        "to": "master",
        "type": "protocol_version_mismatch",
        "data": {
            "worker_version": WORKER_PROTOCOL_VERSION,
            "system_version": state.get("protocol_version"),
            "request": "è¯·å‘é€æ–°åè®®æ–‡æ¡£"
        },
        "timestamp": time.time()
    })
    
    STATE_FILE.write_text(json.dumps(state, indent=2))
    print(f"âœ… å·²è¯·æ±‚åè®®æ›´æ–°")

# å¯åŠ¨æ—¶æ£€æŸ¥
if __name__ == "__main__":
    print(f"ğŸš€ Worker {WORKER_ID} å¯åŠ¨")
    
    if not check_protocol_version():
        print("âŒ åè®®ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œè¯·æ›´æ–°Workerä»£ç ")
        exit(1)
    
    print("âœ… åè®®ç‰ˆæœ¬å…¼å®¹ï¼Œç»§ç»­å·¥ä½œ...")
    # ... æ­£å¸¸å·¥ä½œæµç¨‹
```

### 4. Masterä¸»åŠ¨é€šçŸ¥åè®®æ›´æ–°

```python
class MasterAgent:
    def __init__(self):
        self.protocol_version = "2.0.0"
        self.coordinator = AgentCoordinator()
        # ...
    
    def broadcast_protocol_update(self, new_version, changes):
        """å¹¿æ’­åè®®æ›´æ–°"""
        print(f"\nğŸ“¢ å¹¿æ’­åè®®æ›´æ–°: {self.protocol_version} â†’ {new_version}")
        
        # æ›´æ–°çŠ¶æ€æ–‡ä»¶
        state = json.loads(STATE_FILE.read_text())
        state["protocol_version"] = new_version
        state["last_updated"] = time.time()
        STATE_FILE.write_text(json.dumps(state, indent=2))
        
        # é€šçŸ¥æ‰€æœ‰Worker
        for worker_id in self.workers.keys():
            self.coordinator.send_message(
                worker_id,
                "protocol_update",
                {
                    "new_version": new_version,
                    "changes": changes,
                    "documentation": "/home/cx/tigertrade/PROTOCOL.md",
                    "changelog": "/home/cx/tigertrade/CHANGELOG.md",
                    "action_required": True
                }
            )
        
        print(f"âœ… å·²é€šçŸ¥ {len(self.workers)} ä¸ªWorker")
    
    def _process_messages(self):
        """å¤„ç†æ¶ˆæ¯"""
        messages = self.coordinator.receive_messages()
        
        for msg in messages:
            if msg['type'] == 'protocol_version_mismatch':
                # WorkeræŠ¥å‘Šç‰ˆæœ¬ä¸åŒ¹é…
                worker_id = msg['from']
                worker_version = msg['data']['worker_version']
                
                print(f"\nâš ï¸  {worker_id} åè®®ç‰ˆæœ¬è¿‡æœŸ")
                print(f"   Workerç‰ˆæœ¬: {worker_version}")
                print(f"   ç³»ç»Ÿç‰ˆæœ¬: {self.protocol_version}")
                
                # å‘é€åè®®æ–‡æ¡£
                self._send_protocol_docs(worker_id)

    def _send_protocol_docs(self, worker_id):
        """å‘é€åè®®æ–‡æ¡£ç»™Worker"""
        # è¯»å–åè®®æ–‡æ¡£
        protocol_doc = Path("/home/cx/tigertrade/PROTOCOL.md").read_text()
        
        # å‘é€
        self.coordinator.send_message(
            worker_id,
            "protocol_documentation",
            {
                "version": self.protocol_version,
                "content": protocol_doc,
                "action": "è¯·æ›´æ–°Workerä»£ç ä»¥æ”¯æŒæ–°åŠŸèƒ½"
            }
        )
```

### 5. åè®®æ›´æ–°æµç¨‹

```
Step 1: Masterå‡çº§åè®®
   Master.protocol_version = "2.0.0"
   æ›´æ–°ä»£ç ï¼Œå¢åŠ æ–°åŠŸèƒ½
   â†“

Step 2: Masterå¹¿æ’­æ›´æ–°
   broadcast_protocol_update(
       new_version="2.0.0",
       changes=["æ–°å¢propose_task", "æ–°å¢approve_task"]
   )
   â†“

Step 3: Workeræ”¶åˆ°é€šçŸ¥
   æ”¶åˆ° protocol_update æ¶ˆæ¯
   {
       "type": "protocol_update",
       "new_version": "2.0.0",
       "changes": [...],
       "documentation": "path/to/PROTOCOL.md"
   }
   â†“

Step 4: Workerå“åº”
   
   æƒ…å†µA: Workeræ”¯æŒæ–°ç‰ˆæœ¬
      â†’ æ›´æ–° WORKER_PROTOCOL_VERSION
      â†’ å‘é€ protocol_acknowledged
   
   æƒ…å†µB: Workerä¸æ”¯æŒ
      â†’ å‘é€ protocol_version_mismatch
      â†’ Masterå‘é€æ–‡æ¡£
      â†’ Workeræš‚åœå·¥ä½œï¼Œç­‰å¾…äººå·¥æ›´æ–°ä»£ç 

Step 5: éªŒè¯
   Masteræ£€æŸ¥æ‰€æœ‰Workerçš„ç‰ˆæœ¬
   ç¡®ä¿å…¼å®¹æ€§
```

---

## ğŸ¯ å®é™…ä½¿ç”¨

### åœºæ™¯: Masterå¢åŠ æ–°åŠŸèƒ½

```python
# 1. Masterä»£ç å¢åŠ æ–°åŠŸèƒ½
class MasterAgent:
    def __init__(self):
        self.protocol_version = "2.1.0"  # å‡çº§ç‰ˆæœ¬
        # ...

# 2. å¹¿æ’­æ›´æ–°
master.broadcast_protocol_update(
    new_version="2.1.0",
    changes=[
        "æ–°å¢: Agenté—´è‡ªç”±è®¨è®ºï¼ˆbroadcastæ¶ˆæ¯ï¼‰",
        "æ–°å¢: åˆ†å¸ƒå¼RAGå†™å…¥æƒé™"
    ]
)

# 3. æ›´æ–°PROTOCOL.md
# ... æ–‡æ¡£æ›´æ–° ...

# 4. Workeræ”¶åˆ°é€šçŸ¥
# Worker_A: "æˆ‘æ”¯æŒv2.1.0" â†’ ç»§ç»­å·¥ä½œ
# Worker_B: "æˆ‘åªæ”¯æŒv1.0.0" â†’ è¯·æ±‚æ–‡æ¡£ â†’ æš‚åœç­‰å¾…æ›´æ–°
```

---

## ğŸ“‹ åè®®æ–‡æ¡£æ¨¡æ¿

åˆ›å»º `/home/cx/tigertrade/PROTOCOL.md`:

```markdown
# TigerTradeå¤šAgentåè®®è§„èŒƒ v2.0.0

## 1. æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰æ¶ˆæ¯éµå¾ªç»Ÿä¸€æ ¼å¼ï¼š
\`\`\`json
{
  "id": "msg_<timestamp>",
  "from": "<agent_id>",
  "to": "<target_agent_id>",
  "type": "<message_type>",
  "data": { ... },
  "timestamp": <unix_timestamp>
}
\`\`\`

## 2. æ¶ˆæ¯ç±»å‹

### 2.1 Worker â†’ Master

#### task_proposal (v2.0+)
æè®®æ–°ä»»åŠ¡

**å¿…éœ€å­—æ®µ**:
- type: ä»»åŠ¡ç±»å‹
- description: ä»»åŠ¡æè¿°
- reason: æè®®åŸå› 

**ç¤ºä¾‹**:
\`\`\`python
{
  "type": "task_proposal",
  "data": {
    "type": "data_validation",
    "description": "éªŒè¯æ•°æ®è´¨é‡",
    "reason": "å‘ç°10%å¼‚å¸¸å€¼"
  }
}
\`\`\`

## 3. ç‰ˆæœ¬å…¼å®¹æ€§

- ä¸»ç‰ˆæœ¬å·å˜æ›´ï¼ˆv1.x â†’ v2.xï¼‰ï¼šä¸å…¼å®¹ï¼Œå¿…é¡»æ›´æ–°
- æ¬¡ç‰ˆæœ¬å·å˜æ›´ï¼ˆv2.0 â†’ v2.1ï¼‰ï¼šå…¼å®¹ï¼Œå»ºè®®æ›´æ–°
- ä¿®è®¢å·å˜æ›´ï¼ˆv2.1.0 â†’ v2.1.1ï¼‰ï¼šå®Œå…¨å…¼å®¹

## 4. æ›´æ–°é€šçŸ¥

Masterä¼šé€šè¿‡ `protocol_update` æ¶ˆæ¯é€šçŸ¥æ‰€æœ‰Workerã€‚

Workeråº”è¯¥ï¼š
1. æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
2. å¦‚æœä¸å…¼å®¹ï¼Œå‘é€ `protocol_version_mismatch`
3. è¯»å–æ–°åè®®æ–‡æ¡£
4. æ›´æ–°ä»£ç 
```

---

## ğŸ”„ è‡ªåŠ¨é€šçŸ¥çš„å®ç°

**å…³é”®ç‚¹**: åè®®æœ¬èº«**å¯ä»¥**é€šçŸ¥å˜æ›´ï¼

é€šè¿‡åœ¨åè®®ä¸­å®šä¹‰`protocol_update`æ¶ˆæ¯ç±»å‹ï¼Œä½¿å¾—åè®®å˜æ›´æˆä¸ºåè®®çš„ä¸€éƒ¨åˆ†ã€‚

```
é€’å½’å®šä¹‰ï¼š
- åè®®v1.0å®šä¹‰äº†protocol_updateæ¶ˆæ¯
- åè®®v2.0é€šè¿‡protocol_updateé€šçŸ¥å˜æ›´
- åè®®v3.0ä¹Ÿé€šè¿‡protocol_updateé€šçŸ¥å˜æ›´
  â†“
åªè¦Workeræ”¯æŒv1.0çš„protocol_updateï¼Œ
å°±èƒ½çŸ¥é“æ‰€æœ‰åç»­ç‰ˆæœ¬çš„å˜æ›´ï¼
```

è¿™å°±åƒHTTPåè®®çš„å‡çº§æœºåˆ¶ï¼ˆHTTP/1.1 â†’ HTTP/2ï¼‰ã€‚

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜: åè®®å˜æ›´æ€ä¹ˆé€šçŸ¥ï¼Ÿ

**ç­”æ¡ˆ**: 
1. âœ… **åè®®æ–‡æ¡£åŒ–** (PROTOCOL.md)
2. âœ… **ç‰ˆæœ¬ç®¡ç†** (semantic versioning)
3. âœ… **çŠ¶æ€æ–‡ä»¶è®°å½•ç‰ˆæœ¬** (protocol_versionå­—æ®µ)
4. âœ… **Workerå¯åŠ¨æ£€æŸ¥** (check_protocol_version)
5. âœ… **Masterä¸»åŠ¨å¹¿æ’­** (broadcast_protocol_update)
6. âœ… **åè®®è‡ªæè¿°** (protocol_updateæ¶ˆæ¯)

### åè®®æœ¬èº«èƒ½é€šçŸ¥å—ï¼Ÿ

**èƒ½ï¼** é€šè¿‡åœ¨åè®®v1.0ä¸­å®šä¹‰`protocol_update`æ¶ˆæ¯ç±»å‹ï¼Œä½¿å¾—åè®®å…·æœ‰è‡ªæˆ‘å‡çº§èƒ½åŠ›ã€‚

è¿™æ˜¯å…ƒåè®®ï¼ˆmeta-protocolï¼‰çš„è®¾è®¡ï¼š
```
åè®®ä¸ä»…å®šä¹‰äº†å¦‚ä½•é€šä¿¡ï¼Œ
è¿˜å®šä¹‰äº†å¦‚ä½•å‡çº§è‡ªå·±ï¼
```

---

**è®©æˆ‘ä»¬å®ç°å®ƒï¼** ğŸš€
