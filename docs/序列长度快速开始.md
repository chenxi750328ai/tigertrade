# 序列长度快速开始指南

**日期**: 2026-01-23  
**目标**: 快速开始使用长序列训练和预测

---

## 🚀 一、快速开始

### 1.1 运行动态测试（推荐）

```bash
cd /home/cx/tigertrade
python scripts/analysis/sequence_length_tester.py
```

这将自动：
- 测试序列长度从10到500（步长20）
- 自动检测收敛
- 找到最优序列长度
- 生成测试报告和图表

### 1.2 手动设置序列长度

```python
from src.strategies.llm_strategy import LLMTradingStrategy

# 初始化策略
strategy = LLMTradingStrategy()

# 设置序列长度（越长越好，建议200-500）
strategy._seq_length = 200  # 200个时间步（约3.3小时）

# 训练模型（使用长序列）
df = load_training_data()  # 加载你的训练数据
strategy.train_model(df, seq_length=200)

# 预测时提供历史数据
strategy._historical_data = df  # 设置历史数据
prediction = strategy.predict_action(current_data=df.iloc[-1])
```

---

## 📊 二、理论分析总结

### 2.1 最优序列长度

**理论最优**: 120-240个时间步（2-4小时）

**推荐范围**:
- **保守**: 100-200个时间步
- **推荐**: 200-300个时间步
- **激进**: 300-500个时间步（越长越好，直到收敛）

### 2.2 为什么越长越好？

1. **更多历史信息**: 捕捉长期趋势和模式
2. **更好的上下文**: 理解当前价格在历史中的位置
3. **减少噪音**: 长序列可以平滑短期噪音
4. **复杂模式**: 捕捉多时间尺度的复杂模式

### 2.3 收敛检测

动态测试会自动检测收敛：
- **收敛条件**: 连续5次测试，综合评分变化 < 1%
- **最优长度**: 性能不再提升时的序列长度
- **极限测试**: 可以测试到500+，验证是否真的越长越好

---

## 🔧 三、代码修改说明

### 3.1 已完成的修改

✅ **LSTM模型**: 支持可变序列长度输入
✅ **序列数据准备**: `prepare_sequence_features()` 方法
✅ **训练函数**: `train_model(df, seq_length=100)` 支持序列长度参数
✅ **预测函数**: 自动使用历史序列数据（如果提供）

### 3.2 使用方式

#### 方式1: 使用默认序列长度（200）

```python
strategy = LLMTradingStrategy()
# 默认_seq_length = 200
strategy.train_model(df)  # 自动使用200个时间步
```

#### 方式2: 自定义序列长度

```python
strategy = LLMTradingStrategy()
strategy._seq_length = 300  # 设置为300个时间步
strategy.train_model(df, seq_length=300)
```

#### 方式3: 动态测试找到最优长度

```python
from scripts.analysis.sequence_length_tester import SequenceLengthTester

tester = SequenceLengthTester(
    min_length=10,
    max_length=500,
    step=20
)
results, optimal_length = tester.test_sequence_lengths()

# 使用最优长度
strategy._seq_length = optimal_length
strategy.train_model(df, seq_length=optimal_length)
```

---

## 📈 四、预期效果

### 4.1 性能提升预期

| 序列长度 | 当前准确率 | 预期准确率 | 预期收益率 |
|----------|------------|------------|------------|
| 1（当前） | 38.95% | 38.95% | +2.3% |
| 50 | - | 42-45% | +3-4% |
| 100 | - | 45-48% | +4-5% |
| 200 | - | 48-52% | +5-7% |
| 300+ | - | 50-55% | +6-8% |

### 4.2 收敛预期

- **快速收敛**: 可能在100-200之间收敛
- **缓慢收敛**: 可能在200-400之间收敛  
- **持续提升**: 可能到500+才收敛（验证"越长越好"）

---

## ⚠️ 五、注意事项

### 5.1 数据要求

- **最小数据量**: 需要至少 `seq_length + 10` 个数据点
- **数据连续性**: 需要连续的历史数据，避免缺失值
- **数据质量**: 确保特征计算正确

### 5.2 计算资源

- **内存**: 
  - 序列长度200: 约2-4GB
  - 序列长度500: 约5-10GB
- **训练时间**: 
  - 序列长度200: 约2-3倍
  - 序列长度500: 约5-6倍

### 5.3 向后兼容

- 如果不设置序列长度，默认使用单点特征（向后兼容）
- 如果历史数据不足，自动降级到单点特征

---

## 📋 六、下一步

### 6.1 立即执行

1. **运行动态测试**: 
   ```bash
   python scripts/analysis/sequence_length_tester.py
   ```

2. **查看测试结果**: 
   - 查看生成的JSON文件
   - 查看生成的图表
   - 找到最优序列长度

3. **使用最优长度训练**: 
   ```python
   strategy._seq_length = optimal_length
   strategy.train_model(df, seq_length=optimal_length)
   ```

### 6.2 持续优化

1. **极限测试**: 测试500-1000的序列长度
2. **验证假设**: 验证"越长越好"是否成立
3. **性能优化**: 优化长序列的训练和推理速度

---

## 🎯 七、总结

### 7.1 核心要点

1. **理论最优**: 120-240个时间步（2-4小时）
2. **实际最优**: 需要通过动态测试确定
3. **越长越好**: 理论上成立，需要验证收敛点
4. **自动收敛**: 动态测试会自动找到最优长度

### 7.2 实施建议

1. ✅ **立即运行动态测试**（最重要）
2. ✅ **使用长序列训练**（至少100-200个时间步）
3. ✅ **持续优化**（根据测试结果调整）

---

**现在就开始**: 运行 `python scripts/analysis/sequence_length_tester.py` 找到最优序列长度！
