# DEMO 订单执行分析：三手多单无对应止损单

## 现象

- 今日 DEMO 下了 **3 手多单**（买入）
- **没有对应的止损单**
- **只有止盈单**（或仅看到止盈相关逻辑/订单）

## 根因分析

### 1. 当前设计：只提交主单，不提交独立止损/止盈单

| 模块 | 行为 | 是否提交止损单 | 是否提交止盈单 |
|------|------|----------------|----------------|
| **tiger1.place_tiger_order** | 实盘只调用一次 `trade_api.place_order(..., limit_price=price, stop_price=None)` | ❌ 否 | ❌ 否 |
| **tiger1.place_take_profit_order** | 实盘路径中 `_build_tp_order` 为空、`trade_client.place_order(tp_order2)` 被注释 | ❌ 不涉及 | ❌ 实盘未真正提交 |
| **OrderExecutor.execute_buy**（MOE 策略） | 只调用一次 `trade_api.place_order(..., price, None)`，止损/止盈仅用于计算和返回文案 | ❌ 否 | ❌ 否 |

因此：

- **交易所/券商侧**：只会看到 **3 笔买入限价单**，不会看到任何“止损单”或“止盈单”作为独立订单挂出。
- **止损**：完全由 **策略循环** 在内存里判断（每轮检查 `price_current <= stop_loss_price`），满足时再调用 `place_tiger_order('SELL', ...)` 下一笔**市价/限价卖单**。即：**没有预挂的止损单，只有“价格到了再下单”的被动止损**。
- **止盈**：
  - 若走 `place_take_profit_order`：实盘未真正向 API 提交止盈单（代码未实现）。
  - 若走 MOE 的 OrderExecutor：只下主单，不下止盈单。
  - 因此若界面上看到“止盈单”，多半来自：券商对**高于市价的限价卖单**的展示方式、或其它手工/别处下的单，而不是本策略在实盘下挂的独立止盈单。

### 2. 为何“没有止损单”

- 代码里 **从未** 对券商 API 提交过“止损单”（如 Stop 或 Stop-Limit）。
- `place_tiger_order(..., stop_loss_price=...)` 只是把止损价写入 **order_log** 和内部状态，**不会** 再发一笔带 `stop_price` 的订单。
- 实盘 `trade_api.place_order(..., stop_price=None)` 始终为 `None`，所以交易所侧不会有对应止损单。

### 3. 为何“只有止盈单”（从逻辑/日志角度）

- 日志/代码里会 **记录** 止盈价（`take_profit`、`take_profit_price`），并可能调用 `place_take_profit_order`，因此从“业务逻辑”上会看到“有止盈、无止损”的不对称。
- 实盘上 **止盈单也未被真正提交**（见上表），所以若你在券商看到有“止盈单”，需要再确认是否来自本程序、还是其它入口。

## 风险与影响

1. **止损完全依赖程序在线**：若 DEMO 进程挂掉、断网、重启，则没有任何挂在交易所的止损单，仓位暴露在行情中。
2. **止盈单未挂出**：依赖策略循环里 `check_active_take_profits` 等逻辑在合适价格主动卖出，与“预挂止盈单”行为不一致。
3. **三手多单无对应保护**：3 手多单没有 3 笔对应的止损单（也没有真正挂出的止盈单），与“每笔买入配一张止损、一张止盈”的预期不符。

## 建议改动（方向）

1. **实盘为每笔买入提交止损单**
   - 在 `place_tiger_order` 或 OrderExecutor 中，主单成交或挂单成功后，再调用券商 API 提交一笔 **止损单**（如 Stop 或 Stop-Limit，价格=stop_loss_price）。
   - 需确认 Tiger 接口是否支持独立止损单、以及合约/账户是否支持（部分品种仅支持止损止盈单或组合单）。

2. **实盘真正提交止盈单**
   - 在 `place_take_profit_order` 中实现实盘路径：构建“限价卖单（价格=取整后的 take_profit_price）”并调用 `trade_api.place_order`（或等价接口），确保每笔买入可对应一张挂在交易所的止盈单。

3. **保持与主单数量一致**
   - 若 3 手是多笔 1 手买入，则理想情况是：3 笔买入 + 3 笔止损单 + 3 笔止盈单（或 1 笔 3 手止损 + 1 笔 3 手止盈，视接口和风控要求而定）。

4. **日志与监控**
   - 在 order_log / 监控中区分：主单、止损单、止盈单，并记录 order_id 关联，便于核对“三手多单是否有对应止损/止盈”。

## 小结

| 问题 | 根因 | 当前状态 |
|------|------|----------|
| 没有对应的止损单 | 从未向 API 提交止损单，仅策略内被动止损 | 需新增“下单后提交止损单” |
| 只有止盈单（逻辑/日志） | 止盈有记录和调用，但实盘未真正提交止盈单 | 需在 place_take_profit_order 实盘路径中真正下单 |
| 三手多单无保护 | 主单与止损/止盈未成对挂出 | 需按上面 1、2 实现并保证数量一致 |

以上为本次 DEMO 订单执行情况的分析与改进方向；具体实现需结合 Tiger 文档（止损/止盈单类型、参数、限仓规则）再细化。

---

## 后续实现要点（Tiger API 支持）

- Tiger Open API 支持 **止损单**：类型可为 **STP**（止损市价）、**STP_LMT**（止损限价）等，通过 `place_order` 的 `order_type` 与 `stop_price`/`aux_price` 提交。
- **建议实现**：
  1. **place_stop_loss_order(entry_side, quantity, stop_loss_price)**：主单成交或挂单成功后，再调用 API 提交一笔止损单（STP 或 STP_LMT），价格=stop_loss_price，与主单数量一致。
  2. **place_take_profit_order 实盘路径**：在非 mock 时构建限价卖单（价格=取整后的 take_profit_price），调用 `trade_api.place_order` 提交，确保每笔买入对应一张挂在交易所的止盈单。
  3. 在 **place_tiger_order** 或 **OrderExecutor.execute_buy** 中，主单成功后依次调用上述两个函数，使“三手多单”对应“三张止损单 + 三张止盈单”（或按接口支持的组合方式成对挂出）。
