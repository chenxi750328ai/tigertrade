# 为何报告里「后台核对」数据都是空的

本文回答三个问题：**是没有核对还是核对完了没有符合要求的？** **那么多历史数据没有一个符合要求么？** **后台的订单都是哪儿来的？**

---

## 一、后台的订单都是哪儿来的？

**「后台」** = 老虎证券的服务器端。**后台订单** = 在老虎证券服务器上记录的订单。

来源只有两类：

1. **通过老虎 API 提交并被接受的订单**  
   本系统 DEMO（或其它程序）调用 `place_order` 后，老虎接受且成交（或部分成交）的，会在后台有一条记录，并可通过 **get_orders** 拉取到。

2. **人工在老虎 App / Web 下的单**  
   在老虎证券客户端手动下的单，同样会出现在该账户的后台订单里。

因此：**报告里的「后台核对」数据** = 本系统用老虎 API 的 **get_orders** 拉取该 DEMO 账户的订单列表，再根据成交状态、盈亏等解析出的收益率/胜率。  
若脚本**没有**成功调用 get_orders、或拉取为空、或解析未实现/失败，报告里就会显示为空（— 或「需老虎后台数据核对」）。

---

## 二、是没有核对，还是核对完了没有符合要求的？

**主要是「没有用后台数据做核对」**，而不是「核对完了没有符合要求的单」。

原因有两层：

### 1. 生成报告时，多数情况下根本没拉到老虎订单

- 报告由 **`scripts/optimize_algorithm_and_profitability.py`** 生成（本地或 CI/定时任务）。
- 该脚本通过 **api_manager.trade_api.get_orders** 拉订单。但：
  - **单独跑脚本时**（如 cron、CI）：通常没有先启动 tiger1，**api_manager 未用真实 API 初始化**，`trade_api` 为 None 或未连老虎 → 不调用 get_orders，直接得到订单列表为空。
  - **即使用真实 API**：当前 **RealTradeApiAdapter 未实现 get_orders**，只有 Mock 适配器有 get_orders，因此即使用户本机跑，也不会通过 api_manager 拉到真实订单。
- 所以报告生成时，**绝大多数情况下没有从老虎后台拉过订单**，属于「没有核对」，而不是「核对完没有符合的」。

### 2. 即使拉到了订单，解析也一直未实现

- `calculate_profitability(orders)` 里对订单的循环是 **`pass`**，没有根据订单结构解析 `filled_quantity`、`realized_pnl`、`status` 等。
- 因此即便将来传入非空订单，**total_trades / 胜率 / 收益** 仍会是 0，报告里仍会显示「API 历史订单 暂无或未解析」。

结论：**库上报告里后台核对为空 = 没有用老虎后台做有效核对**（没拉到订单 + 订单解析未实现）。  
改进后：在存在 `openapicfg_dem` 时，脚本会直接用老虎 TradeClient 拉订单并解析，报告里才会出现「后台核对」数据。

---

## 三、那么多历史数据没有一个符合要求么？

**历史数据有两类，不要混在一起看：**

| 数据 | 是什么 | 能否用于「后台核对」 |
|------|--------|----------------------|
| **order_log.jsonl** | 本系统每次下单尝试与结果的日志（含 mock、失败、成功） | **不能直接当后台**。只有其中 mode=real、status=success 且 order_id 为**老虎返回的纯数字**的，才可能在老虎后台查到。 |
| **老虎后台订单** | 仅能通过 **get_orders** 拉取到的订单列表 | **能**。报告里的「后台核对」必须来自这里。 |

当前 **order_log_analysis.md** 的结论是：

- mode=real 且 status=success 的约 69 条里，**64 条 order_id 为 Mock、TEST_、ORDER_ 等** → 来自测试/mock，**不是老虎真实成交**，老虎后台本来就没有这些单。
- **只有约 5 条** order_id 为纯数字，才可能是老虎真实单，才可能在后台查到。

所以：

- **不是「历史数据没有一个符合要求」**，而是：  
  - 报告生成时**没有用 get_orders 去拉老虎后台**，所以即使用户本机有可核对的历史，报告里也看不到。  
  - order_log 里大量是测试/mock 产生的「假成功」记录，本来就不会在老虎后台出现；真正可能符合的只有少数几条（如那 5 条）。
- 要让报告里出现「后台核对」结果，需要：  
  1）报告生成时**真的去拉老虎后台**（见上节改进）；  
  2）拉到的订单里要有**已成交（FILLED）** 的；  
  3）解析这些订单的盈亏/笔数并写入报告。

---

## 四、小结

| 问题 | 简短回答 |
|------|----------|
| 报告里后台核对为什么是空的？ | 生成报告时多数情况下**没有**从老虎 API 拉订单（api_manager 未初始化或适配器无 get_orders），且**订单解析未实现**。 |
| 是没有核对还是核对完没有符合的？ | **主要是没有核对**（没拉订单 + 未解析）。 |
| 那么多历史数据没有一个符合吗？ | order_log 里大量是 mock/测试单，只有少数可能是真实单；报告侧是**没去拉后台**，不是「后台没有符合的」。 |
| 后台订单从哪来？ | 老虎服务器上的订单：**API 下单并成交** + **人工在 App/Web 下单**；报告里的后台数据 = 用 **get_orders** 拉取并解析的结果。 |

**后续改进**：在 `optimize_algorithm_and_profitability.py` 中，当存在 `openapicfg_dem` 时，用与 `fetch_tiger_yield_for_demo.py` 相同方式直接调用老虎 TradeClient.get_orders 拉订单，并实现订单解析（成交笔数、realized_pnl、胜率），报告里才会出现非空的「后台核对」数据。
