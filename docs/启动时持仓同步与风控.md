# 启动时持仓同步与风控

**问题**：DEMO/实盘重启后，若**不管账户当前状态**、假定持仓为 0 并重新开始开仓计算，会导致进程内 `current_position` 与后台实际持仓不一致，造成重复开仓、超限、或「有仓无止损止盈」等风控与异常管理问题。

**要求**：实盘/DEMO **启动时须先看当前持仓**，根据持仓决定如何处理，不得每次重启就「清零重算」。

---

## 一、已实现：启动时同步后台持仓

- **入口**：`tiger1.py` 主程序在 `verify_api_connection()` 通过后、任何策略启动前，**统一调用** `sync_positions_from_backend()`。
- **逻辑**：
  1. 若有 `trade_client` 且支持 `get_positions(account)`，则拉取当前持仓；
  2. 按合约（当前交易标的，如 SIL）汇总持仓手数，写入全局 `current_position`，并初始化 `position_entry_times` / `position_entry_prices`（无历史价时暂填 0，由持仓看门狗等逻辑按需处理）；
  3. 若拉取到持仓 > 0：打日志并打印「已从后台同步持仓: N 手；若超过风控上限将拒绝新开仓；请确认止损/止盈单状态」；
  4. 若无法拉取（无 trade_client、无 get_positions、或异常）：**重置为 0** 并打**警告**「若账户实际有仓，进程内与后台将不一致，请先手工处理或确认后再开新仓」。
- **效果**：grid / boll / moe / llm / all 等所有策略启动前都会先同步持仓，不再假定从 0 开始。

---

## 二、与风控的关系

- **风控**：`check_risk_control` 使用 `current_position` 判断是否已达持仓上限；同步后 `current_position` 与后台一致，避免「后台已 10 手、进程认为 0 手又开 3 手」的超限情况。
- **异常管理**：若同步失败则重置为 0 并告警，避免静默不一致；后续可增加「启动时若后台持仓 > 风控上限则拒绝启动或只允许平仓」等策略。

---

## 三、与「后台订单与持仓分析」的衔接

- 例行报告中的 **后台订单与持仓分析**（`docs/reports/backend_positions_analysis.md`）会检测「有持仓但止损/止盈单已撤」；
- 启动时同步持仓后，若发现**有仓**，应结合该分析结论确认是否需要补挂止损/止盈单（参见 [后台订单与持仓分析_有仓无止损止盈_风控改进](后台订单与持仓分析_有仓无止损止盈_风控改进.md)）。

---

## 四、崩溃/重启后：持仓同步与止损止盈（QA-DP2）

DEMO 进程运行中崩溃（如 20h 跑到第 10 小时退出）时：

1. **持仓**：broker 侧持仓仍在；重启后 `sync_positions_from_backend()` 会拉取并写入 `current_position`，与后台一致。
2. **止损/止盈单**：若崩溃前已挂出的 SL/TP 单仍在 broker 侧，重启后**不会自动补挂**；若已随进程退出被撤或过期，则会出现「有仓无止损止盈」。
3. **建议步骤（SOP）**：重启后 (1) 确认启动时已执行同步且日志有「已从后台同步持仓」；(2) 查看老虎后台当前挂单与持仓是否与预期一致；(3) 若有仓无止损止盈，按 [后台订单与持仓分析_有仓无止损止盈_风控改进](后台订单与持仓分析_有仓无止损止盈_风控改进.md) 补挂或平仓。

**检查清单**：同步已执行 → 后台挂单/持仓与预期一致 → 有仓则确认 SL/TP 或补挂。

---

## 五、测试与后续

- **测试**：需补充「启动时同步持仓」的单元/集成测试（mock get_positions 返回有仓/无仓/异常，断言 current_position 与告警行为）。
- **风控与异常管理**：当前风控与异常管理仍有缺口，对应测试也需补齐；本文与 [后台订单与持仓分析_有仓无止损止盈_风控改进](后台订单与持仓分析_有仓无止损止盈_风控改进.md)、[风控_持仓上限回溯](风控_持仓上限回溯.md) 一起作为改进依据。
