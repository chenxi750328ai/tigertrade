# 回测数据集说明

## 一、回测用的数据集是哪儿来的

- **路径**：`data/processed/test.csv`（以及同目录下的 `train.csv`、`val.csv`、`processed_data.csv`）。
- **来源**：
  1. **原始数据**：来自 `/home/cx/trading_data` 下的每日目录（如 `2026-01-26`）中的 `trading_data_*.csv`，或 `trading_data/large_dataset` 下的 `full_*.csv` 等合并结果。
  2. **合并与预处理**：由 **`scripts/merge_recent_data_and_train.py`** 合并近期数据后，调用 **`scripts/data_preprocessing.py`** 的 `TigerTradeDataProcessor` 进行清洗、技术指标、特征与标签、划分 train/val/test，并写入 `data/processed/`。
  3. **回测使用**：网格/BOLL 策略的回测（如 `scripts/parameter_grid_search.py`、`scripts/optimize_algorithm_and_profitability.py` 中的参数优化）读取 **`data/processed/test.csv`** 作为回测用数据（含 `close` 等列）。

因此：**回测数据集 = 经过合并与预处理后的 test 划分**，上游是 trading_data 下的行情/交易数据与 merge_recent_data_and_train + data_preprocessing 的流水线。

## 二、数据源头：都是交易平台 API 获取的么，还是有增强生成？

- **行情与价格数据**：**全部来自交易平台（Tiger）API**，没有用合成数据或“增强生成”新行情。
  - **K 线**：通过 Tiger API 的 `get_future_bars` / `get_kline_data`（或等价接口）拉取，如 `scripts/fetch_more_training_data.py`、`src/tiger1.py` 中的 get_kline_data、数据采集脚本等。
  - **Tick / 逐笔**：通过 Tick 采集器（如 `src/tick_data_collector.py`）从平台获取并落盘到 `trading_data` 下。
  - **trading_data_*.csv**：DEMO 运行时的 `DataCollector`（tiger1）将当前行情与策略中间量写入，其中的价格与时间序列同样来自上述 API 或当次运行获取的行情。
- **预处理在做什么**：**只做特征工程与标签**，不生成新价格序列。
  - `TigerTradeDataProcessor`：清洗（缺失值、异常值）、**技术指标**（RSI、MACD、布林带、均线等）、**自定义特征**、**标签**（如未来收益率等）、划分 train/val/test。所有计算都基于已有 OHLCV 与时间列，**不合成新 K 线、不做了“数据增强”式的新行情生成**。
- **结论**：回测用的数据**源头 = 交易平台 API 获取的 K 线/Tick 等**；预处理 = 清洗 + 特征 + 标签，**没有增强生成新行情**。

## 三、每日更新么

- **是否每日更新**：取决于是否**每日执行**数据合并与预处理。
- **例行中的约定**：在 [例行工作清单](../shared_rag/best_practices/例行工作清单_agent必读.md) 第 5 项「数据刷新和模型训练」中，要求运行 `scripts/merge_recent_data_and_train.py` 或 `scripts/data_preprocessing.py`，产出在 `data/processed/`（含 train/val/test）。**若按例行每日跑上述脚本，则回测用的 test.csv 会每日更新**；若不跑，则沿用上次产出的 test.csv。
- **建议**：若希望回测始终基于最新数据，应每日跑一次 `merge_recent_data_and_train.py`（会合并近期每日数据并调用预处理，更新 train/val/test.csv）。

## 四、回测方法、return_pct 与为何可能只有 1 笔

- **测试方法**：读取 `data/processed/test.csv`（含 close 等），按 K 线逐根检查 RSI/均线 等入场条件与止损/止盈平仓条件（`scripts/parameter_grid_search.backtest_with_params`、`scripts/risk_management.should_close_position`），统计完成笔数、盈利笔数、期末资金。
- **return_pct**：回测资金收益率 (%)，公式 `(期末资金 - 10万) / 10万 × 100`。
- **为何有时只有 1 笔**：在给定 test.csv 与参数组合下，若整个回测区间内只触发**一次**「入场→平仓」完整回合，则 num_trades=1；此时 win_rate 必为 0% 或 100%，无参考意义。与数据长度、参数、入场条件是否苛刻有关。

## 五、相关脚本与路径

| 用途         | 脚本/路径 |
|--------------|-----------|
| 合并近期数据并预处理 | `scripts/merge_recent_data_and_train.py` |
| 仅预处理（指定输入） | `scripts/data_preprocessing.py`（TigerTradeDataProcessor） |
| 回测读取     | `data/processed/test.csv` |
| 网格/BOLL 回测 | `scripts/parameter_grid_search.py`、`scripts/optimize_algorithm_and_profitability.py` |

详见 [每日例行_效果数据说明](每日例行_效果数据说明.md)、[需求分析和Feature测试设计](需求分析和Feature测试设计.md) 附录。
