# 每日例行：训练与优化闭环说明

## 问题（为何回测/实盘效果差、每天在干啥说不清）

1. **每日流程与真实效果脱节**
   - `scripts/daily_data_collection_and_training.py` 名义上做了：收集数据 → 准备数据 → 训练 → **评估** → **优化** → 分析收益率。
   - 实际：**评估** 返回的是写死的 0.0（“暂时返回模拟结果”），**优化** 只追加一条笼统建议，**收益率分析** 也是模拟数据。没有用回测或实盘结果驱动任何决策。

2. **训练与回测/实盘未闭环**
   - 训练脚本（如 `train_transformer.py`、策略内 `train_model`）用历史 CSV 做 loss/accuracy，**没有**用回测收益率或实盘表现做目标或早停。
   - 参数优化（`parameter_grid_search.py`）和报告（`optimize_algorithm_and_profitability.py`）是**另一条链路**，每日流程之前**没有**在例行里调用，导致“例行”不产出真实回测/实盘效果数据。

3. **数据准备接口不一致**
   - 每日流程里写的是 `from scripts.prepare_data import prepare_training_data`，而 `prepare_data.py` 只有 `main()`，没有 `prepare_training_data`，会报错。

## 已做改进（闭环与例行在干啥）

1. **每日流程必跑“真实优化与报告”**
   - 在 `run_daily_workflow()` 中，无论数据收集/训练是否成功，**都会**调用 `optimize_algorithm_and_profitability.run_optimization_workflow()`。
   - 该流程会：拉 API 历史订单（若有）、汇总 DEMO 多日志、对 grid/boll 做**真实回测**（`parameter_grid_search.grid_search_optimal_params`）、生成 `docs/reports/algorithm_optimization_report.*`、更新 `today_yield`、订单执行状态、策略报告。
   - 这样**每天例行**至少产出：回测最优参数与 return_pct/win_rate、DEMO 日志统计、效果数据来源说明；不再是一串 0 和“模拟数据”。

2. **评估与收益率用真实数据**
   - `evaluate_models()` 改为依赖上述优化流程产出的策略表现（DEMO 统计 + 回测指标），或直接复用 `analyze_strategy_performance()` 与回测结果，写入 `results['evaluation']`，不再写死 0。
   - `analyze_profitability()` 改为调用 `optimize_algorithm_and_profitability` 的订单解析与收益率逻辑（或读取其报告），有 API 订单就出真实收益率/胜率，没有就标明“暂无”。

3. **数据准备接口统一**
   - `scripts/prepare_data.py` 增加 `prepare_training_data()`，供每日流程调用；内部调用现有 `main()` 逻辑并返回可用的汇总信息（如记录数、路径），避免 ImportError。

## 后续可做（进一步把效果拉进训练）

- **用回测/实盘指标驱动训练**：例如用 grid/boll 回测的 return_pct 或实盘胜率做早停、或作为强化学习 reward；或定期用最近 N 天回测选出的最优参数更新策略默认参数。
- **统一“效果差”的判定与告警**：在报告中明确“回测 return_pct &lt; X 或实盘胜率 &lt; Y”则标为效果差，并触发建议（如重新训练、缩小参数范围、检查数据与标签）。

## 「两个策略无 num」是啥意思？

报告中 **moe_transformer**、**lstm** 的 **num_trades** 和 **return_pct** 显示为 **—**，即「无 num」。

- **原因**：当前每日优化流程里**只对 grid、boll 做了回测**（`parameter_grid_search` 用 `data/processed/test.csv` 跑网格回测），**没有对 moe_transformer、lstm 跑回测**，所以这两个模型策略没有回测产出的笔数、收益率、胜率。
- **训练**：moe_transformer、lstm 有训练代码（策略内 `train_model`、`scripts/train_transformer.py` 等），但（1）每日流程里的训练入口未接好（如 `train_transformer_model` 缺失），（2）训练产出的是 **准确率/loss**，不是 **回测 num_trades/return_pct**；要得到「有 num」需要在同一套数据上**跑模型回测**（用模型对 test.csv 逐条预测→模拟买卖→统计笔数与收益）。
- **结论**：不是「没训练、没测试」，而是**没有在每日流程里对这两个策略跑回测**，所以报告里回测相关的 num/return_pct 为空。要补齐需新增：对 moe_transformer、lstm 用 test.csv 做一次模型回测，把产出的 num_trades、return_pct、win_rate 写入 `strategy_performance` 与报告。

## 相关文件

| 文件 | 作用 |
| --- | --- |
| `scripts/daily_data_collection_and_training.py` | 每日例行入口；现会调用真实优化与报告。 |
| `scripts/optimize_algorithm_and_profitability.py` | 结果分析 + 回测参数优化 + 报告生成。 |
| `scripts/parameter_grid_search.py` | grid/boll 回测与最优参数搜索。 |
| `scripts/prepare_data.py` | 数据准备；提供 `prepare_training_data()` 供每日调用。 |
| `docs/每日例行_效果数据说明.md` | 效果指标含义与数据来源。 |
| `docs/reports/algorithm_optimization_report.md` | 每次优化产出的报告。 |
