# DEMO 实盘收益率：定义与数据来源（必守）

## 一、定义

**DEMO 实盘收益率** = 仅基于**在老虎证券后台真实成交的订单**所计算出的收益率。  
未在老虎后台成交的（模拟单、下单失败、仅日志统计）**一律不得**作为 DEMO 实盘收益率展示。

- **完成的订单**：指在老虎后台可查到的、已成交（FILLED）的订单。
- **收益率**：基于这些成交订单的盈亏（或账户净值变化）计算；**须用老虎后台获取的数据进行核对**，核对上的才算正确数据。

## 二、为何之前会出现「下单失败却还有收益率」（回溯）

**不是按成功笔数推算的**，而是**误把 DEMO 日志里的一行字当成了实盘收益率**。

1. **当时那个数字怎么来的**
   - 旧版逻辑用正则扫 DEMO 日志，匹配「收益率」+ 数字 + %。DEMO 运行时会打印 **「预测收益率: 6.65%」**（模型/策略的预测值，不是成交结果）。
   - 正则没有区分「预测」和「实际」，把**预测收益率**当成了**今日收益率**写进 today_yield，并在状态页展示。**没有用成功笔数做任何推算**，也没有做验证。

2. **为何执行失败还能看到收益率**
   - 执行失败只影响真实下单是否成交，不影响策略在日志里打印「预测收益率」。所以会出现：订单大量失败，但日志里仍有「预测收益率: 6.65%」→ 被误采 → 页面显示「今日收益率 6.65%」。

3. **实际 vs 推算**
   - **实际收益率**：仅老虎后台可核对；执行失败则无实盘收益。
   - **推算收益率**：若用 order_log 等可追溯数据按固定规则推算、且可复算、可与老虎对账验证，则单独标为「推算收益率」，与实盘收益率**明确区分**。详见 [回溯_执行失败为何出现收益率与推算收益率](回溯_执行失败为何出现收益率与推算收益率.md)。

## 三、以后必须遵守的规则

1. **DEMO 实盘收益率**只允许来自：
   - 从**老虎 API**（openapicfg_dem 对应账户）拉取的订单/成交/账户数据；
   - 基于上述数据计算出的收益率，且**可与老虎后台展示结果核对**。
2. **未与老虎后台核对上的数据**：
   - 不得以「DEMO 实盘收益率」或「今日收益率（实盘）」名义展示为百分比；
   - 若仅能提供「主单 N 笔」「DEMO 日志统计」等，必须明确标注「未核对老虎，非实盘收益率」或「仅日志笔数，非收益率」。
3. **状态页 / 报告**：
   - 今日收益率（DEMO/实盘）由 `docs/today_yield.json` 提供；
   - 该文件应由「从老虎后台拉取并计算」的脚本更新；若拉取失败或无成交，应写「—」或「需老虎后台数据核对」，不得用日志解析的百分比填充。

## 四、实现与脚本

- **从老虎拉取并计算**：`scripts/fetch_tiger_yield_for_demo.py`（拉取 DEMO 账户订单，筛选成交，统计/计算收益率）；`scripts/update_today_yield_for_status.py` 优先使用该结果写入 `today_yield.json`。
- **订单记录导出与核对**：`scripts/export_order_log_and_analyze.py` 导出 `run/order_log.jsonl`，分析 mode=real/mock 与 status；报告见 `docs/reports/order_log_analysis.md`。用于与老虎后台订单对照，**只有 mode=real 且 status=success 的才可能出现在老虎后台**。

## 五、为何日志记录和老虎后台不一致（报告必含说明）

**原因**：本系统日志（`run/order_log.jsonl`、DEMO 运行日志）记录的是**本进程的每次下单尝试与结果**，包括：
- **模拟单（mode=mock）**：未调用老虎 API，不会出现在老虎后台；
- **真实下单但被拒（mode=real, status=fail）**：**发了 API 被拒 = 执行失败**，不会在后台成单；
- **真实下单且成功（mode=real, status=success）**：才会在老虎后台出现。

因此**日志条数、内容与老虎后台不一致是正常现象**：只有「mode=real 且 status=success」的才应在老虎后台查到；其余不应在后台出现。**执行失败（含 API 被拒）必须在状态报告与效果报告中体现**（成功 N 笔、失败 M 笔）；**若多为失败则不应有实盘收益率**，今日收益率仅来自老虎后台成交。  
**所有涉及 DEMO/订单/收益率的报告都必须包含本段说明**，避免读者误以为「日志有记录就等于后台有单」。参见 [order_log_analysis](reports/order_log_analysis.md)、算法优化报告中的「效果数据来源」与「日志与老虎后台差异说明」；状态页见 `docs/order_execution_status.json`（由 `export_order_log_and_analyze.py` 写入）。

## 六、核对规则：DEMO 单在老虎都能查到就算通过

- **老虎后台的数据可能比 DEMO 运行的多**：您可能有人工下单，因此后台订单 ≥ DEMO 自动单是允许的。
- **核对算法**：**DEMO 运行的单在老虎后台数据中都能查到就算通过**。即：从本系统视为「DEMO 运行产生的订单」（如 `order_log.jsonl` 中 mode=real、status=success、source=auto）提取 order_id 列表，用老虎 API 拉取该账户订单，若上述每个 order_id 在老虎返回的订单列表中都能找到，则核对通过；老虎后台多出的人工单不要求与本系统一一对应。
- 实现见脚本 `scripts/verify_demo_orders_against_tiger.py`（拉取老虎订单，逐条核对 DEMO 的 real+success 的 order_id 是否在老虎列表中）。

**为何多天 DEMO 历史与老虎后台对不上**：若 `order_log.jsonl` 里 mode=real、status=success 的 **order_id 多为 Mock、TEST_、ORDER_ 等**，说明这些记录来自**测试或 mock 环境**（跑单测或本地 mock 了 place_order 时，把 mock 返回值当 order_id 写进了同一份 order_log）。这类**不是老虎真实成交**，与老虎对不上是预期。只有 order_id 为**老虎返回的纯数字 ID** 的，才可能在老虎后台查到。订单分析报告（`docs/reports/order_log_analysis.md`）中会区分「疑似测试/mock」与「可能真实单」条数。

## 七、小结

- **DEMO 实盘收益率 = 完成的订单的收益率**，完成的订单 = 老虎后台能查到的成交单。
- **不是笨也不是故意欺骗**：是设计上用了错误数据源（日志/汇总笔数/未区分 mock 与 real），未与老虎后台挂钩。现已修正为：**仅以老虎后台获取的数据核对后的结果为准，核对上的才算正确数据**。
- **日志与老虎不一致**：因日志含模拟单与失败单，只有 real+success 才对应后台；报告里必须带此说明。
- **核对规则**：DEMO 的单在老虎都能查到即通过；老虎可以更多（含人工单）。
