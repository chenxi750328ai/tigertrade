# 项目质量与自测目标

项目负责人按此执行：**自己跑、自己发现问题、自己修**，不等人“踢一脚才干一下”。

## 1. 目标

- **Feature 覆盖率**：真实流程有对应测试，PASS = 真实流程 OK（含后台可见）。
- **代码覆盖率**：核心路径（executor、tiger1 入口、api_adapter、策略/风控）有覆盖，定期看 `--cov-report=term-missing` 补缺口。
- **禁止项**：DEMO 输出中不得出现 1010、account 为空、未捕获 AttributeError/NameError 等。

## 2. 必须覆盖的流程分支（黑盒）

黑盒测试 `tests/test_blackbox_demo.py` 已覆盖，缺一即 FAIL：

| 分支 | 说明 |
|------|------|
| 禁止项 | 1010、account 为空、AttributeError、NameError 等不得出现在 DEMO 输出 |
| 流程证据 | 交易循环已启动 + 至少一种 feature（策略预测/风控 DFX/下单）在输出中有证据 |
| 后台可见性 | 若本轮有 mode=real&status=success 且 order_id 为数字，get_orders(account,symbol) 必须能查到该 order_id |

## 3. 自测流程（例行执行）

```bash
# 1）黑盒（真实入口、真实流程）
pytest tests/test_blackbox_demo.py -m blackbox -v

# 2）Feature + 核心单测（不含 ROS）
pytest tests/test_blackbox_demo.py tests/test_feature_order_execution.py \
  tests/test_feature_buy_silver_comprehensive.py tests/test_feature_order_execution_real_api.py \
  tests/test_feature_risk_management.py tests/test_feature_strategy_prediction.py \
  tests/test_feature_trading_loop.py tests/test_order_executor_comprehensive.py \
  -v --tb=short

# 3）覆盖率（看缺口）
pytest tests/test_blackbox_demo.py tests/test_feature_order_execution.py \
  tests/test_feature_buy_silver_comprehensive.py tests/test_feature_order_execution_real_api.py \
  tests/test_feature_risk_management.py tests/test_feature_strategy_prediction.py \
  tests/test_feature_trading_loop.py tests/test_order_executor_comprehensive.py \
  --cov=src --cov-report=term-missing --cov-fail-under=0 -q
```

- 有 FAIL：先修再提交；real_api 在无配置时可 skip，但黑盒与 feature 单测应稳定通过。
- 覆盖率：优先补 `src/executor`、`src/order_log.py`、`tiger1` 入口与交易循环路径。

**风控硬顶 = 2 手**：`DEMO_MAX_POSITION = 2`，OrderExecutor 与 place_tiger_order 均以「持仓+待成交买单」硬顶 2，超出拒绝。黑盒已改为**类级别只跑一次 DEMO**，四个用例复用同一份输出，避免多进程叠单（单次 run 最多 2 单）。跑完自测后仍建议例行清理：
```bash
cd /home/cx/tigertrade && python scripts/close_demo_positions.py d
```

## 4. 关键文件

- 黑盒：`tests/test_blackbox_demo.py`
- 真实 API 下单/查询：`tests/test_feature_order_execution_real_api.py`（get_order 只传 `id`，不传 `order_id` 避免 1010）
- 根因与修复：`docs/1010_account根因分析与修复.md`、`docs/后台看不到订单_必读_授权配置步骤.md`

## 5. real_api 套件运行约定（QA-T3）

运行频率建议每周至少一次或发布前必跑；责任人：项目 leader。无配置时用例 skip，主 CI 不强制；有配置环境由责任人执行 `pytest -m real_api -v`。

## 6. 谁负责

项目 leader：自测按上述流程跑，发现问题即修，并更新本文档或相关 doc（如新增流程分支时同步更新黑盒与本文档）。
