# 收益率回归实现说明

**完成时间**: 2026-01-23  
**状态**: 已实现收益率回归训练功能

---

## ✅ 一、实现内容

### 1.1 模型架构更新

**TradingLSTM模型**：
- 添加了`predict_profit`参数
- 添加了`profit_head`（收益率预测头）
- 支持同时预测动作、收益率和网格调整系数

```python
class TradingLSTM(nn.Module):
    def __init__(self, ..., predict_profit=False):
        ...
        # 收益率预测头（回归）
        if predict_profit:
            self.profit_head = nn.Sequential(
                nn.Linear(hidden_size, hidden_size // 2),
                nn.ReLU(),
                nn.Dropout(0.2),
                nn.Linear(hidden_size // 2, 1)
            )
```

### 1.2 损失函数更新

**组合损失函数**：
```python
loss = action_loss + 0.5 * profit_loss + 0.1 * grid_loss
```

- **action_loss**: 动作分类损失（CrossEntropyLoss，权重1.0）
- **profit_loss**: 收益率回归损失（HuberLoss，权重0.5）
- **grid_loss**: 网格调整损失（MSELoss，权重0.1）

**Huber损失的优势**：
- 对异常值更鲁棒
- 在收益率预测中，可以处理极端值

### 1.3 数据准备更新

**标签生成**：
```python
# 计算实际收益率
buy_profit = (max(future_prices) - current_price) / current_price
sell_profit = (current_price - min(future_prices)) / current_price
actual_profit = max(buy_profit, sell_profit)  # 作为回归目标
y_profit.append(actual_profit)
```

### 1.4 训练流程更新

**数据加载**：
- 支持同时加载动作标签、收益率标签和网格调整标签
- 自动处理不同组合的数据集

**损失计算**：
- 如果启用收益率预测，计算收益率损失
- 收益率损失权重0.5（比网格调整更重要）

---

## 🎯 二、使用方法

### 2.1 启用收益率回归训练

```python
from src.strategies.llm_strategy import LLMTradingStrategy

# 创建策略，启用收益率预测
strategy = LLMTradingStrategy(
    mode='hybrid',
    predict_profit=True  # 启用收益率预测
)

# 训练模型
strategy.train_model(
    df,
    seq_length=10,
    max_epochs=50,
    patience=10,
    train_grid_adjustment=True
)
```

### 2.2 预测结果

```python
# 预测动作和收益率
result = strategy.predict_action(current_data)

if len(result) == 4:
    action, confidence, grid_adjustment, predicted_profit = result
    print(f"动作: {action}, 置信度: {confidence:.3f}")
    print(f"预测收益率: {predicted_profit:.4f}")
    print(f"网格调整: {grid_adjustment:.3f}")
else:
    action, confidence, grid_adjustment = result
```

---

## 📊 三、优势

### 3.1 直接优化收益目标

**之前**：
- 损失函数优化动作分类准确率
- 准确率高 ≠ 收益高

**现在**：
- 损失函数直接优化收益率
- 模型学习的是"如何获得更高收益"

### 3.2 更灵活的决策

**之前**：
- 只能预测动作（买入/卖出/不操作）
- 无法知道收益大小

**现在**：
- 可以预测收益率
- 可以根据收益率大小调整仓位
- 可以设置动态阈值

### 3.3 更好的训练信号

**之前**：
- 标签是离散的（0, 1, 2）
- 信息量有限

**现在**：
- 标签是连续的（收益率）
- 包含更多信息
- 训练信号更强

---

## 🔧 四、技术细节

### 4.1 损失函数选择

**为什么使用Huber损失**：
- 收益率可能有极端值（异常值）
- Huber损失对异常值更鲁棒
- 在正常范围内，行为类似MSE
- 在异常范围内，行为类似MAE

### 4.2 权重设置

**收益率损失权重0.5**：
- 比网格调整更重要（0.1）
- 但不会完全主导训练（动作损失权重1.0）
- 平衡动作预测和收益预测

### 4.3 数据准备

**收益率标签计算**：
```python
# 买入收益：未来最高价 - 当前价格
buy_profit = (max(future_prices) - current_price) / current_price

# 卖出收益：当前价格 - 未来最低价
sell_profit = (current_price - min(future_prices)) / current_price

# 实际收益率：取最大值
actual_profit = max(buy_profit, sell_profit)
```

---

## ✅ 五、总结

### 5.1 已完成

1. ✅ 模型架构更新（添加收益率预测头）
2. ✅ 损失函数更新（组合损失：动作+收益率+网格）
3. ✅ 数据准备更新（生成收益率标签）
4. ✅ 训练流程更新（支持收益率回归训练）
5. ✅ 预测接口更新（返回收益率）

### 5.2 核心改进

- **直接优化收益目标**：损失函数直接优化收益率
- **更灵活的决策**：可以预测收益率，根据收益大小调整策略
- **更好的训练信号**：连续标签包含更多信息

### 5.3 下一步

1. 测试收益率回归训练效果
2. 对比分类方法和回归方法的性能
3. 根据结果调整权重和参数

---

**状态**: 收益率回归功能已实现，可以开始测试
