# TigerTrade 项目模块化设计 - 并行开发方案

**目标**: 将项目拆解成正交（独立）模块，支持多Agent并行开发

---

## 🏗️ 模块架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    监控和可视化层                              │
│         (Module 8: Monitoring & Visualization)              │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│                      应用层                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Module 5:   │  │  Module 6:   │  │  Module 7:   │    │
│  │  策略引擎    │  │  回测引擎    │  │  风险控制    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│                      AI层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Module 3:   │  │  Module 4:   │  │  Module 9:   │    │
│  │  模型训练    │  │  特征发现    │  │  RAG知识库   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                   │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │  Module 1:   │  │  Module 2:   │                        │
│  │  数据采集    │  │  数据处理    │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 模块详细拆解

### Module 1: 数据采集层 (Data Collection)

**负责**: Agent-Data

**功能**:
- Tick数据持续采集
- K线数据获取（多周期）
- 数据存储和管理
- Tiger API封装

**接口输出**:
```python
# 标准数据格式
{
    'datetime': pd.Timestamp,
    'open': float,
    'high': float,
    'low': float,
    'close': float,
    'volume': int
}
```

**文件**:
- `src/data_collector/tick_collector.py`
- `src/data_collector/kline_fetcher.py`
- `src/data_collector/tiger_api_wrapper.py`
- `src/data_collector/data_storage.py`

**依赖**:
- Tiger Open API
- 本地文件系统

**输出目录**:
- `/home/cx/trading_data/ticks/`
- `/home/cx/trading_data/klines/`

**独立性**: ✅ 完全独立，其他模块只读取其输出的CSV文件

---

### Module 2: 数据处理层 (Data Processing)

**负责**: Agent-DataProc

**功能**:
- 数据清洗（异常值、缺失值）
- 数据标准化/归一化
- 时间序列对齐
- 数据增强（镜像、噪声）
- 训练/验证/测试集划分

**接口输入**:
```python
# 从Module 1读取
raw_data = pd.read_csv('/home/cx/trading_data/ticks/*.csv')
```

**接口输出**:
```python
# 标准化数据
{
    'train.csv': 训练集,
    'val.csv': 验证集,
    'test.csv': 测试集
}
```

**文件**:
- `src/data_processor/cleaner.py`
- `src/data_processor/normalizer.py`
- `src/data_processor/augmenter.py`
- `src/data_processor/splitter.py`

**依赖**:
- Module 1的输出

**输出目录**:
- `/home/cx/trading_data/processed/`

**独立性**: ✅ 只依赖Module 1的CSV输出，不依赖其他模块

---

### Module 3: 模型训练层 (Model Training)

**负责**: Agent-Model

**功能**:
- Transformer模型训练
- LSTM模型训练
- 其他深度学习模型
- 超参数调优
- 模型版本管理

**接口输入**:
```python
# 从Module 2读取
train_data = pd.read_csv('/home/cx/trading_data/processed/train.csv')
val_data = pd.read_csv('/home/cx/trading_data/processed/val.csv')
```

**接口输出**:
```python
# 训练好的模型
model_checkpoint = {
    'model_state_dict': ...,
    'config': {...},
    'metrics': {
        'val_acc': 0.XX,
        'val_loss': 0.XX
    }
}

# 保存路径
'/home/cx/tigertrade/models/transformer_v1.pth'
```

**文件**:
- `src/models/transformer.py`
- `src/models/lstm.py`
- `src/models/trainer.py`
- `src/models/hyperparameter_tuner.py`

**依赖**:
- Module 2的输出

**输出目录**:
- `/home/cx/tigertrade/models/`
- `/home/cx/tigertrade/results/training_logs/`

**独立性**: ✅ 只依赖Module 2的CSV，与策略、回测完全解耦

---

### Module 4: 特征发现层 (Feature Discovery)

**负责**: Agent-Feature

**功能**:
- 注意力权重分析
- 隐藏层表示提取
- 特征重要性计算
- 自定义指标生成
- 可解释性分析

**接口输入**:
```python
# 加载训练好的模型
model = torch.load('/home/cx/tigertrade/models/transformer_v1.pth')
data = pd.read_csv('/home/cx/trading_data/processed/val.csv')
```

**接口输出**:
```python
# 发现的特征
{
    'custom_indicators': {
        'PMS': price_momentum_strength,
        'VAI': volume_anomaly_index,
        ...
    },
    'feature_importance': {
        'price_change_pct': 0.35,
        'volume_change': 0.28,
        ...
    },
    'market_regimes': ['uptrend', 'downtrend', 'sideways']
}
```

**文件**:
- `src/feature_discovery/attention_analyzer.py`
- `src/feature_discovery/hidden_layer_extractor.py`
- `src/feature_discovery/importance_calculator.py`
- `src/feature_discovery/indicator_generator.py`

**依赖**:
- Module 3的输出（训练好的模型）
- Module 2的输出（数据）

**输出目录**:
- `/home/cx/tigertrade/results/feature_analysis/`

**独立性**: ✅ 只依赖已训练模型和数据，不影响其他模块

---

### Module 5: 策略引擎 (Strategy Engine)

**负责**: Agent-Strategy

**功能**:
- 交易策略实现
- 信号生成逻辑
- 多策略组合
- 参数优化

**接口输入**:
```python
# 实时数据 + 模型预测 + 自定义指标
current_data = get_latest_kline()
model_signal = model.predict(current_data)
custom_features = feature_discovery.extract(current_data)
```

**接口输出**:
```python
# 交易信号
{
    'action': 'BUY' | 'SELL' | 'HOLD',
    'confidence': 0.85,
    'position_size': 0.2,  # 20%仓位
    'stop_loss': 93.50,
    'take_profit': 96.00,
    'reason': '模型信号强+趋势确认'
}
```

**文件**:
- `src/strategies/transformer_strategy.py`
- `src/strategies/user_style_strategy.py`
- `src/strategies/ensemble_strategy.py`
- `src/strategies/signal_generator.py`

**依赖**:
- Module 3（模型）
- Module 4（特征）
- Module 1（实时数据）

**输出目录**:
- `/home/cx/tigertrade/strategies/`

**独立性**: ⚠️ 依赖较多，但接口清晰，可独立开发和测试

---

### Module 6: 回测引擎 (Backtest Engine)

**负责**: Agent-Backtest

**功能**:
- 历史回测
- 性能指标计算
- 参数敏感性分析
- Walk-forward测试

**接口输入**:
```python
# 策略 + 历史数据
strategy = TransformerStrategy()
historical_data = pd.read_csv('/home/cx/trading_data/processed/test.csv')
```

**接口输出**:
```python
# 回测结果
{
    'total_return': 0.23,  # 23%
    'sharpe_ratio': 2.1,
    'max_drawdown': 0.08,
    'win_rate': 0.62,
    'profit_loss_ratio': 2.3,
    'total_trades': 150,
    'equity_curve': [...],
    'trade_log': pd.DataFrame(...)
}
```

**文件**:
- `src/backtest/engine.py`
- `src/backtest/metrics.py`
- `src/backtest/visualizer.py`
- `src/backtest/walk_forward.py`

**依赖**:
- Module 5（策略）
- Module 2（历史数据）

**输出目录**:
- `/home/cx/tigertrade/results/backtest_reports/`

**独立性**: ✅ 清晰的输入输出，可独立并行开发

---

### Module 7: 风险控制 (Risk Management)

**负责**: Agent-Risk

**功能**:
- 止损机制
- 仓位管理（凯利公式）
- 风险监控
- 紧急平仓

**接口输入**:
```python
# 当前持仓 + 账户状态
portfolio = get_current_portfolio()
account = get_account_info()
```

**接口输出**:
```python
# 风险控制决策
{
    'allow_trade': True/False,
    'max_position_size': 0.15,
    'stop_loss_price': 93.20,
    'alerts': ['⚠️ 回撤接近8%'],
    'action_required': 'REDUCE_POSITION'
}
```

**文件**:
- `src/risk/stop_loss.py`
- `src/risk/position_sizer.py`
- `src/risk/monitor.py`
- `src/risk/emergency.py`

**依赖**:
- 账户数据（外部）
- Module 5（策略信号）

**输出目录**:
- `/home/cx/tigertrade/logs/risk/`

**独立性**: ✅ 独立的风险规则，可并行开发

---

### Module 8: 监控和可视化 (Monitoring & Visualization)

**负责**: Agent-Monitor

**功能**:
- 实时监控仪表盘
- 性能可视化
- 告警系统
- 日志管理

**接口输入**:
```python
# 从各模块读取状态
data_status = check_data_collector_status()
model_metrics = read_training_logs()
strategy_performance = read_backtest_results()
risk_alerts = read_risk_monitor()
```

**接口输出**:
- Web仪表盘（可选）
- 实时图表
- 告警通知

**文件**:
- `src/monitor/dashboard.py`
- `src/monitor/visualizer.py`
- `src/monitor/alerter.py`
- `src/monitor/logger.py`

**依赖**:
- 所有模块的输出

**输出目录**:
- `/home/cx/tigertrade/logs/`
- `/home/cx/tigertrade/visualizations/`

**独立性**: ✅ 只读其他模块输出，不影响核心逻辑

---

### Module 9: RAG知识库 (Knowledge Base)

**负责**: Agent-Knowledge

**功能**:
- 文档管理
- 经验教训记录
- 知识检索
- Agent协作支持

**接口输入**:
```python
# 各模块的发现和经验
lesson_learned = {
    'module': 'data_collector',
    'lesson': 'Tiger API限制...',
    'solution': '持续采集...'
}
```

**接口输出**:
```python
# 知识检索
results = rag.search('如何配置Tiger API')
```

**文件**:
- 已存在：`/home/cx/rag_system/`

**依赖**:
- 无（独立服务）

**输出**:
- RAG API (http://localhost:8000)

**独立性**: ✅ 完全独立的服务

---

## 🔗 模块依赖关系

```
Module 1 (Data Collection)
    ↓
Module 2 (Data Processing)
    ↓
Module 3 (Model Training)  →  Module 4 (Feature Discovery)
    ↓                              ↓
Module 5 (Strategy Engine) ← ─ ─ ─ ┘
    ↓
Module 6 (Backtest Engine)
    ↓
Module 7 (Risk Management)
    ↓
Module 8 (Monitoring)

Module 9 (RAG) - 独立，支持所有模块
```

---

## 🚀 并行开发方案

### 第一阶段：基础设施（可并行）

**Agent-Data** (Module 1):
- [ ] 完善Tick采集器
- [ ] 实现多周期K线获取
- [ ] 数据存储优化

**Agent-DataProc** (Module 2):
- [ ] 数据清洗pipeline
- [ ] 标准化/归一化
- [ ] 数据增强

**Agent-Knowledge** (Module 9):
- [ ] RAG系统维护
- [ ] 文档补充
- [ ] 知识整理

**预计时间**: 2-3天

### 第二阶段：核心AI（可并行）

**Agent-Model** (Module 3):
- [ ] 完成Transformer训练
- [ ] 尝试LSTM/其他模型
- [ ] 超参数调优

**Agent-Feature** (Module 4):
- [ ] 等待模型训练完成
- [ ] 注意力分析
- [ ] 特征发现

**Agent-Risk** (Module 7):
- [ ] 实现止损机制
- [ ] 仓位管理算法
- [ ] 风险监控

**预计时间**: 3-5天

### 第三阶段：策略和回测（可并行）

**Agent-Strategy** (Module 5):
- [ ] 基于模型的策略
- [ ] 用户风格策略
- [ ] 多策略组合

**Agent-Backtest** (Module 6):
- [ ] 回测引擎
- [ ] 性能指标
- [ ] 报告生成

**Agent-Monitor** (Module 8):
- [ ] 监控仪表盘
- [ ] 可视化
- [ ] 告警系统

**预计时间**: 3-5天

---

## 📋 Agent任务分配建议

### 推荐配置（3-4个Agent）

#### 配置A：3个Agent
```
Agent 1: Data + DataProc + Knowledge
  → 数据全栈

Agent 2: Model + Feature
  → AI核心

Agent 3: Strategy + Backtest + Risk + Monitor
  → 应用层
```

#### 配置B：4个Agent
```
Agent 1: Data + DataProc
  → 数据工程

Agent 2: Model + Feature
  → AI研究

Agent 3: Strategy + Backtest
  → 策略开发

Agent 4: Risk + Monitor + Knowledge
  → 运维支持
```

#### 配置C：6个Agent（充足资源）
```
每个Agent负责1-2个模块，完全并行
```

---

## 🔧 接口规范

### 数据接口
```python
# 标准数据格式（CSV）
columns = ['datetime', 'open', 'high', 'low', 'close', 'volume']
dtype = {
    'datetime': 'datetime64[ns]',
    'open': 'float64',
    'high': 'float64',
    'low': 'float64',
    'close': 'float64',
    'volume': 'int64'
}
```

### 模型接口
```python
class TradingModel:
    def predict(self, sequence):
        """预测
        Args:
            sequence: (seq_len, num_features)
        Returns:
            action: 0/1/2 (卖出/持有/买入)
            confidence: 0-1
        """
        pass
```

### 策略接口
```python
class TradingStrategy:
    def generate_signal(self, data, model_prediction=None):
        """生成信号
        Args:
            data: 最新市场数据
            model_prediction: 模型预测（可选）
        Returns:
            {
                'action': 'BUY'|'SELL'|'HOLD',
                'position_size': float,
                'stop_loss': float,
                'take_profit': float
            }
        """
        pass
```

---

## 📊 进度追踪

### Module完成度矩阵
```
Module                  负责Agent          状态      完成度
────────────────────────────────────────────────────────
1. Data Collection      Agent-Data        ✅ 已完成  90%
2. Data Processing      Agent-DataProc    📋 待开始   0%
3. Model Training       Agent-Model       ⏳ 进行中  30%
4. Feature Discovery    Agent-Feature     📋 待开始   0%
5. Strategy Engine      Agent-Strategy    📋 待开始   0%
6. Backtest Engine      Agent-Backtest    📋 待开始   0%
7. Risk Management      Agent-Risk        📋 待开始   0%
8. Monitoring           Agent-Monitor     📋 待开始   0%
9. RAG Knowledge        Agent-Knowledge   ✅ 已完成  95%
```

---

## 🎯 关键里程碑

### Milestone 1: 数据就绪（已完成 ✅）
- Module 1: Tick采集器运行
- Module 2: 数据预处理完成
- Module 9: RAG系统上线

### Milestone 2: 模型训练完成（进行中 ⏳）
- Module 3: Transformer训练完成
- Module 4: 特征发现完成

### Milestone 3: 策略回测验证（目标：回测盈利>15%）
- Module 5: 策略实现
- Module 6: 回测完成
- Module 7: 风险控制集成

### Milestone 4: 实盘准备
- Module 8: 监控系统上线
- 所有模块集成测试
- 小资金实盘

---

## 💡 协作建议

### 1. 明确接口优先
- 先定义各模块的输入输出格式
- 约定数据存储位置和命名规范
- 使用文档和类型注解

### 2. 定期同步
- 每日stand-up（5-10分钟）
- 更新进度到RAG
- 及时沟通接口变更

### 3. 版本控制
- 使用Git分支（feature/module-name）
- PR review
- 集成测试

### 4. 文档先行
- 每个模块有README
- API文档自动生成
- 经验教训记录到RAG

---

**✅ 项目已具备并行开发条件，模块划分清晰，接口定义明确！**
