# 优化方案设计

**设计时间**: 2026-01-23  
**目标**: 统一训练和运行流程，改进网格参数方案，明确准确率指标

---

## 🎯 一、核心目标

1. **统一训练和运行流程** - 确保一致性
2. **网格参数方案** - 计算+预测混合（规则计算基础值，模型预测调整系数）
3. **准确率指标** - 使用实际收益而不是动作匹配
4. **数据格式统一** - 训练和运行使用相同的数据格式

---

## 🔧 二、网格参数方案设计

### 2.1 方案：计算+预测混合

**设计思路**:
- **规则计算基础值**: 使用时段自适应策略计算基础网格参数（grid_step_base, grid_upper_base, grid_lower_base）
- **模型预测调整系数**: 模型预测调整系数（adjustment_factor），范围 [0.8, 1.2]
- **最终网格参数**: `grid_step = grid_step_base * adjustment_factor`

**优点**:
- 保持规则计算的稳定性（避免极端值）
- 模型可以学习最优调整系数
- 易于解释和调试

### 2.2 模型架构修改

**当前架构**:
```
输入: 12维特征
输出: 3个动作（0=不操作, 1=买入, 2=卖出）
```

**新架构**:
```
输入: 12维特征 + 基础网格参数（grid_step_base, grid_upper_base, grid_lower_base）
输出: 
  - 3个动作（0=不操作, 1=买入, 2=卖出）
  - 网格调整系数（adjustment_factor，范围 [0.8, 1.2]）
```

**模型输出层**:
```python
# 动作预测（3类分类）
action_head = nn.Linear(hidden_size, 3)

# 网格调整系数（回归，范围 [0.8, 1.2]）
grid_adjustment_head = nn.Linear(hidden_size, 1)
grid_adjustment = torch.sigmoid(grid_adjustment_head) * 0.4 + 0.8  # [0.8, 1.2]
```

---

## 📊 三、准确率指标改进

### 3.1 当前准确率定义

**问题**:
- 准确率 = 预测动作 == 标签
- 标签基于未来价格计算，不考虑网格参数
- 高准确率（99.42%）但低收益（2.3%）

### 3.2 新准确率定义

**方案1: 实际收益准确率**
```python
# 计算实际收益（考虑网格参数、滑点、手续费）
actual_profit = calculate_actual_profit(
    action, current_price, future_prices, 
    grid_params, slippage, fees
)

# 计算预期收益（基于标签）
expected_profit = calculate_expected_profit(
    label, current_price, future_prices, 
    grid_params, slippage, fees
)

# 准确率 = 实际收益 / 预期收益（如果预期收益 > 0）
if expected_profit > 0:
    accuracy = min(actual_profit / expected_profit, 1.0)
else:
    accuracy = 0.0
```

**方案2: 收益排名准确率**
```python
# 计算所有动作的收益
profits = {
    0: calculate_profit(0, ...),  # 不操作收益
    1: calculate_profit(1, ...),  # 买入收益
    2: calculate_profit(2, ...)   # 卖出收益
}

# 找到最优动作
best_action = max(profits, key=profits.get)

# 准确率 = 预测动作是否是最优动作
accuracy = 1.0 if predicted_action == best_action else 0.0
```

**方案3: 收益加权准确率**
```python
# 计算所有动作的收益
profits = calculate_all_action_profits(...)

# 准确率 = 预测动作的收益 / 最优动作的收益
best_profit = max(profits.values())
predicted_profit = profits[predicted_action]
accuracy = predicted_profit / best_profit if best_profit > 0 else 0.0
```

**推荐**: 使用方案3（收益加权准确率），因为它考虑了收益大小，而不仅仅是动作匹配。

---

## 🔄 四、训练和运行流程统一

### 4.1 数据格式统一

**当前问题**:
- 训练时: pandas Series (`df.iloc[i]`)
- 运行时: 字典 (`current_data`)

**解决方案**:
- 统一使用字典格式
- `prepare_features()` 函数同时支持 Series 和字典

### 4.2 特征提取统一

**当前问题**:
- 训练时和运行时使用的特征不完全一致
- 训练时没有 `grid_lower` 和 `grid_upper`，但运行时有

**解决方案**:
- 统一特征列表
- 训练时也包含网格参数（从训练数据中获取或计算）

### 4.3 网格参数统一

**当前问题**:
- 训练时: 网格参数来自训练数据（可能是规则计算的）
- 运行时: 网格参数通过 `adjust_grid_interval()` 规则计算

**解决方案**:
- 训练时: 使用规则计算网格参数（与运行时一致）
- 运行时: 使用规则计算基础值，模型预测调整系数

---

## 📝 五、实施步骤

### 5.1 第一步：统一数据格式和特征提取

1. 修改 `prepare_features()` 函数，同时支持 Series 和字典
2. 统一特征列表（确保训练和运行使用相同的特征）
3. 验证训练和运行的特征提取一致性

### 5.2 第二步：修改模型架构

1. 添加网格调整系数输出头
2. 修改损失函数（动作分类损失 + 网格调整回归损失）
3. 修改训练逻辑，包含网格调整系数的标签

### 5.3 第三步：改进准确率计算

1. 实现实际收益计算函数
2. 修改准确率计算逻辑（使用收益加权准确率）
3. 在训练和验证时都使用新的准确率指标

### 5.4 第四步：统一网格参数处理

1. 训练时使用规则计算网格参数（与运行时一致）
2. 运行时使用规则计算基础值，模型预测调整系数
3. 验证训练和运行的网格参数计算一致性

---

## ✅ 六、预期效果

### 6.1 一致性改进

- ✅ 训练和运行使用相同的数据格式
- ✅ 训练和运行使用相同的特征提取逻辑
- ✅ 训练和运行使用相同的网格参数计算方式

### 6.2 网格参数优化

- ✅ 模型可以学习最优网格调整系数
- ✅ 保持规则计算的稳定性
- ✅ 网格参数更适应市场变化

### 6.3 准确率改进

- ✅ 准确率指标更贴近实际收益
- ✅ 高准确率对应高收益
- ✅ 更容易评估模型性能

---

**状态**: 设计方案已完成，准备实施
