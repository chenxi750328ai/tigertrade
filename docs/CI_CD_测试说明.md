# CI/CD回归测试说明

## 问题背景

在重构`run_moe_demo.py`时，遗漏了实际下单逻辑，导致策略只预测不下单。这暴露了项目管理中的问题：
1. **缺少回归测试**：改动后没有自动验证核心功能
2. **测试覆盖不足**：没有针对DEMO脚本的集成测试
3. **CI/CD缺失**：没有自动化测试流程

## 解决方案

### 1. 集成测试 (`tests/test_run_moe_demo_integration.py`)

创建了专门的集成测试文件，覆盖以下场景：

- ✅ **测试1**: 确保`run_moe_demo.py`包含实际下单逻辑
  - 检查`place_tiger_order`调用（非注释）
  - 检查风控检查逻辑
  - 检查买入/卖出执行逻辑
  - 检查订单提交确认

- ✅ **测试2**: 策略接口正确性
  - `predict_action`返回格式验证
  - 返回值类型和范围检查

- ✅ **测试3**: 风控检查集成
  - 下单前风控验证
  - 止损价格计算

- ✅ **测试4**: 完整下单流程
  - 置信度阈值检查
  - 风控检查
  - 止损止盈计算
  - 订单提交

- ✅ **测试5**: 卖出持仓检查
  - 无持仓时不应卖出
  - 持仓检查逻辑验证

- ✅ **测试6**: 置信度阈值逻辑
  - 不同置信度值的执行判断

- ✅ **测试7**: 错误处理
  - 无效价格/方向处理

- ✅ **测试8**: 导入检查
  - 确保所有必要的模块和函数已导入

### 2. CI/CD配置 (`.github/workflows/ci_regression_test.yml`)

GitHub Actions工作流，在以下情况自动运行：

**触发条件**：
- Push到`main`/`develop`分支
- Pull Request到`main`/`develop`分支
- 修改以下文件时：
  - `scripts/run_moe_demo.py`
  - `src/tiger1.py`
  - `src/strategies/**`
  - `tests/**`

**测试步骤**：
1. 基础功能测试 (`test_place_tiger_order.py`)
2. 集成测试 (`test_run_moe_demo_integration.py`)
3. 下单逻辑静态检查（确保代码非注释）
4. 完整测试套件

### 3. Makefile快捷命令

```bash
# 运行所有测试
make test

# 运行集成测试
make test-integration

# 运行回归测试（推荐在提交前运行）
make test-regression

# CI检查
make ci-check

# 快速检查（不运行完整测试）
make quick-check
```

## 使用方法

### 本地运行回归测试

```bash
cd /home/cx/tigertrade
make test-regression
```

### 提交前检查

```bash
make quick-check  # 快速静态检查
make test-integration  # 完整集成测试
```

### CI自动运行

推送到GitHub后，CI会自动运行测试。如果测试失败，PR会被阻止合并。

## 测试覆盖的关键功能

1. **下单逻辑存在性**：确保代码中实际调用了下单函数
2. **风控检查**：确保下单前进行了风险控制
3. **持仓检查**：确保卖出前检查了持仓
4. **错误处理**：确保异常情况被正确处理
5. **接口一致性**：确保策略接口符合规范

## 未来改进

1. **增加更多场景测试**：
   - 模拟API调用失败
   - 模拟网络超时
   - 模拟账户余额不足

2. **性能测试**：
   - 大量订单处理性能
   - 并发下单测试

3. **端到端测试**：
   - 完整的DEMO运行流程
   - 真实API集成测试（使用Mock）

4. **代码覆盖率**：
   - 使用`pytest-cov`生成覆盖率报告
   - 目标：核心功能100%覆盖

## 教训总结

1. **改动后必须运行回归测试**
2. **核心功能必须有集成测试**
3. **CI/CD是质量保障的基础**
4. **代码审查时检查测试覆盖**
