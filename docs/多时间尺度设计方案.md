# 多时间尺度设计方案

**更新时间**: 2026-01-23

---

## 📊 一、需求分析

### 1.1 问题

**当前限制**:
- 只使用1分钟K线数据
- 60分钟无法判断日线趋势
- 缺乏长期趋势信息

**需求**:
- ✅ 增加小时级别K线数据
- ✅ 增加日线级别K线数据
- ✅ 不同分辨率的数据可以混合使用

### 1.2 多时间尺度的优势

**不同时间尺度的作用**:
- **1分钟**: 微观结构、Tick级别、短期波动
- **5分钟**: 短期趋势、技术指标
- **1小时**: 中期趋势、日内模式
- **日线**: 长期趋势、主要方向

**组合使用**:
- 日线确定大方向（上涨/下跌/横盘）
- 小时线确定中期趋势
- 5分钟线确定入场时机
- 1分钟线精确入场

---

## 🔧 二、设计方案

### 2.1 数据获取

**多时间尺度K线数据**:
```python
# 获取不同时间尺度的K线数据
df_1m = get_kline_data('SIL2603', '1min', count=days * 1440)   # 1分钟
df_5m = get_kline_data('SIL2603', '5min', count=days * 288)    # 5分钟
df_1h = get_kline_data('SIL2603', '1h', count=days * 24)       # 1小时
df_1d = get_kline_data('SIL2603', '1d', count=days)            # 日线
```

**数据对齐**:
- 对于每个1分钟K线时间点，找到对应的小时线和日线数据
- 使用时间对齐（向下取整到小时/日）

### 2.2 特征设计

**多时间尺度特征（扩展后的特征维度）**:

**基础特征（1分钟）**:
1. `price_current` - 1分钟K线价格
2. `tick_price` - 真实Tick价格
3. `tick_price_change` - Tick价格变化
4. `tick_volatility` - Tick波动率
5. `tick_volume` - Tick成交量
6. `tick_count` - Tick数量
7. `tick_buy_sell_ratio` - Tick买卖比例
8. `atr_1m` - 1分钟ATR
9. `rsi_1m` - 1分钟RSI
10. `boll_upper_1m` - 1分钟布林带上轨
11. `boll_mid_1m` - 1分钟布林带中轨
12. `boll_lower_1m` - 1分钟布林带下轨
13. `boll_position_1m` - 1分钟布林带位置
14. `volatility_1m` - 1分钟波动率
15. `volume_1m` - 1分钟成交量

**5分钟特征**:
16. `price_5m` - 5分钟K线价格
17. `rsi_5m` - 5分钟RSI
18. `atr_5m` - 5分钟ATR
19. `boll_upper_5m` - 5分钟布林带上轨
20. `boll_mid_5m` - 5分钟布林带中轨
21. `boll_lower_5m` - 5分钟布林带下轨
22. `boll_position_5m` - 5分钟布林带位置
23. `volume_5m` - 5分钟成交量

**1小时特征**:
24. `price_1h` - 1小时K线价格
25. `rsi_1h` - 1小时RSI
26. `atr_1h` - 1小时ATR
27. `boll_upper_1h` - 1小时布林带上轨
28. `boll_mid_1h` - 1小时布林带中轨
29. `boll_lower_1h` - 1小时布林带下轨
30. `boll_position_1h` - 1小时布林带位置
31. `volume_1h` - 1小时成交量
32. `trend_1h` - 1小时趋势（上涨/下跌/横盘）

**日线特征**:
33. `price_1d` - 日线K线价格
34. `rsi_1d` - 日线RSI
35. `atr_1d` - 日线ATR
36. `boll_upper_1d` - 日线布林带上轨
37. `boll_mid_1d` - 日线布林带中轨
38. `boll_lower_1d` - 日线布林带下轨
39. `boll_position_1d` - 日线布林带位置
40. `volume_1d` - 日线成交量
41. `trend_1d` - 日线趋势（上涨/下跌/横盘）
42. `ma_5d` - 5日均线
43. `ma_10d` - 10日均线
44. `ma_20d` - 20日均线

**网格参数**:
45. `grid_lower` - 网格下轨
46. `grid_upper` - 网格上轨

**总特征维度**: 46维（包含多时间尺度特征）

### 2.3 序列构建

**多时间尺度序列**:

**方案1：统一序列长度（推荐）**
- 所有时间尺度使用相同的序列长度（例如30步）
- 1分钟：最近30分钟
- 5分钟：最近150分钟（30×5）
- 1小时：最近30小时
- 日线：最近30天

**方案2：不同序列长度**
- 1分钟：30步（30分钟）
- 5分钟：12步（60分钟）
- 1小时：24步（24小时/1天）
- 日线：10步（10天）

**推荐方案1**，因为：
- 统一处理，代码简单
- 模型可以学习不同时间尺度的关系
- 序列长度一致，便于训练

### 2.4 模型架构

**多时间尺度LSTM**:

**方案1：单LSTM处理所有特征**
- 输入: `(batch_size, seq_length, 46)` - 46维特征（包含所有时间尺度）
- LSTM处理所有特征
- 优点：简单，模型可以学习特征间的关系
- 缺点：特征维度高，可能过拟合

**方案2：多LSTM分支（推荐）**
- 1分钟分支: `(batch_size, seq_length, 15)` - 1分钟特征
- 5分钟分支: `(batch_size, seq_length, 8)` - 5分钟特征
- 1小时分支: `(batch_size, seq_length, 9)` - 1小时特征
- 日线分支: `(batch_size, seq_length, 11)` - 日线特征
- 网格参数: `(batch_size, seq_length, 2)` - 网格参数
- 融合层: 将所有分支的输出融合
- 优点：每个时间尺度独立学习，更灵活
- 缺点：模型复杂度高

**方案3：分层LSTM（最推荐）**
- 第一层：处理1分钟和5分钟数据（短期）
- 第二层：处理1小时和日线数据（长期）
- 融合层：融合短期和长期特征
- 优点：符合多时间尺度的层次结构
- 缺点：实现复杂

**推荐方案2或方案3**，根据计算资源选择。

---

## 📝 三、实现步骤

### 3.1 修改训练数据生成

**文件**: `scripts/analysis/generate_training_data_from_klines.py`

**修改内容**:
1. 获取多时间尺度K线数据（1m, 5m, 1h, 1d）
2. 计算各时间尺度的技术指标
3. 对齐不同时间尺度的数据
4. 生成多时间尺度特征

### 3.2 修改特征提取

**文件**: `src/strategies/llm_strategy.py`

**修改内容**:
1. 扩展`prepare_features`方法，包含多时间尺度特征
2. 特征维度从18维扩展到46维
3. 处理不同时间尺度的数据对齐

### 3.3 修改模型架构

**文件**: `src/strategies/llm_strategy.py`

**修改内容**:
1. 修改`TradingLSTM`模型，支持多时间尺度输入
2. 实现多分支LSTM或分层LSTM
3. 更新输入维度

### 3.4 修改序列构建

**文件**: `src/strategies/llm_strategy.py`

**修改内容**:
1. 修改`prepare_sequence_features`方法
2. 支持多时间尺度的序列构建
3. 处理不同时间尺度的对齐

---

## ✅ 四、总结

### 4.1 核心改进

1. ✅ **多时间尺度数据**: 1分钟、5分钟、1小时、日线
2. ✅ **多时间尺度特征**: 46维特征（包含所有时间尺度）
3. ✅ **多时间尺度序列**: 统一序列长度，包含所有时间尺度
4. ✅ **多时间尺度模型**: 多分支LSTM或分层LSTM

### 4.2 优势

- ✅ **长期趋势**: 日线确定大方向
- ✅ **中期趋势**: 1小时确定中期方向
- ✅ **短期趋势**: 5分钟确定入场时机
- ✅ **精确入场**: 1分钟精确入场

### 4.3 下一步

1. ✅ 修改训练数据生成脚本，获取多时间尺度数据
2. ✅ 修改特征提取，包含多时间尺度特征
3. ✅ 修改模型架构，支持多时间尺度输入
4. ✅ 测试多时间尺度模型性能

---

**状态**: 多时间尺度设计方案已完成
