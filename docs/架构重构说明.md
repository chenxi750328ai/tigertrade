# 架构重构说明：统一策略接口和工厂模式

**重构时间**: 2026-01-27  
**目标**: 实现模型切换无需修改代码，只需修改配置

---

## 一、问题分析

### 原有问题
- 每次切换模型都需要修改DEMO运行代码
- 不同策略的接口不统一
- 代码耦合度高，难以维护

### 解决方案
1. **统一策略接口** (`BaseTradingStrategy`)
2. **策略工厂模式** (`StrategyFactory`)
3. **配置文件驱动** (`strategy_config.json`)

---

## 二、架构设计

### 1. 基础策略接口 (`base_strategy.py`)

所有策略必须实现的统一接口：

```python
class BaseTradingStrategy(ABC):
    @abstractmethod
    def predict_action(self, current_data, historical_data=None) -> Tuple[int, float, Optional[float]]:
        """预测交易动作"""
        pass
    
    @abstractmethod
    def prepare_features(self, row) -> list:
        """准备特征向量"""
        pass
    
    @property
    @abstractmethod
    def seq_length(self) -> int:
        """返回序列长度"""
        pass
    
    @property
    @abstractmethod
    def strategy_name(self) -> str:
        """返回策略名称"""
        pass
```

### 2. 策略工厂 (`strategy_factory.py`)

通过配置创建策略实例：

```python
# 注册策略
StrategyFactory.register('moe_transformer', MoETradingStrategy)
StrategyFactory.register('lstm', LLMTradingStrategy)

# 创建策略（无需修改代码）
strategy = StrategyFactory.create('moe_transformer')
```

### 3. 配置文件 (`config/strategy_config.json`)

```json
{
  "default_strategy": "moe_transformer",
  "strategies": {
    "moe_transformer": {
      "model_path": "/home/cx/trading_data/best_moe_transformer.pth",
      "seq_length": 500
    }
  }
}
```

---

## 三、使用方法

### 方法1：修改配置文件

编辑 `/home/cx/tigertrade/config/strategy_config.json`：

```json
{
  "default_strategy": "lstm",  // 修改这里切换策略
  "strategies": {
    "lstm": {
      "model_path": "/home/cx/trading_data/best_lstm_improved.pth",
      "seq_length": 30
    }
  }
}
```

### 方法2：命令行参数

```bash
# 使用MoE Transformer（默认）
python scripts/run_moe_demo.py

# 使用LSTM
python scripts/run_moe_demo.py lstm

# 使用GRU
python scripts/run_moe_demo.py gru
```

### 方法3：环境变量

```bash
export TRADING_STRATEGY=moe_transformer
python scripts/run_moe_demo.py
```

---

## 四、优势

### ✅ 代码解耦
- DEMO运行代码不再依赖具体策略类
- 策略实现和主程序分离

### ✅ 易于扩展
- 添加新策略只需：
  1. 实现`BaseTradingStrategy`接口
  2. 在工厂中注册
  3. 添加到配置文件

### ✅ 配置驱动
- 切换模型只需修改配置文件
- 无需修改代码

### ✅ 统一接口
- 所有策略使用相同的接口
- 便于测试和对比

---

## 五、文件结构

```
tigertrade/
├── src/
│   └── strategies/
│       ├── base_strategy.py          # 基础接口
│       ├── strategy_factory.py       # 策略工厂
│       ├── moe_strategy.py           # MoE策略（实现接口）
│       └── llm_strategy.py           # LSTM策略（实现接口）
├── config/
│   └── strategy_config.json          # 策略配置
└── scripts/
    └── run_moe_demo.py                # DEMO运行脚本（使用工厂）
```

---

## 六、后续改进

1. **自动发现策略**: 扫描`strategies`目录，自动注册所有策略
2. **策略热切换**: 运行时动态切换策略
3. **策略组合**: 支持多个策略的投票或加权组合
4. **性能监控**: 统一监控所有策略的性能指标

---

**重构完成**: 现在切换模型只需修改配置文件，无需修改代码！
