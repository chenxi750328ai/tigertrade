# 每日例行：结果分析与算法优化在干啥

本文说明「收益与算法优化」脚本（`scripts/optimize_algorithm_and_profitability.py`）**实际用到的数据**和**产出的效果数据**，避免「没有效果数据、每天在干啥」说不清。

## 每日例行做了什么

1. **结果分析**
   - **收益率**：从 API 历史订单计算（总盈亏、胜率、平均收益）。若未配置 API 或订单为空，则无此项。
   - **策略表现**：从 DEMO 多日志汇总（主单成功次数、止损止盈条数、买入次数等）+ `today_yield.json` 今日收益率。
   - **网格/BOLL 回测**：若有 `data/processed/test.csv`，跑参数网格搜索，得到最优参数和回测收益率/胜率，写入报告。

2. **算法优化**
   - 对 grid、boll 策略做网格回测（`parameter_grid_search.grid_search_optimal_params`），产出 `optimal_parameters` 与回测的 `return_pct`、`win_rate`。
   - 报告中的「优化建议」依赖收益率数据：若 profitability 为空，则无建议。

3. **报告**
   - 生成 `docs/reports/algorithm_optimization_report.json`、`.md`。
   - 报告内**「效果数据来源」**一节会写明：本次例行用了 API 订单 / DEMO 日志 / 回测 中的哪些，缺了哪些。

## 效果数据从哪来（数据源）

| 数据源 | 产出 | 条件 |
|--------|------|------|
| **API 历史订单** | profitability（总交易数、胜率、平均收益） | 需 trade_api.get_orders 可用且订单解析实现；当前解析未完全实现时多为空。 |
| **DEMO 多日志** | strategy_performance.moe_transformer 的 demo_*（订单成功、止损止盈条数等） | 项目根或 logs/ 下存在 demo_*.log、demo_run_20h_*.log。 |
| **today_yield.json** | 今日收益率展示 | 需有人或脚本写入 docs/today_yield.json。 |
| **网格/BOLL 回测** | optimal_parameters、grid/boll 的 return_pct/win_rate | 需存在 `data/processed/test.csv`（K 线等），否则回测不跑、无效果数据。 |

## 为啥经常「没有效果数据」

- **收益率/胜率为 0 或空**：API 订单未拉取到或未解析；或未跑回测（缺 test.csv）。
- **只有 DEMO 订单计数**：DEMO 日志只有「下单成功/止损止盈条数」等，没有逐笔盈亏；真实收益率需来自 API 成交/对账或回测。
- **优化建议为空**：建议依赖 profitability（胜率、平均收益），若 profitability 为空则不会生成建议。

## 怎么让例行「有效果数据」

1. **回测**：准备 `data/processed/test.csv`（含 close 等列），再跑 `python scripts/optimize_algorithm_and_profitability.py`，网格/BOLL 会产出 return_pct、win_rate 和最优参数。
2. **API 订单**：在脚本中实现 `calculate_profitability(orders)` 对 get_orders 返回结构的解析，算出 total_profit、win_rate，则报告会有「收益率分析」。
3. **DEMO**：保持 DEMO 运行并保留 demo_*.log，报告会汇总订单与日志统计；若需 DEMO 收益率，需在 DEMO 或对账侧产出并写入 today_yield 或报告。

## 相关文件

- 脚本：`scripts/optimize_algorithm_and_profitability.py`
- 报告：`docs/reports/algorithm_optimization_report.json`、`algorithm_optimization_report.md`
- 报告内「效果数据来源」：每次运行后写在上述报告开头，说明本次用了啥、缺啥。
