# 每日例行：结果分析与算法优化在干啥

本文说明「收益与算法优化」脚本（`scripts/optimize_algorithm_and_profitability.py`）**实际用到的数据**和**产出的效果数据**，避免「没有效果数据、每天在干啥」说不清。

**必守**：**DEMO 实盘收益率 = 仅以老虎后台可核对的数据为准**。完成的订单才计入收益率；未在老虎后台成交的（模拟单、下单失败、仅日志统计）不得作为实盘收益率展示。详见 [DEMO实盘收益率_定义与数据来源](DEMO实盘收益率_定义与数据来源.md)。

### 四个问题速查（数据来源与测试方法）

| 问题 | 答案所在 |
|------|----------|
| **1. 回测**：为何可能只有 1 笔？return_pct、num_trades、win_rate 含义？测试方法？ | 本页「效果数据从哪来」表 + 「报告里 DEMO/回测指标含义」；[回测数据集说明](回测数据集说明.md) 第四节、第五节；[需求分析](需求分析和Feature测试设计.md) 附录 A。 |
| **2. 日志记录**：order_log 每条对应什么？主单是否带止损/止盈价？能否看到开仓+对应止损/止盈？ | [需求分析](需求分析和Feature测试设计.md) 附录 B（order_log、DEMO 运行日志）。 |
| **3. 报告指标**：demo_sl_tp_log、demo_execute_buy_calls 是什么？ | 本页「报告里 DEMO/回测指标含义」；[需求分析](需求分析和Feature测试设计.md) 附录 B。实现见 `scripts/analyze_demo_log.py`。 |
| **4. DEMO/实盘胜率**：报告里「实盘/DEMO」的 win_rate 从哪来？ | **实盘/DEMO 表里的胜率**只来自 **API 历史订单**解析（profitability）；无 API 数据时该列为 —。**回测表**里的 win_rate 来自回测（grid/boll）。此前曾误把回测的 win_rate（如 1 笔→100%）显示在实盘列，已修复：实盘列胜率仅来自 API。DEMO **日志**无逐笔盈亏，没有「从日志解析的胜率」。 |

## 每日例行做了什么

1. **结果分析**
   - **收益率**：从 API 历史订单计算（总盈亏、胜率、平均收益）。若未配置 API 或订单为空，则无此项。
   - **策略表现**：从 DEMO 多日志汇总（主单成功次数、止损止盈条数、买入次数等）+ `today_yield.json` 今日收益率。
   - **网格/BOLL 回测**：若有 `data/processed/test.csv`，跑参数网格搜索，得到最优参数和回测收益率/胜率，写入报告。

2. **算法优化**
   - 对 grid、boll 策略做网格回测（`parameter_grid_search.grid_search_optimal_params`），产出 `optimal_parameters` 与回测的 `return_pct`、`win_rate`。
   - 报告中的「优化建议」依赖收益率数据：若 profitability 为空，则无建议。

3. **报告**
   - 生成 `docs/reports/algorithm_optimization_report.json`、`.md` 及策略对比报告。
   - 报告内**「效果数据来源」**一节会写明：本次例行用了 API 订单 / DEMO 日志 / 回测 中的哪些，缺了哪些。
   - **报告自检**：生成后会自检是否合理——算法报告检查「回测仅 1 笔时是否含胜率说明」「无 API 时是否标明数据来源」；策略对比报告检查「实盘/DEMO 胜率列是否仅来自 API（无 API 时不为 100%）」。通过或警告会打在运行日志中，便于发现误用回测胜率等问题。

## 效果数据从哪来（数据源）

| 数据源 | 产出 | 条件 |
|--------|------|------|
| **API 历史订单** | profitability（总交易数、胜率、平均收益） | 需 trade_api.get_orders 可用且订单解析实现；当前解析未完全实现时多为空。 |
| **DEMO 多日志** | strategy_performance 的 demo_* 指标（见下） | 项目根或 logs/ 下存在 demo_*.log、demo_run_20h_*.log。 |
| **today_yield.json** | 今日收益率展示 | 应由 **老虎后台** 拉取结果写入（`scripts/fetch_tiger_yield_for_demo.py` + `update_today_yield_for_status.py`）；未核对老虎时不得以日志解析的 % 充作实盘收益率。 |
| **网格/BOLL 回测** | optimal_parameters、grid/boll 的 return_pct/win_rate/num_trades | 需存在 `data/processed/test.csv`；回测方法见 [回测数据集说明](回测数据集说明.md)、[需求分析附录](需求分析和Feature测试设计.md)。 |

### 报告里 DEMO/回测指标含义（数据来源与测试方法）

- **return_pct**：回测资金收益率 (%)，`(期末资金 - 10万)/10万×100`。来自 `parameter_grid_search.backtest_with_params`。
- **num_trades**：回测完成的开平仓笔数。**若仅为 1**，多因数据或参数下只触发一次完整交易，此时 win_rate 100% 或 0% 无参考意义。
- **win_rate**：**回测表**里 = 回测胜率（盈利笔数/完成笔数×100）；**实盘/DEMO 表**里 = 仅来自 **API 历史订单**解析，无 API 时为 —。DEMO 日志无逐笔盈亏，没有「从日志解析的胜率」。此前实盘列曾误用回测 win_rate（如 1 笔 100%），已改为实盘列仅用 API。
- **demo_sl_tp_log**：DEMO 日志全文中，匹配「止损|止盈|STP|止盈单|止损单|已提交止损|已提交止盈」的**字符串出现次数**（非订单笔数）。
- **demo_execute_buy_calls**：DEMO 日志全文中，匹配「execute_buy|动作: 买入」的**次数**。
- **demo_order_success / success_orders_sum / fail_orders_sum**：来自日志正则（如「订单提交成功」「成功订单: N」「失败订单: N」）的汇总，非老虎后台对账结果。

**订单与日志记录**（开仓与止损/止盈单如何记录）：见 [需求分析和Feature测试设计](需求分析和Feature测试设计.md) 附录 B。**测试与验证方法**：实盘收益率以老虎后台为准；回测见 [回测数据集说明](回测数据集说明.md)；订单核对见 [DEMO实盘收益率_定义与数据来源](DEMO实盘收益率_定义与数据来源.md)、`scripts/verify_demo_orders_against_tiger.py`。

## 为啥经常「没有效果数据」

- **收益率/胜率为 0 或空**：API 订单未拉取到或未解析；或未跑回测（缺 test.csv）。
- **只有 DEMO 订单计数**：DEMO 日志只有「下单成功/止损止盈条数」等，没有逐笔盈亏；真实收益率需来自 API 成交/对账或回测。
- **优化建议为空**：建议依赖 profitability（胜率、平均收益），若 profitability 为空则不会生成建议。

## 怎么让例行「有效果数据」

1. **回测**：准备 `data/processed/test.csv`（含 close 等列），再跑 `python scripts/optimize_algorithm_and_profitability.py`，网格/BOLL 会产出 return_pct、win_rate 和最优参数。
2. **API 订单**：在脚本中实现 `calculate_profitability(orders)` 对 get_orders 返回结构的解析，算出 total_profit、win_rate，则报告会有「收益率分析」。
3. **DEMO 实盘收益率**：必须用**老虎后台**数据核对。运行 `scripts/fetch_tiger_yield_for_demo.py` 拉取 DEMO 账户订单，再运行 `update_today_yield_for_status.py` 写入 today_yield.json；未拉取到则显示「需老虎后台数据核对」。不得用 DEMO 日志解析的百分比作为实盘收益率。

## 回测数据集来源与是否每日更新

- **回测用的数据**：`data/processed/test.csv`（以及 train/val），由 **`scripts/merge_recent_data_and_train.py`** 合并近期数据后，经 **`scripts/data_preprocessing.py`** 的 TigerTradeDataProcessor 产出。
- **是否每日更新**：若每日按例行跑「数据合并+预处理」（第 5 项），则 **每日更新**；否则沿用上次产出。详见 [回测数据集说明](回测数据集说明.md)。

## 相关文件

- 脚本：`scripts/optimize_algorithm_and_profitability.py`
- 报告：`docs/reports/algorithm_optimization_report.json`、`algorithm_optimization_report.md`
- 报告内「效果数据来源」与「日志与老虎后台差异说明」：每次运行后写在上述报告中，说明本次用了啥、缺啥，以及为何日志与老虎后台可能不一致。
