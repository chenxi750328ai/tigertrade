# 回溯：执行失败了怎么还算出收益率？推算方式与验证

## 一、当时那个「收益率」是怎么来的（回溯结论）

**不是按成功笔数推算的**，而是**误把 DEMO 运行日志里的一行字当成了实盘收益率**。

1. **来源**  
   - 旧版 `update_today_yield_for_status.py` 里有一个 `from_demo_logs()`：用正则去扫 `demo_*.log`、`demo_run_20h_*.log` 等，匹配诸如 `收益率[=:\s]*([-+]?\d+\.?\d*)%?`、`盈亏`、`总盈` 等。  
   - DEMO 运行时会往日志里打 **「预测收益率: 6.65%」**（或 6.64% 等），这是**模型/策略的预测值**，不是实际成交结果。  
   - 正则**没有区分「预测」和「实际」**，只要匹配到「收益率」+ 数字 + %，就当成「今日收益率」写进 `today_yield.json`，并在状态页/报告里展示。

2. **为何执行失败还能看到收益率**  
   - 执行失败（含 API 被拒）只影响**真实下单是否成交**，不影响**策略在日志里打印「预测收益率」**。  
   - 所以会出现：订单大量失败，但日志里仍有「预测收益率: 6.65%」→ 被误采 → 页面上显示「今日收益率 6.65%」。  
   - **没有用成功笔数做任何推算**；也没有用 order_log 的 real+success 去算过一笔「若这些单都成交的收益」。

3. **有无验证**  
   - **没有**。该数字未与老虎后台成交、未与 order_log 的 real success 对账，也未标注为「预测」或「推算」，因此属于**误用日志字段**，不是可验证的收益率指标。

---

## 二、两种收益率的区分（约定）

| 名称           | 含义                     | 数据来源                     | 可否验证                 |
|----------------|--------------------------|------------------------------|--------------------------|
| **实际收益率** | 真实成交带来的收益       | 老虎后台订单/成交、账户盈亏  | 可：用老虎后台数据核对   |
| **推算收益率** | 基于本系统记录推算的收益 | order_log 等可追溯记录+规则  | 可：用同一套规则复算核对 |

- **实际收益率**：只认老虎后台可核对的数据；执行失败、未成交的不计入。  
- **推算收益率**：若能从**可复现、可验证**的方式算出一个收益率（见下），则单独标为「推算收益率」，**与实盘/实际收益率明确区分**，不得混用。

---

## 三、为何不能假定「全是止盈」、胜率 100% 太假

**真实运行里每笔可能是止损或止盈**，本系统**无法仅从 order_log 推断**某笔平仓到底是止损还是止盈。

1. **order_log 里有什么、没有什么**  
   - 有：主单/止损单/止盈单的**提交记录**（side、price、order_id、reason=stop_loss 或 take_profit 等），即「我们下过止损/止盈单」。  
   - **没有**：这笔持仓**最后是被止损平仓还是止盈平仓**、**实际平仓价**。要得到这个，必须用**老虎后台的成交明细**（哪笔平仓单成交、成交价）或运行日志里**明确记录的「止损平仓」「止盈平仓」**（若现有日志有写的话）。

2. **若假定「全是止盈」会怎样**  
   - 若推算时**假定所有平仓都是止盈**，等于假定成功率 100%，这与实盘不符（真实会有止损），**不能作为可信的推算收益率**。  
   - 因此：**不能**在缺少平仓结果（止损 vs 止盈、实际平仓价）的情况下，仅凭 order_log 的「主单成功」去「推算」一个收益率并标成可信指标。

3. **回测里的胜率 100% 从哪来**  
   - 回测算法（如 `parameter_grid_search`、`risk_management.should_close_position`）**本身会既有止损也有止盈**：价格触达 stop_loss 则平仓记 reason=stop_loss，触达 take_profit 则记 reason=take_profit；盈/亏按平仓价算，胜率 = 盈利笔数/总成交笔数。  
   - 当前报告里 grid/boll 出现 **win_rate: 100%** 是因为该次回测**只完成了 1 笔交易**（num_trades: 1）且该笔盈利，所以 1/1=100%。这是**样本过少**导致的数字，不是算法假定「胜率 100%」或「全是止盈」。  
   - **结论**：回测逻辑没有假定 100% 胜率；多笔交易时会出现既有盈又有亏。若报告只展示「胜率 100%」而不强调「仅 1 笔」，会误导；应在报告中注明 num_trades，**若 num_trades 过少（如 1 笔）则胜率无参考意义**。
4. **报告里「实盘/DEMO」曾误显 100% 胜率**  
   - 策略对比报告中「实盘/DEMO 效果」表曾错误地使用了 **回测** 的 win_rate（grid/boll 回测只有 1 笔→100%）填在实盘列，导致「实盘操作很多、却显示胜率 100%」且与回测仅 1 笔矛盾。**已修复**：实盘/DEMO 表中的胜率**仅来自 API 历史订单**解析（profitability），无 API 数据时该列为 —，不再用回测 win_rate 填实盘列。

---

## 四、推算收益率：在「已知止损/止盈结果」的前提下才可做

**前提**：只有知道每笔平仓是**止损还是止盈**以及**实际平仓价**，才能可靠推算收益率；不能假定全是止盈或 100% 胜率。

1. **可靠数据来源**  
   - **老虎后台**：拉取成交明细，得到每笔平仓的成交价、方向，从而算盈亏与收益率（即实际收益率，无需再「推算」）。  
   - 或**运行日志**：若 DEMO/实盘运行时在日志里**明确记录**每笔平仓是「止损平仓」还是「止盈平仓」及价格，则可基于日志做「推算收益率」并与老虎对账验证。

2. **仅凭 order_log 时**  
   - order_log 只有「主单/止损单/止盈单的提交」，**没有「这笔最后是止损还是止盈」**，故**不能**在无老虎成交或日志平仓记录的前提下，给出可信的「推算收益率」。可做的是：与老虎对账后，用老虎的平仓结果反推；或注明「仅统计成功提交笔数，无法推算收益率」。

3. **产出与展示**  
   - 若将来在「有老虎成交或日志平仓记录」的前提下实现推算，产出应**单独命名**（如 `estimated_yield.json`），并**明确标注「推算收益率」**，与「实际收益率」分开；注明数据来源与「是否已用老虎后台验证」。

## 五、小结

- **执行失败却出现收益率的原因**：误把日志里的「预测收益率: 6.65%」当成实盘收益率，未做验证；**不是**按成功笔数推算的。  
- **实际收益率**：仅以老虎后台可核对的数据为准；执行失败则无实盘收益。  
- **不能假定全是止盈**：真实会有止损；order_log 无法区分某笔是止损还是止盈，**不能**在无平仓结果时假定 100% 止盈或 100% 胜率去做「推算收益率」。  
- **回测胜率 100%**：当前是样本过少（如 num_trades=1）导致的数字，不是算法假定 100%；回测本身会既有止损也有止盈，多笔时胜率会正常；报告应注明 num_trades，样本过少时胜率无参考意义。  
- **推算收益率**：仅在「已知每笔止损/止盈结果及平仓价」（老虎成交或日志明确记录）的前提下可做，且须与「实际收益率」区分展示并注明验证情况。
