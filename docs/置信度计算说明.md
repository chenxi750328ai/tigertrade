# 置信度计算说明

**更新时间**: 2026-01-23  
**位置**: `src/strategies/llm_strategy.py` - `predict_action`方法

---

## 📊 一、置信度计算流程

### 1.1 模型输出

模型（LSTM）输出**动作logits**（原始分数），形状为 `(batch_size, 3)`：
- `action_logits[0]`: 不操作的原始分数
- `action_logits[1]`: 买入的原始分数
- `action_logits[2]`: 卖出的原始分数

### 1.2 Softmax转换

使用**Softmax函数**将原始分数转换为概率分布：

```python
probabilities = torch.softmax(action_logits, dim=1).cpu().numpy()[0]
```

**Softmax公式**：
```
P(i) = exp(logits[i]) / Σ(exp(logits[j]))  for j in [0, 1, 2]
```

**结果**：
- `probabilities[0]`: 不操作的概率（0-1之间）
- `probabilities[1]`: 买入的概率（0-1之间）
- `probabilities[2]`: 卖出的概率（0-1之间）
- **三个概率之和 = 1.0**

### 1.3 选择动作

使用**argmax**找到概率最大的动作：

```python
action = np.argmax(probabilities)
```

**结果**：
- `action = 0`: 不操作
- `action = 1`: 买入
- `action = 2`: 卖出

### 1.4 计算置信度

**置信度 = 所选动作的概率值**：

```python
confidence = probabilities[action]
```

**含义**：
- 置信度范围：`[0.0, 1.0]`
- 置信度越高，模型对该动作越确定
- 如果三个动作概率相等（都是1/3），置信度 = 0.333

---

## 📈 二、置信度示例

### 2.1 示例1：高置信度

假设模型输出：
- `action_logits = [1.0, 5.0, 2.0]`（买入分数最高）

经过Softmax后：
- `probabilities = [0.018, 0.952, 0.030]`

选择动作：
- `action = 1`（买入）

置信度：
- `confidence = 0.952`（95.2%）

**解释**：模型非常确定应该买入。

### 2.2 示例2：低置信度

假设模型输出：
- `action_logits = [2.0, 2.1, 2.0]`（三个分数接近）

经过Softmax后：
- `probabilities = [0.331, 0.338, 0.331]`

选择动作：
- `action = 1`（买入）

置信度：
- `confidence = 0.338`（33.8%）

**解释**：模型不确定，三个动作概率接近，置信度较低。

### 2.3 示例3：中等置信度

假设模型输出：
- `action_logits = [1.0, 3.0, 1.5]`（买入分数较高）

经过Softmax后：
- `probabilities = [0.106, 0.740, 0.154]`

选择动作：
- `action = 1`（买入）

置信度：
- `confidence = 0.740`（74.0%）

**解释**：模型比较确定应该买入。

---

## 🎯 三、置信度的意义

### 3.1 置信度阈值

在`tiger1.py`中，只有当置信度 > 0.6 时才执行交易：

```python
if action != 0 and confidence > 0.6:
    # 执行交易
```

**原因**：
- 避免在模型不确定时执行交易
- 降低错误交易的风险
- 提高交易质量

### 3.2 置信度范围

| 置信度范围 | 含义 | 是否执行交易 |
|-----------|------|------------|
| **0.0 - 0.33** | 非常不确定（接近随机） | ❌ 不执行 |
| **0.33 - 0.5** | 不确定 | ❌ 不执行 |
| **0.5 - 0.6** | 中等确定 | ❌ 不执行（阈值以下） |
| **0.6 - 0.8** | 比较确定 | ✅ 执行 |
| **0.8 - 1.0** | 非常确定 | ✅ 执行 |

### 3.3 当前运行中的置信度

从日志中看到：
```
🧠 LLM模型预测（序列长度30）: 卖出, 置信度: 0.352, 网格调整: -0.092
```

**分析**：
- 置信度：0.352（35.2%）
- **低于阈值0.6，不会执行交易**
- 说明模型对当前市场状态不太确定

---

## 🔍 四、代码位置

### 4.1 关键代码

**文件**: `src/strategies/llm_strategy.py`

**行数**: 940-945

```python
# 计算动作概率
probabilities = torch.softmax(action_logits, dim=1).cpu().numpy()[0]

# 返回最可能的动作: 0=不操作, 1=买入, 2=卖出
action = np.argmax(probabilities)
confidence = probabilities[action]
```

### 4.2 使用位置

**文件**: `src/tiger1.py`

**行数**: 2952

```python
if action != 0 and confidence > 0.6:  # 降低置信度阈值以增加交易机会
    # 执行交易
```

---

## 📊 五、如何提高置信度

### 5.1 模型层面

1. **增加训练数据量**
   - 当前：9790条
   - 建议：增加到20000+条

2. **优化模型架构**
   - 增加hidden_size
   - 增加num_layers
   - 使用更长的序列长度

3. **改进特征工程**
   - 添加更多有效特征
   - 优化特征选择
   - 添加周线和月线特征

### 5.2 数据层面

1. **提高数据质量**
   - 使用更多真实Tick数据
   - 确保数据对齐准确

2. **增加数据多样性**
   - 包含不同市场状态的数据
   - 平衡各类标签的分布

### 5.3 训练层面

1. **优化损失函数**
   - 调整类别权重
   - 优化损失函数权重

2. **改进训练策略**
   - 使用更好的学习率调度
   - 增加训练轮次
   - 使用更好的正则化

---

## ✅ 六、总结

### 6.1 置信度计算

1. **模型输出**：3个动作的原始分数（logits）
2. **Softmax转换**：转换为概率分布（总和=1）
3. **选择动作**：argmax找到概率最大的动作
4. **置信度**：所选动作的概率值

### 6.2 置信度含义

- **范围**：0.0 - 1.0
- **越高越好**：表示模型越确定
- **阈值**：当前设置为0.6，只有置信度>0.6才执行交易

### 6.3 当前状态

- **当前置信度**：约0.35（35%）
- **低于阈值**：不会执行交易
- **原因**：模型对当前市场状态不确定

---

**状态**: 置信度计算逻辑清晰，可以通过优化模型和数据来提高置信度
