# 每日工作流程说明

## 🎯 项目目标

**每天执行以下工作流程**：
1. ✅ CI/CD测试 - 自动运行测试套件
2. ✅ 20小时稳定性测试 - 验证系统稳定性
3. ✅ 问题检测和修复 - 自动分析并修复问题
4. ✅ 数据分析并优化算法 - 基于测试数据优化

## 📅 每日自动执行流程

### 1. CI/CD测试（每天UTC 00:00自动运行）

**触发时机**：
- 每天UTC 00:00（北京时间08:00）自动运行
- 推送到main/develop分支时触发
- 可手动触发

**执行内容**：
- 运行完整测试套件（520+个测试）
- 收集代码覆盖率
- 检查覆盖率阈值
- 生成测试报告

**配置文件**: `.github/workflows/daily_ci_cd.yml`

### 2. 20小时稳定性测试

**运行方式**：
```bash
python scripts/stability_test_20h.py
```

**监控内容**：
- 错误统计（类型、频率、堆栈跟踪）
- 性能指标（CPU、内存使用）
- API调用（次数、错误率）
- 订单统计（成功/失败次数）

**输出文件**：
- `stability_test.log` - 详细日志
- `stability_stats.json` - 统计数据
- `stability_analysis.json` - 分析结果

### 3. 问题检测和分析

**分析脚本**：
```bash
# 分析稳定性测试结果
python scripts/analyze_stability_results.py stability_test.log

# 分析测试数据
python scripts/analyze_test_data.py

# 生成优化建议
python scripts/generate_optimization_suggestions.py
```

**自动检测的问题**：
- 测试失败
- 覆盖率不足
- 稳定性问题（错误过多、内存泄漏等）
- 性能问题（CPU/内存使用过高）

### 4. 数据分析和算法优化

**分析内容**：
- 测试通过率趋势
- 错误趋势分析
- 性能指标趋势
- 资源使用分析

**优化建议**：
- 基于测试结果
- 基于稳定性数据
- 算法优化建议
- 代码质量改进

## 📊 当前覆盖率状态

### 已达成目标 ✅
- **Executor模块**: 86.22%（目标80%+）
  - `data_provider.py`: 100%
  - `trading_executor.py`: 87.02%
  - `order_executor.py`: 79.69%

### 未达成目标 ⚠️
- **总体覆盖率**: 21.14%（目标65-70%）
- **api_adapter.py**: 62.37%（目标80%+）
- **tiger1.py**: 55.89%（目标65%+）

## 🔄 完整工作流程

```
每天UTC 00:00
    ↓
[GitHub Actions触发]
    ↓
[运行测试套件]
    ├─→ 收集覆盖率
    ├─→ 检查阈值
    └─→ 生成报告
    ↓
[运行20小时稳定性测试]
    ├─→ 监控错误
    ├─→ 记录性能指标
    └─→ 生成统计数据
    ↓
[分析数据]
    ├─→ 分析测试结果
    ├─→ 分析稳定性数据
    └─→ 识别问题
    ↓
[生成优化建议]
    ├─→ 修复建议
    ├─→ 优化建议
    └─→ 行动清单
    ↓
[修复和优化]
    ├─→ 修复失败的测试
    ├─→ 提升覆盖率
    └─→ 优化算法
```

## 📝 报告文件

### 测试报告
- `test-results.xml` - JUnit格式
- `test_analysis.json` - 测试数据分析
- `htmlcov/index.html` - HTML覆盖率报告

### 稳定性报告
- `stability_test.log` - 详细日志
- `stability_stats.json` - 统计数据
- `stability_analysis.json` - 分析结果

### 优化建议
- `optimization_suggestions.md` - Markdown格式
- `optimization_suggestions.json` - JSON格式

## 🎯 目标指标

### 测试目标
- **测试通过率**: > 90%（当前77.6%）
- **Executor模块覆盖率**: > 80% ✅（当前86.22%）
- **总体覆盖率**: > 65%（当前21.14%）

### 稳定性目标
- **错误率**: < 1%
- **内存使用**: < 1GB
- **CPU使用**: < 80%
- **20小时无崩溃**: ✅

## 🚀 使用方法

### 手动运行完整流程
```bash
cd /home/cx/tigertrade

# 1. 运行测试
PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 python -m coverage run --source=src -m pytest tests/ -v

# 2. 运行稳定性测试
python scripts/stability_test_20h.py

# 3. 分析结果
python scripts/analyze_stability_results.py
python scripts/analyze_test_data.py
python scripts/generate_optimization_suggestions.py
```

### 查看报告
- 测试报告: `test_analysis.json`, `htmlcov/index.html`
- 稳定性报告: `stability_analysis.json`
- 优化建议: `optimization_suggestions.md`

## ✅ 已建立的功能

- ✅ GitHub Actions CI/CD配置（每日自动运行）
- ✅ 20小时稳定性测试脚本
- ✅ 稳定性分析脚本
- ✅ 测试数据分析脚本
- ✅ 优化建议生成脚本
- ✅ 完整文档

## 📚 相关文档

- `docs/CI_CD和稳定性测试流程.md` - 详细流程说明
- `docs/完整覆盖率报告_20260129.md` - 覆盖率报告
- `README_CI_CD.md` - 快速参考

## 🎯 下一步

1. **修复失败的测试** - 提升测试通过率到90%+
2. **提升覆盖率** - 总体覆盖率提升到65%+
3. **优化算法** - 基于数据分析结果优化策略
4. **持续监控** - 每天检查CI/CD结果和稳定性报告
