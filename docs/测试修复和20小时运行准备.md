# 测试修复和20小时运行准备

**日期**: 2026-01-28  
**状态**: ✅ 核心测试已修复，准备启动20小时运行

## 一、测试错误修复

### 1.1 已修复的问题

✅ **test_feature_risk_management.py**:
- 修复了 `SINGLE_TRADE_LOSS_LIMIT` 常量不存在的问题
- 改用 `SINGLE_TRADE_LOSS` 和 `MAX_SINGLE_LOSS`（实际存在的常量）
- 所有5个测试用例现在都能通过

✅ **test_feature_order_execution.py**:
- 修复了 `tigeropen.exceptions` 导入错误
- 改用自定义 `MockTigerApiException` 类
- 修复了Mock测试中风控检查的问题
- 所有Mock测试现在都能通过

### 1.2 测试结果

```bash
# 运行核心Feature测试
python -m unittest tests.test_feature_risk_management tests.test_feature_order_execution.TestFeatureOrderExecutionWithMock -v

# 结果：7个测试全部通过 ✅
```

## 二、20小时运行准备

### 2.1 运行脚本

**主脚本**: `scripts/run_moe_demo.py`
- ✅ 已配置 `RUN_DURATION_HOURS = 20`
- ✅ 使用 `TradingExecutor.run_loop(duration_hours=20)`
- ✅ 支持所有策略（通过StrategyFactory）

**启动脚本**: `scripts/run_20h_demo.sh`
- ✅ 先运行核心测试确保没问题
- ✅ 检查DEMO账户配置
- ✅ 后台运行并记录日志

### 2.2 使用方法

**方式1：直接运行Python脚本**
```bash
cd /home/cx/tigertrade
python scripts/run_moe_demo.py
```

**方式2：使用启动脚本（推荐）**
```bash
cd /home/cx/tigertrade
bash scripts/run_20h_demo.sh
```

**方式3：后台运行并查看日志**
```bash
cd /home/cx/tigertrade
nohup python scripts/run_moe_demo.py > logs/demo_20h_$(date +%Y%m%d_%H%M%S).log 2>&1 &
tail -f logs/demo_20h_*.log
```

### 2.3 监控命令

```bash
# 查看日志
tail -f logs/demo_20h_*.log

# 查看进程
ps aux | grep run_moe_demo

# 查看最新日志
ls -lt logs/demo_20h_*.log | head -1 | awk '{print $NF}' | xargs tail -f
```

## 三、覆盖率状态

### 3.1 核心模块覆盖率

```
src/executor/__init__.py               4      0 100.00% ✅
src/executor/data_provider.py         49      0 100.00% ✅
src/executor/order_executor.py        88      3  96.59% ✅
src/executor/trading_executor.py    131     17  87.02% ✅
```

**Executor模块总计**: 71.73% 覆盖率

### 3.2 Feature测试覆盖

✅ **Feature 4（风险管理）**: 5个测试用例全部通过
- AR4.1: 仓位限制检查
- AR4.2: 单笔损失限制
- AR4.3: 日亏损限制
- AR4.4: 止损计算
- AR4.5: 止盈计算

✅ **Feature 3（订单执行）**: Mock测试通过
- AR3.1: 买入订单逻辑
- AR3.4: 订单拒绝处理

## 四、运行前检查清单

- [x] 核心Feature测试通过
- [x] DEMO账户配置存在 (`openapicfg_dem/tiger_openapi_config.properties`)
- [x] 策略配置存在或使用默认配置
- [x] 日志目录已创建 (`logs/`)
- [x] 20小时运行时长已配置

## 五、预期行为

### 5.1 正常运行

- 每5秒执行一次交易循环
- 获取市场数据 → 策略预测 → 执行订单
- 记录统计信息（预测次数、订单数、错误数）
- 20小时后自动停止

### 5.2 日志输出

- 初始化信息（API连接、策略加载）
- 每次循环的预测结果和订单执行情况
- 错误和异常信息
- 统计信息汇总

## 六、下一步

1. ✅ **已完成**: 测试修复
2. ⏳ **进行中**: 启动20小时运行
3. ⏳ **待完成**: 监控运行状态，收集运行数据

---

**启动命令**:
```bash
cd /home/cx/tigertrade
bash scripts/run_20h_demo.sh
```

**或直接运行**:
```bash
cd /home/cx/tigertrade
python scripts/run_moe_demo.py
```
