# 如何产出实际成交

**目标**：DEMO 账户在老虎后台有**策略驱动的真实成交**，项目才有可见成绩。

## 重要：不得用测试单冒充成交

- 后台曾出现的 **7 笔 FILLED** 已分析确认为**测试单**（限价 100 买入，与测试用例 price=100 一致），**不是策略 DEMO 的成交**，**不可作为项目成绩**。
- 今日实盘收益/状态页若显示「N 笔成交」，须区分：**限价 100 的 BUY 单 = 测试单流入，不算实际成绩**；只有策略在实盘时段、通过 run_20h_demo 下的单成交，才算实际成交。

## 残留单处理（已解决）

- **清理脚本**：`cd /home/cx/tigertrade && python scripts/close_demo_positions.py d`
- **作用**：拉取老虎 DEMO 持仓与挂单 → 先撤全部 SIL 挂单 → 再市价平多头/空头，直至持仓归零。
- **本次执行结果**：7 笔 SIL 挂单已撤，7 手多头已平，后台持仓已归零。后续新开仓由策略在 run_20h_demo 下产生，不会与残留测试单混在一起。

## 产出策略单实际成交的条件

1. **只用一个入口启动 DEMO**  
   ```bash
   cd /home/cx/tigertrade && bash scripts/run_20h_demo.sh
   ```  
   该脚本会：设 `ALLOW_REAL_TRADING=1`、校验 openapicfg_dem、后台跑 `run_moe_demo.py`（tiger1 d moe）。**不要**直接 `python scripts/run_moe_demo.py` 而不通过该脚本，以免环境变量漏设。

2. **在 COMEX 交易时段运行**  
   白银期货有交易时段（美东）；非时段只能挂单，不易成交。尽量在 COMEX 开盘时段跑 DEMO，才有更高概率成交。

3. **配置与权限**  
   - `openapicfg_dem/tiger_openapi_config.properties` 存在且配置正确，含 `account`。  
   - 该 DEMO 账户在老虎侧已开通期货行情/交易权限。

4. **测试不污染 DEMO 账户**  
   - 例行 pytest 默认加 `-m "not real_api"`，不向老虎发真实单。  
   - 若跑带 real_api 的用例，应用**独立测试账户**或 mock，避免与 DEMO 共用同一账户导致挂单/成交被测试单占满。

5. **风控与持仓**  
   - 硬顶 2 手；下单前以老虎后台持仓+待成交为准，避免多进程叠单。  
   - 若 order_log 里大量「持仓硬顶」「ALLOW_REAL_TRADING」拒绝，说明未用 `run_20h_demo.sh` 或未在正确环境运行，需按上文 1 执行。

## 例行自检（是否有实际成交）

- 运行：`python scripts/update_today_yield_for_status.py`  
- 查看：`docs/today_yield.json` 的 `yield_note`、`yield_pct`。  
- 若为「今日无成交」，按 `zero_trades_action` 排查，或运行：  
  `python scripts/export_order_log_and_analyze.py --with-backend`  
  查看报告「五、DEMO 今日 0 成交原因（定位）」和「四、后台订单与 order_log 对照」。
