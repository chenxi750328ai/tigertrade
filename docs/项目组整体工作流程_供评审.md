# 项目组整体工作流程（供评审）

> 本文档从「例行工作清单」「项目角色与每日例行工作」「每日训练与优化闭环」等整理而成，供评审整体流程是否合理、有无缺口。

---

## 一、目标与原则

| 项目 | 说明 |
|------|------|
| **例行工作目标** | **提升收益率**。不是光跑完拉倒，而是：有问题要**解决问题**，解决后**继续工作**，一直干到能解决的都解决、收益率相关数据与优化到位。 |
| **每轮逻辑** | 例行 → 发现问题 → **能自动修就修**（如缺 test.csv 则先生成再回测）→ 继续 → 不能修的列原因与建议并 exit(1)，下一轮或人工介入后继续。 |
| **产出要求** | 实盘收益率仅以**老虎后台可核对**的数据为准；报告空项必须写明根因；报告自检以**部署后的网页**为准。 |

---

## 二、角色与职责

| 角色 | 职责摘要 | 例行侧重 |
|------|----------|----------|
| **Leader（陈正霞）** | 项目负责、派活与验收、**监控项目计划与成员进展/问题**。 | 本人例行 + **状态页刷新与推送**（可委托后回报）；必须做计划与成员监控。 |
| **设计** | 策略与架构设计、设计文档、参数与风控方案、与开发/测试对齐。 | 设计文档维护、算法/参数建议、策略报告中的设计链接。 |
| **开发** | 实现需求与设计、代码与脚本、订单/风控/DEMO、API 与数据管道。 | CI、问题修复、DEMO/数据/脚本执行、文档同步。 |
| **测试** | 用例与回归、覆盖率与门禁、DEMO/稳定性验证、问题复现与回归。 | 测试与覆盖率、20h 稳定性/DEMO 参与、问题与回归。 |

全员例行**必须覆盖 7 项**（见下），不得简写或合并为少于 7 项。

---

## 三、每日/每轮完整流程（7 项例行）

整体顺序与依赖关系如下（**4 与 5+6 可并行**，见第五节「20h 与训练/优化并行与流水」）。执行完成后向 Leader **汇报**（汇报不是回报）。

```
┌─────────────────────────────────────────────────────────────────────────┐
│  1. CI/CD 测试                                                            │
│     pytest tests/ -m "not real_api"（与 CI 一致）；推代码前必跑。          │
├─────────────────────────────────────────────────────────────────────────┤
│  2. 覆盖率统计                                                            │
│     pytest --cov=src --cov-report=term-missing；关注关键模块。             │
├─────────────────────────────────────────────────────────────────────────┤
│  3. 问题解决                                                              │
│     修复本次/近期 Bug、失败用例、告警；根因与解法写入 RAG 或 docs。         │
├─────────────────────────────────────────────────────────────────────────┤
│  4. 20 小时稳定性测试（含 20h DEMO 运行）  ◀── 与 5、6 可并行              │
│     · 前置：确认 openapicfg_dem 存在且可读。                                │
│     · 启动：run_20h_demo.sh 或 stability_test_20h.py；须有实盘数据与订单输出。│
│     · 20h 运行期间：由定时任务用「新产出数据」驱动训练+算法优化（见第四节）。 │
│     · 优化后若回测 OK：可临时重启 DEMO（仅计短暂重启间隔，不影响 20h 指标）  │
│       或热更新参数，或安排在每日停盘时间刷新参数/重启 DEMO。                │
│     · 记录：运行状态、日志路径、是否跑满 20h、是否有新输出。                 │
├─────────────────────────────────────────────────────────────────────────┤
│  5. 数据刷新和模型训练  ◀── 可与 4 并行；20h 内可被定时多次触发             │
│     · 数据：merge_recent_data_and_train.py 或 data_preprocessing.py →     │
│             data/processed/{train,val,test}.csv。                          │
│     · 训练：train_multiple_models_comparison.py（LSTM/Transformer/        │
│             Enhanced/MoE 等）；记录对比结果。                               │
│     · 即使收益未改进也须有分析结论（原因写入 insights/docs）。              │
├─────────────────────────────────────────────────────────────────────────┤
│  6. 收益率分析和算法优化（两项都做）  ◀── 可与 4 并行；20h 内可被定时触发   │
│     · 入口：optimize_algorithm_and_profitability.py（或由每日流程/定时调用）。│
│     · 内容：拉订单→缺 test.csv 则生成→回测→报告→自检。                     │
│     · 优化完成且回测 OK：可触发 DEMO 临时重启或停盘时刷新参数/重启。        │
├─────────────────────────────────────────────────────────────────────────┤
│  7. 状态页刷新                                                             │
│     更新 docs/status.html（按特性、分组）；提交并 push；由 Leader 负责。   │
│     报告自检须到**网页**（GitHub Pages）查看，本地不算。                    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、两条主链路说明

### 4.1 每日数据与训练链路（对应例行 5）

- **入口**：可单独跑 `scripts/daily_data_collection_and_training.py`，或由人工/定时触发。
- **步骤**：收集新数据 → 准备训练数据（prepare_training_data）→ 训练模型（train_models）→ 评估 → 优化算法（内部一次）→ 分析收益率（内部一次）。
- **重要**：无论前面是否失败，**最后都会调用** `run_optimization_workflow()`，保证**真实回测 + 报告 + today_yield** 被产出。

### 4.2 收益与算法优化链路（对应例行 6，核心闭环）

- **入口**：`scripts/optimize_algorithm_and_profitability.py`（可被每日流程调用，也可单独跑）。
- **步骤**：
  1. 加载历史订单（先 api_manager，无则 openapicfg_dem 直接拉）→ 计算 profitability；
  2. 分析策略表现（DEMO 多日志汇总）；
  3. **若缺 test.csv 则尝试生成**（ensure_test_csv：data_preprocessing / merge_recent_data_and_train）；
  4. 回测：grid/boll（parameter_grid_search）+ moe_transformer/lstm（backtest_model_strategies）；
  5. 生成算法报告（含本报告空项根因说明）、更新 today_yield、订单执行状态；
  6. 生成策略报告（generate_strategy_reports.py）；
  7. **报告自检**：实盘空/回测空等列问题与修复建议，未通过则 exit(1)，便于下一轮继续「例行→解决→优化」。

- **产出**：`docs/reports/algorithm_optimization_report.*`、`docs/reports/strategy_reports/`、`docs/today_yield.json`、`docs/order_execution_status.json` 等；报告在 GitHub Pages 部署后通过网页自检。

---

## 五、20h 与训练/优化并行与流水式运行（设计）

**原则**：20 小时稳定性测试（DEMO 运行）与「数据刷新 + 模型训练 + 算法优化」**可以并行**；20h 运行过程中产出的数据**定时驱动**新一轮训练与算法优化，形成**流水操作、一直不停**；优化结果回测 OK 后，可临时重启 DEMO 或停盘时刷新参数，尽量少影响 20h 指标。

### 5.1 并行关系

| 维度 | 说明 |
|------|------|
| **20h DEMO** | 独立进程长时间运行，持续产出行情消费、订单、日志。 |
| **训练 + 算法优化** | 可独立于 DEMO 进程执行（读 DEMO 已产出日志/订单、或读数据盘），与 20h **并行**，不要求「先停 DEMO 再训练再优化」。 |
| **流水** | 20h 内每隔一段时间用「当前已产出数据」跑一轮：数据合并/预处理 → 训练 → 算法优化；优化与运行**交替推进**，一直不停。 |

### 5.2 定时驱动间隔（建议）

- **建议间隔**：**4 小时**（可配置）。即 20h 内约触发 **5 次**「数据刷新 + 训练 + 算法优化」。
- **依据**：兼顾「新数据量」与「算力/时间」：间隔太短易重复算、太长则优化反馈慢。4h 为默认值，可通过环境变量或配置覆盖（如 `PIPELINE_OPTIMIZATION_INTERVAL_HOURS=4`）。
- **实现方式**：由**流水线脚本**或 **cron/外部调度**在 20h 运行期间按间隔调用：`merge_recent_data_and_train.py`（或 data_preprocessing）→ `train_multiple_models_comparison.py` → `optimize_algorithm_and_profitability.py`；或使用统一入口脚本（见下节）。

### 5.3 优化完成后：DEMO 重启或参数刷新

当某一轮**算法优化完成且回测效果 OK** 时：

| 策略 | 说明 | 对 20h 指标的影响 |
|------|------|-------------------|
| **优先：不重启、直接刷新参数** | 若 DEMO/策略支持**热加载**（运行时读最新参数或模型），则只刷新配置或重载模型，**不重启进程**。 | 无中断，20h 连续计时不受影响。 |
| **次选：每日停盘时间刷新/重启** | 在**每天停盘时段**刷新参数或重启 DEMO，避免盘中打断。 | 仅停盘时段短暂间隔，不影响「交易时段连续运行」的 20h 统计口径。 |
| **可接受：临时重启 DEMO** | 若无法热更，可**临时重启 DEMO** 使新参数/模型生效；重启间隔时间**不计入** 20h 稳定性指标（或单独约定「允许一次 N 分钟内重启」）。 | 仅算一点重启间隔，20h 指标仍视为达标。 |

**约定**：若采用「临时重启」，单次重启造成的停机时间（如 &lt; 5 分钟）在统计 20h 时可不扣减或单独注明，以「总运行时长 ≥ 20h 且满足稳定性要求」为准。

### 5.4 流水线实现建议

- **脚本/入口**：可新增 `scripts/pipeline_20h_with_periodic_optimization.py`（或等价脚本）：  
  - 后台启动 20h DEMO（或检测已有 DEMO 进程）；  
  - 循环：每 **4 小时**（可配置）执行一次「数据合并 → 训练 → 算法优化」；  
  - 若本轮优化完成且报告自检通过（回测 OK）：根据配置选择「热更参数」「记录待停盘重启」或「立即临时重启 DEMO」；  
  - 直至 20h 到达或人工终止。
- **cron 替代**：若无常驻流水线脚本，可用 cron 每 4h 跑一次「数据+训练+优化」；20h DEMO 单独由 `run_20h_demo.sh` 启动，与 cron 并行，实现相同效果。

---

## 六、产出与验收

| 产出 | 验收方式 |
|------|----------|
| 测试通过、覆盖率 | CI 与本地 pytest；推代码前必跑与 CI 一致命令。 |
| DEMO 稳定、有订单输出 | 日志与 order_log；每日期望有老虎后台可核对订单。 |
| train/val/test.csv | 存在且被回测/训练使用；缺 test.csv 时脚本会尝试自动生成。 |
| 回测与实盘数据 | 算法报告与策略对比报告中；空项须带根因说明。 |
| 状态页与报告页 | 更新后 push，在**网页**（Pages）上核对，本地不算。 |

---

## 七、异常与「解决问题继续」

- **能自动修的**：例如缺 test.csv → 本 run 内尝试生成 → 再回测；修完继续当轮流程。
- **不能自动修的**：例如实盘数据空（无 openapicfg_dem 或账户无成交）、回测仍全空（生成 test.csv 失败）→ 报告自检列出**问题 + 修复建议**，exit(1)，下一轮或人工介入后继续。
- **目标**：例行工作 = 提升收益率；有问题就解决、解决后继续，一直干到问题都解决或明确卡点。

---

## 八、文档与计划联动

- **计划**：[项目计划_月度周计划.md](项目计划_月度周计划.md) — 任务项、责任者、时间、进展。
- **状态**：[STATUS.md](STATUS.md) — 当前状态摘要、近期完成、风险与求助、快速链接。
- **设计总入口**：[需求分析和Feature测试设计.md](需求分析和Feature测试设计.md) — 需求、Feature、设计文档索引（回测/实盘/训练流程、策略设计、大模型搜参等）。
- **例行正本**：`shared_rag/best_practices/例行工作清单_agent必读.md` — 7 项完整列表与命令；`项目角色与每日例行工作.md` — 角色与每日例行。

---

## 九、供评审的问题点

1. **顺序与依赖**：当前 1→7 的先后是否合理？是否有项应提前/延后（例如是否必须先有 test.csv 再跑 5）？
2. **20h DEMO 与 6 的关系**：DEMO 须有实盘数据与订单输出；收益与算法优化依赖 DEMO 日志与（在有 openapicfg_dem 时）老虎订单。两者是否同机/同环境跑？若 6 在无 openapicfg_dem 的环境跑，实盘必空，是否接受并仅靠「根因说明 + 下一轮在有配置环境跑」闭环？
3. **自动生成 test.csv**：仅依赖 data_preprocessing / merge_recent_data_and_train，若两者都依赖外部数据源（如 /home/cx/trading_data），在无该数据的环境会失败，是否需在文档中明确「数据环境前置条件」？
4. **报告自检 exit(1)**：未通过时直接 exit(1)，是否会打断 daily_data_collection_and_training 的后续保存与日志？若会，是否改为返回码或记录「自检未通过」到 daily_workflow_results 而不 exit，由上层决定是否退出？
5. **Leader 状态页**：状态页由 Leader 负责，若当日无人执行第 7 项，是否有兜底（如 CI 中只更新报告不更新 status.html）？

以上为根据现有文档整理的项目组整体工作流程，供您评审；可根据评审结果修改清单、脚本或本文档。

---

## 十、相关交付物

| 文档 | 说明 |
|------|------|
| **[多AG自动化并发工作流程](多AG自动化并发工作流程.md)** | 多 AG 分工配合、并发实现、江湖使用方式、架构图与流程图、业界多 Agent 框架方案对比；项目关键需求分析与设计交付物。 |
