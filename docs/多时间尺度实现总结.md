# 多时间尺度实现总结

**更新时间**: 2026-01-23

---

## ✅ 一、已完成

### 1.1 设计方案

✅ **多时间尺度设计方案** (`docs/多时间尺度设计方案.md`)
- 数据获取：1分钟、5分钟、1小时、日线
- 特征设计：46维特征（包含所有时间尺度）
- 序列构建：统一序列长度，包含所有时间尺度
- 模型架构：多分支LSTM或分层LSTM

### 1.2 训练数据生成脚本

✅ **多时间尺度训练数据生成脚本** (`scripts/analysis/generate_multitimeframe_training_data.py`)
- 获取多时间尺度K线数据（1m, 5m, 1h, 1d）
- 计算各时间尺度的技术指标
- 对齐不同时间尺度的数据
- 生成46维多时间尺度特征

---

## 📊 二、特征设计（46维）

### 2.1 基础特征（1分钟）- 15维

1. `price_current` - 1分钟K线价格
2. `tick_price` - 真实Tick价格
3. `tick_price_change` - Tick价格变化
4. `tick_volatility` - Tick波动率
5. `tick_volume` - Tick成交量
6. `tick_count` - Tick数量
7. `tick_buy_sell_ratio` - Tick买卖比例
8. `atr_1m` - 1分钟ATR
9. `rsi_1m` - 1分钟RSI
10. `boll_upper_1m` - 1分钟布林带上轨
11. `boll_mid_1m` - 1分钟布林带中轨
12. `boll_lower_1m` - 1分钟布林带下轨
13. `boll_position_1m` - 1分钟布林带位置
14. `volatility_1m` - 1分钟波动率
15. `volume_1m` - 1分钟成交量

### 2.2 5分钟特征 - 8维

16. `price_5m` - 5分钟K线价格
17. `rsi_5m` - 5分钟RSI
18. `atr_5m` - 5分钟ATR
19. `boll_upper_5m` - 5分钟布林带上轨
20. `boll_mid_5m` - 5分钟布林带中轨
21. `boll_lower_5m` - 5分钟布林带下轨
22. `boll_position_5m` - 5分钟布林带位置
23. `volume_5m` - 5分钟成交量

### 2.3 1小时特征 - 9维

24. `price_1h` - 1小时K线价格
25. `rsi_1h` - 1小时RSI
26. `atr_1h` - 1小时ATR
27. `boll_upper_1h` - 1小时布林带上轨
28. `boll_mid_1h` - 1小时布林带中轨
29. `boll_lower_1h` - 1小时布林带下轨
30. `boll_position_1h` - 1小时布林带位置
31. `volume_1h` - 1小时成交量
32. `trend_1h` - 1小时趋势（0=下跌, 0.5=横盘, 1=上涨）

### 2.4 日线特征 - 11维

33. `price_1d` - 日线K线价格
34. `rsi_1d` - 日线RSI
35. `atr_1d` - 日线ATR
36. `boll_upper_1d` - 日线布林带上轨
37. `boll_mid_1d` - 日线布林带中轨
38. `boll_lower_1d` - 日线布林带下轨
39. `boll_position_1d` - 日线布林带位置
40. `volume_1d` - 日线成交量
41. `trend_1d` - 日线趋势（0=下跌, 0.5=横盘, 1=上涨）
42. `ma_5d` - 5日均线
43. `ma_10d` - 10日均线
44. `ma_20d` - 20日均线

### 2.5 网格参数 - 2维

45. `grid_lower` - 网格下轨
46. `grid_upper` - 网格上轨

---

## 🔧 三、数据对齐方法

### 3.1 时间对齐

**对齐规则**:
- **1分钟**: 基准时间点
- **5分钟**: 向下取整到5分钟（`time.floor('5min')`）
- **1小时**: 向下取整到小时（`time.floor('H')`）
- **日线**: 向下取整到日（`time.floor('D')`）

**示例**:
```
1分钟时间: 2026-01-23 15:47:00
  ↓
5分钟时间: 2026-01-23 15:45:00 (向下取整)
1小时时间: 2026-01-23 15:00:00 (向下取整)
日线时间: 2026-01-23 00:00:00 (向下取整)
```

### 3.2 指标对齐

**方法**:
- 对于每个1分钟时间点，找到对应的5分钟/1小时/日线索引
- 使用`get_indexer`方法找到最近的时间点
- 获取该时间点的技术指标值

---

## 📈 四、使用说明

### 4.1 生成多时间尺度训练数据

```bash
cd /home/cx/tigertrade
python scripts/analysis/generate_multitimeframe_training_data.py --days 30
```

**参数**:
- `--days`: 获取最近N天的数据（默认30天）
- `--output`: 输出文件路径（可选）

**输出**:
- 文件: `training_data_multitimeframe_YYYYMMDD_HHMMSS.csv`
- 特征: 46维（包含多时间尺度特征）

### 4.2 数据文件格式

**列**:
- 时间戳
- 1分钟特征（15维）
- 5分钟特征（8维）
- 1小时特征（9维）
- 日线特征（11维）
- 网格参数（2维）

---

## 🎯 五、下一步

### 5.1 修改特征提取

**文件**: `src/strategies/llm_strategy.py`

**需要修改**:
1. `prepare_features`方法：支持46维多时间尺度特征
2. 特征维度：从18维扩展到46维
3. 处理不同时间尺度的数据对齐

### 5.2 修改模型架构

**文件**: `src/strategies/llm_strategy.py`

**需要修改**:
1. `TradingLSTM`模型：支持46维输入
2. 考虑多分支LSTM或分层LSTM
3. 更新输入维度

### 5.3 修改序列构建

**文件**: `src/strategies/llm_strategy.py`

**需要修改**:
1. `prepare_sequence_features`方法
2. 支持多时间尺度的序列构建
3. 处理不同时间尺度的对齐

---

## ✅ 六、总结

### 6.1 核心改进

1. ✅ **多时间尺度数据**: 1分钟、5分钟、1小时、日线
2. ✅ **多时间尺度特征**: 46维特征（包含所有时间尺度）
3. ✅ **数据对齐**: 时间对齐和指标对齐
4. ✅ **训练数据生成**: 支持多时间尺度训练数据生成

### 6.2 优势

- ✅ **长期趋势**: 日线确定大方向
- ✅ **中期趋势**: 1小时确定中期方向
- ✅ **短期趋势**: 5分钟确定入场时机
- ✅ **精确入场**: 1分钟精确入场

### 6.3 状态

- ✅ 设计方案完成
- ✅ 训练数据生成脚本完成
- ⏳ 特征提取修改（待完成）
- ⏳ 模型架构修改（待完成）
- ⏳ 序列构建修改（待完成）

---

**状态**: 多时间尺度训练数据生成已完成，特征提取和模型架构修改待完成
