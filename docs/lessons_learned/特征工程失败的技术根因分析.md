# ç‰¹å¾å·¥ç¨‹å¤±è´¥çš„æŠ€æœ¯æ ¹å› åˆ†æ

**æ—¥æœŸ**: 2026-01-20  
**é—®é¢˜**: 12ä¸ªç‰¹å¾ä¸­10ä¸ªå…¨æ˜¯0æˆ–å¸¸é‡

---

## 1ï¸âƒ£ ä¸ºä»€ä¹ˆé€‰æ‹©æ‰‹å·¥ç‰¹å¾å·¥ç¨‹ï¼Ÿ

### å†å²èƒŒæ™¯

**é¡¹ç›®åˆå§‹è®¾è®¡æ€è·¯**:
```
åŸå§‹éœ€æ±‚ â†’ æœŸè´§äº¤æ˜“é¢„æµ‹
    â†“
å‚è€ƒä¼ ç»ŸæŠ€æœ¯åˆ†æ
    â†“
ä½¿ç”¨æˆç†Ÿçš„æŠ€æœ¯æŒ‡æ ‡
    â†“
é€‰æ‹©æ‰‹å·¥ç‰¹å¾å·¥ç¨‹
```

### é€‰æ‹©åŸå› 

1. **é¢†åŸŸçŸ¥è¯†å¯ç”¨**:
   - é‡‘èäº¤æ˜“æœ‰æˆç†Ÿçš„æŠ€æœ¯æŒ‡æ ‡ç†è®º
   - RSIã€MACDã€å¸ƒæ—å¸¦ç­‰è¢«å¹¿æ³›ä½¿ç”¨
   - æƒ³è¦åˆ©ç”¨è¿™äº›å·²éªŒè¯çš„æŒ‡æ ‡

2. **å¯è§£é‡Šæ€§éœ€æ±‚**:
   - äº¤æ˜“ç­–ç•¥éœ€è¦è§£é‡Šç»™ç”¨æˆ·
   - æŠ€æœ¯æŒ‡æ ‡æœ‰æ˜ç¡®å«ä¹‰
   - ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–

3. **è®¡ç®—æ•ˆç‡è€ƒè™‘**:
   - ç‰¹å¾æ•°é‡å°‘ï¼ˆ12ä¸ªï¼‰
   - è®¡ç®—å¿«é€Ÿ
   - æ¨¡å‹è¾ƒå°

4. **å‚è€ƒç°æœ‰ä»£ç **:
   - é¡¹ç›®ä¸­å·²æœ‰`tiger1.py`å®ç°äº†æŠ€æœ¯æŒ‡æ ‡
   - ç›´æ¥å¤ç”¨ç°æœ‰ä»£ç 

**è¿™ä¸ªé€‰æ‹©æœ¬èº«æ²¡æœ‰é—®é¢˜**ï¼Œé—®é¢˜åœ¨äºå®ç°ã€‚

---

## 2ï¸âƒ£ ç‰¹å¾å·¥ç¨‹ä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿ

### æŠ€æœ¯æ ¹å› åˆ†æ

#### æ ¹å› 1: æ•°æ®çª—å£é—®é¢˜ ğŸ”¥ğŸ”¥ğŸ”¥

**ä»£ç ä½ç½®**: `src/collect_large_dataset.py` ç¬¬242-282è¡Œ

```python
# ç¬¬242è¡Œ
window_5m = df_5m.iloc[max(0, i-window_size):i+1]

# ç¬¬273-278è¡Œ
if len(window_5m) > 1 and 'close' in window_5m.columns:
    price_change_1 = (price_current - window_5m['close'].iloc[-2]) / window_5m['close'].iloc[-2] * 100
    price_change_5 = ...
else:
    price_change_1 = 0  # â† æ€»æ˜¯æ‰§è¡Œè¿™é‡Œï¼
    price_change_5 = 0
```

**é—®é¢˜**:
1. `window_5m`å¯èƒ½é•¿åº¦â‰¤1
2. æˆ–è€…`window_5m`æ²¡æœ‰`'close'`åˆ—
3. å¯¼è‡´æ€»æ˜¯è¿›å…¥`else`åˆ†æ”¯ï¼Œè¿”å›0

**éªŒè¯**:
```
å®é™…æ•°æ®æ£€æŸ¥:
  price_change_1: 6970ä¸ªæ ·æœ¬ï¼Œå…¨æ˜¯0ï¼ˆ1ä¸ªå”¯ä¸€å€¼ï¼‰
  price_change_5: 6970ä¸ªæ ·æœ¬ï¼Œå…¨æ˜¯0ï¼ˆ1ä¸ªå”¯ä¸€å€¼ï¼‰
  volatility: 6970ä¸ªæ ·æœ¬ï¼Œå…¨æ˜¯0ï¼ˆ1ä¸ªå”¯ä¸€å€¼ï¼‰
```

#### æ ¹å› 2: æŠ€æœ¯æŒ‡æ ‡è®¡ç®—è¿”å›é»˜è®¤å€¼

**ä»£ç ä½ç½®**: `src/tiger1.py` ç¬¬339-420è¡Œ

ä¿®æ”¹åçš„`calculate_indicators`å‡½æ•°ä¸­ï¼Œæ·»åŠ äº†å¤§é‡çš„é˜²å¾¡æ€§æ£€æŸ¥ï¼š

```python
# ç¬¬343-356è¡Œ
if len(df_1m) == 0 or not all(col in df_1m.columns for col in required_cols):
    # è¿”å›é»˜è®¤å€¼
    return {
        "1m": {"close": 0, "high": 0, "low": 0, "open": 0, "volume": 0, "rsi": 50, "atr": 0},
        "5m": {"close": 0, "high": 0, "low": 0, "open": 0, "volume": 0, "rsi": 50, "atr": 0, ...}
    }
```

**é—®é¢˜**:
1. æ•°æ®ä¸è¶³æ—¶è¿”å›é»˜è®¤å€¼ï¼ˆè¿™æ˜¯å¯¹çš„ï¼‰
2. **ä½†é»˜è®¤å€¼æ˜¯å¸¸é‡**ï¼ˆrsi_1m=100, rsi_5m=50, atr=0, boll=0ï¼‰
3. å¦‚æœå¤§éƒ¨åˆ†è°ƒç”¨éƒ½è¿”å›é»˜è®¤å€¼ï¼Œç‰¹å¾å°±å…¨æ˜¯å¸¸é‡

**ä¸ºä»€ä¹ˆè¿”å›é»˜è®¤å€¼ï¼Ÿ**
- df_1mæˆ–df_5mé•¿åº¦ä¸è¶³
- æˆ–ç¼ºå°‘å¿…éœ€çš„åˆ—

#### æ ¹å› 3: Mockæ•°æ®é—®é¢˜ ğŸ”¥ğŸ”¥ğŸ”¥ **ã€æœ€ä¸¥é‡ã€‘**

**æ•°æ®æ¥æºæ£€æŸ¥**:
```
price_current: 6970ä¸ªå”¯ä¸€å€¼ âœ… (æœ‰å˜åŒ–)
volume_1m: 6970ä¸ªå”¯ä¸€å€¼ âœ… (æœ‰å˜åŒ–)
ä½†ï¼š
  æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡éƒ½æ˜¯å¸¸é‡ âŒ
```

**çœŸç›¸**:
```
API Manager çŠ¶æ€:
  æ˜¯å¦Mockæ¨¡å¼: False  â† é…ç½®è¯´"ä¸ç”¨Mock"
  Quote APIç±»å‹: NoneType  â† ä½†APIæœªåˆå§‹åŒ–ï¼
  Trade APIç±»å‹: NoneType
```

**å®é™…æ‰§è¡Œæµç¨‹**:
```
1. é…ç½®: DEMOè´¦æˆ·æ¨¡å¼
2. å°è¯•åˆå§‹åŒ–Tiger API â†’ âŒ å¤±è´¥ï¼ˆAPI = Noneï¼‰
3. è°ƒç”¨ get_kline_data('SIL2603', ...)
4. å¼‚å¸¸: 'NoneType' object has no attribute 'get_future_bars'
5. æ•è·å¼‚å¸¸ â†’ å›é€€åˆ° _generate_mock_data()
6. è¿”å›Mockæ•°æ®ï¼ˆä»·æ ¼90.5, 90.8, ...ï¼‰
7. ç”¨Mockæ•°æ®è®­ç»ƒæ¨¡å‹ï¼
8. å‡†ç¡®ç‡98%æ˜¯å› ä¸ºMockæ•°æ®å¤ªç®€å•
```

**Mockæ•°æ®ç‰¹å¾**:
```python
# collect_large_dataset.py ç¬¬189-193è¡Œ
base_price = 90.0
trend = np.linspace(0, 5, count)  # çº¿æ€§ä¸Šå‡
volatility = np.random.randn(count) * 0.5  # å°å¹…æ³¢åŠ¨
prices = base_price + trend + volatility
```

**ä½ çš„æ•°æ®å®Œå…¨ç¬¦åˆMockç‰¹å¾**:
- price_current: 90.5, 90.51, 90.52, ... âœ…
- ä»90å¼€å§‹ï¼Œçº¿æ€§ä¸Šå‡ âœ…
- å°å¹…éšæœºæ³¢åŠ¨ âœ…

**ä¸ºä»€ä¹ˆMockæ•°æ®å¯¼è‡´æŠ€æœ¯æŒ‡æ ‡å¤±æ•ˆï¼Ÿ**:
1. Mockæ•°æ®æ ¼å¼å¯èƒ½ä¸å®Œæ•´
2. åœ¨ç‰¹å¾è®¡ç®—æ—¶ä¸¢å¤±äº†OHLCä¿¡æ¯
3. åªä¿ç•™äº†`price_current`å’Œ`volume_1m`
4. å¯¼è‡´`window_5m`æ— æ³•æ­£ç¡®è®¡ç®—æŠ€æœ¯æŒ‡æ ‡

---

## 3ï¸âƒ£ å…·ä½“å¤±è´¥æµç¨‹

### æ•°æ®é‡‡é›†æµç¨‹

```
1. fetch_kline_data_with_retry('1min', count)
   â†“
2. è¿”å›Mockæ•°æ®ï¼ˆå¯èƒ½ï¼‰
   df_1m = {timestamp, close, ...}
   ä½†å¯èƒ½ç¼ºå°‘å®Œæ•´çš„OHLC
   â†“
3. calculate_indicators(df_1m, df_5m)
   â†“
4. æ•°æ®ä¸è¶³æˆ–åˆ—ç¼ºå¤±
   è¿”å›é»˜è®¤å€¼ {rsi: 50, atr: 0, ...}
   â†“
5. calculate_features_optimized()
   ä½¿ç”¨window_5mè®¡ç®—åŠ¨æ€ç‰¹å¾
   â†“
6. window_5mé•¿åº¦ä¸è¶³æˆ–æ— 'close'åˆ—
   price_change_1 = 0
   volatility = 0
   â†“
7. æœ€ç»ˆç»“æœï¼š10ä¸ªç‰¹å¾å…¨æ˜¯0æˆ–å¸¸é‡
```

### å…³é”®ä»£ç è·¯å¾„

**ç¬¬1æ­¥**: æ•°æ®è·å–
```python
# src/collect_large_dataset.py ç¬¬527-528è¡Œ
df_1m = self.fetch_kline_data_with_retry('1min', DataConfig.COUNT_1MIN)
df_5m = self.fetch_kline_data_with_retry('5min', DataConfig.COUNT_5MIN)
```

**é—®é¢˜**: å¦‚æœæ˜¯Mockæ•°æ®ï¼Œå¯èƒ½æ•°æ®ä¸å®Œæ•´

**ç¬¬2æ­¥**: ç‰¹å¾è®¡ç®—
```python
# ç¬¬539è¡Œ
df_features = self.calculate_features_optimized(df_5m, df_1m)
```

**ç¬¬3æ­¥**: å¾ªç¯ä¸­çš„çª—å£è·å–
```python
# ç¬¬242-243è¡Œ
window_5m = df_5m.iloc[max(0, i-window_size):i+1]
df_1m_slice = df_1m[df_1m.index <= timestamp_5m]
```

**é—®é¢˜**: 
- å¾ªç¯çš„æ¯ä¸€æ­¥ï¼Œwindowå¯èƒ½éƒ½å¤ªå°
- æˆ–è€…æ•°æ®æ ¼å¼ä¸å¯¹

**ç¬¬4æ­¥**: è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
```python
# ç¬¬251è¡Œ
inds = calculate_indicators(window_1m, window_5m)
```

**è¿”å›**: é»˜è®¤å€¼ï¼ˆå¦‚æœæ•°æ®ä¸è¶³ï¼‰

**ç¬¬5æ­¥**: è®¡ç®—åŠ¨æ€ç‰¹å¾
```python
# ç¬¬273-281è¡Œ
if len(window_5m) > 1 and 'close' in window_5m.columns:
    price_change_1 = ...
else:
    price_change_1 = 0  # â† æ€»æ˜¯è¿™é‡Œ
```

---

## 4ï¸âƒ£ å¦‚ä½•é¿å…è¿™ç±»é—®é¢˜ï¼Ÿ

### ç«‹å³æªæ–½ï¼ˆæŠ€æœ¯å±‚é¢ï¼‰

#### æªæ–½1: æ·»åŠ æ•°æ®éªŒè¯

```python
def validate_dataframe(df, required_cols, min_rows, name="DataFrame"):
    """éªŒè¯DataFrameè´¨é‡"""
    errors = []
    
    # æ£€æŸ¥è¡Œæ•°
    if len(df) < min_rows:
        errors.append(f"{name}: è¡Œæ•°ä¸è¶³ï¼ˆ{len(df)} < {min_rows}ï¼‰")
    
    # æ£€æŸ¥åˆ—
    missing = set(required_cols) - set(df.columns)
    if missing:
        errors.append(f"{name}: ç¼ºå¤±åˆ— {missing}")
    
    # æ£€æŸ¥ç©ºå€¼
    if df[required_cols].isna().any().any():
        errors.append(f"{name}: å­˜åœ¨ç©ºå€¼")
    
    # æ£€æŸ¥å¸¸é‡åˆ—
    for col in required_cols:
        if df[col].nunique() == 1:
            errors.append(f"{name}.{col}: å¸¸é‡åˆ—ï¼ˆå€¼={df[col].iloc[0]}ï¼‰")
    
    if errors:
        raise ValueError("\n".join(errors))
    
    return True
```

**ä½¿ç”¨**:
```python
# åœ¨æ•°æ®è·å–åç«‹å³éªŒè¯
df_1m = fetch_kline_data(...)
validate_dataframe(
    df_1m, 
    required_cols=['open','high','low','close','volume'],
    min_rows=50,
    name="1åˆ†é’ŸKçº¿"
)
```

#### æªæ–½2: ç‰¹å¾è®¡ç®—åéªŒè¯

```python
def validate_features(features_dict):
    """éªŒè¯è®¡ç®—å‡ºçš„ç‰¹å¾"""
    issues = []
    
    for feature_name, value in features_dict.items():
        # è·³è¿‡éç‰¹å¾å­—æ®µ
        if feature_name in ['timestamp', 'price_current']:
            continue
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å€¼
        if not isinstance(value, (int, float)):
            issues.append(f"{feature_name}: éæ•°å€¼ç±»å‹")
            continue
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å€¼ï¼ˆå¯èƒ½è¡¨ç¤ºè®¡ç®—å¤±è´¥ï¼‰
        if value == 0 and feature_name in ['price_change_1', 'volatility']:
            issues.append(f"{feature_name}: å¯ç–‘çš„0å€¼")
    
    if len(issues) > len(features_dict) * 0.5:  # è¶…è¿‡50%æœ‰é—®é¢˜
        raise ValueError(f"ç‰¹å¾è®¡ç®—å¤±è´¥:\n" + "\n".join(issues))
    
    return True
```

#### æªæ–½3: æ•°æ®æºéªŒè¯

```python
def verify_data_source():
    """éªŒè¯æ•°æ®æºæ˜¯çœŸå®APIè¿˜æ˜¯Mock"""
    df = get_kline_data('SIL2603', '1min', 100)
    
    # æ£€æŸ¥ä»·æ ¼æ³¢åŠ¨
    if df['close'].std() == 0:
        raise ValueError("âš ï¸ æ•°æ®æºå¼‚å¸¸ï¼šä»·æ ¼æ— æ³¢åŠ¨ï¼Œå¯èƒ½æ˜¯Mockæ•°æ®")
    
    # æ£€æŸ¥åˆ—å®Œæ•´æ€§
    required = ['open', 'high', 'low', 'close', 'volume']
    missing = set(required) - set(df.columns)
    if missing:
        raise ValueError(f"âš ï¸ æ•°æ®æºå¼‚å¸¸ï¼šç¼ºå°‘åˆ— {missing}")
    
    # æ£€æŸ¥OHLCå…³ç³»
    if not ((df['high'] >= df['close']).all() and 
            (df['low'] <= df['close']).all()):
        raise ValueError("âš ï¸ æ•°æ®æºå¼‚å¸¸ï¼šOHLCå…³ç³»ä¸åˆç†")
    
    print("âœ… æ•°æ®æºéªŒè¯é€šè¿‡")
    return True
```

### æµç¨‹å±‚é¢æ”¹è¿›

#### æ”¹è¿›1: å¼€å‘é˜¶æ®µæ£€æŸ¥æ¸…å•

åœ¨**æ•°æ®é‡‡é›†å**:
```
[ ] æ£€æŸ¥æ•°æ®è¡Œæ•°
[ ] æ£€æŸ¥æ‰€æœ‰å¿…éœ€åˆ—æ˜¯å¦å­˜åœ¨
[ ] æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±å€¼
[ ] æ£€æŸ¥æ˜¯å¦æœ‰å¸¸é‡åˆ—
[ ] æ‰“å°æ•°æ®ç»Ÿè®¡ä¿¡æ¯ï¼ˆdescribe()ï¼‰
[ ] å¯è§†åŒ–æ£€æŸ¥ï¼ˆç»˜åˆ¶ä»·æ ¼æ›²çº¿ï¼‰
```

åœ¨**ç‰¹å¾å·¥ç¨‹å**:
```
[ ] æ£€æŸ¥æ¯ä¸ªç‰¹å¾çš„å”¯ä¸€å€¼æ•°é‡
[ ] è¯†åˆ«å¸¸é‡ç‰¹å¾ï¼ˆstd=0ï¼‰
[ ] æ‰“å°ç‰¹å¾ç»Ÿè®¡ï¼ˆå‡å€¼ã€æ ‡å‡†å·®ã€æœ€å°å€¼ã€æœ€å¤§å€¼ï¼‰
[ ] æ£€æŸ¥ç‰¹å¾ä¸æ ‡ç­¾çš„ç›¸å…³æ€§
[ ] å¯è§†åŒ–ç‰¹å¾åˆ†å¸ƒ
```

#### æ”¹è¿›2: å•å…ƒæµ‹è¯•

```python
def test_calculate_indicators():
    """æµ‹è¯•æŠ€æœ¯æŒ‡æ ‡è®¡ç®—"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    df_1m = pd.DataFrame({
        'open': [100, 101, 102, 103, 104],
        'high': [101, 102, 103, 104, 105],
        'low': [99, 100, 101, 102, 103],
        'close': [100.5, 101.5, 102.5, 103.5, 104.5],
        'volume': [1000, 1100, 1200, 1300, 1400]
    })
    
    df_5m = df_1m.copy()  # ç®€åŒ–æµ‹è¯•
    
    # è°ƒç”¨å‡½æ•°
    result = calculate_indicators(df_1m, df_5m)
    
    # éªŒè¯
    assert result['1m']['close'] > 0, "1m closeåº”è¯¥>0"
    assert result['5m']['close'] > 0, "5m closeåº”è¯¥>0"
    assert 0 < result['5m']['rsi'] < 100, "RSIåº”è¯¥åœ¨0-100ä¹‹é—´"
    assert result['5m']['atr'] >= 0, "ATRåº”è¯¥>=0"
    
    print("âœ… æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æµ‹è¯•é€šè¿‡")

def test_feature_calculation():
    """æµ‹è¯•ç‰¹å¾è®¡ç®—"""
    # ... ç±»ä¼¼çš„æµ‹è¯•
    pass
```

#### æ”¹è¿›3: æ•°æ®é‡‡é›†æ—¶çš„å®æ—¶ç›‘æ§

```python
def collect_with_monitoring():
    """å¸¦ç›‘æ§çš„æ•°æ®é‡‡é›†"""
    features_list = []
    
    for i in range(data_count):
        features = calculate_features(...)
        features_list.append(features)
        
        # æ¯100æ¡æ£€æŸ¥ä¸€æ¬¡
        if i % 100 == 0 and i > 0:
            df_temp = pd.DataFrame(features_list)
            
            # æ£€æŸ¥å¸¸é‡ç‰¹å¾
            const_features = []
            for col in df_temp.columns:
                if df_temp[col].nunique() == 1:
                    const_features.append(col)
            
            if const_features:
                print(f"âš ï¸ è­¦å‘Šï¼šå‘ç°å¸¸é‡ç‰¹å¾ {const_features}")
                print(f"  æ ·æœ¬ {i}: {features}")
                # å¯ä»¥é€‰æ‹©ä¸­æ–­æˆ–ç»§ç»­
    
    return pd.DataFrame(features_list)
```

### æ¶æ„å±‚é¢æ”¹è¿›

#### æ”¹è¿›1: åˆ†ç¦»å…³æ³¨ç‚¹

```python
# ä¸å¥½çš„è®¾è®¡ï¼ˆæ··åœ¨ä¸€èµ·ï¼‰
def collect_and_process():
    data = fetch_data()
    features = calculate_features(data)  # å¦‚æœå¤±è´¥ï¼Œéš¾ä»¥å®šä½
    return features

# å¥½çš„è®¾è®¡ï¼ˆåˆ†ç¦»ï¼‰
def collect_data():
    """åªè´Ÿè´£æ•°æ®é‡‡é›†"""
    data = fetch_data()
    validate_raw_data(data)  # â† éªŒè¯
    return data

def calculate_features(data):
    """åªè´Ÿè´£ç‰¹å¾è®¡ç®—"""
    features = compute(data)
    validate_features(features)  # â† éªŒè¯
    return features

def pipeline():
    """ç»„åˆ"""
    data = collect_data()
    features = calculate_features(data)
    return features
```

#### æ”¹è¿›2: å¤±è´¥å¿«é€ŸåŸåˆ™

```python
# ä¸å¥½çš„è®¾è®¡ï¼ˆé™é»˜å¤±è´¥ï¼‰
def calculate_feature(window):
    if len(window) < 2:
        return 0  # â† é™é»˜è¿”å›é»˜è®¤å€¼
    return compute(window)

# å¥½çš„è®¾è®¡ï¼ˆæ˜ç¡®å¤±è´¥ï¼‰
def calculate_feature(window):
    if len(window) < 2:
        raise ValueError(f"çª—å£é•¿åº¦ä¸è¶³: {len(window)} < 2")
    return compute(window)

# æˆ–è€…å¸¦æ—¥å¿—
def calculate_feature(window, logger):
    if len(window) < 2:
        logger.warning(f"çª—å£é•¿åº¦ä¸è¶³: {len(window)}, è¿”å›é»˜è®¤å€¼0")
        return 0
    return compute(window)
```

---

## 5ï¸âƒ£ æœ¬æ¡ˆä¾‹çš„å…·ä½“ä¿®å¤æ­¥éª¤

### Step 1: ç¡®è®¤æ•°æ®æºï¼ˆæœ€å…³é”®ï¼ï¼‰

```bash
# æ£€æŸ¥APIæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
cd /home/cx/tigertrade
python3 -c "
import sys
sys.path.insert(0, 'src')
from api_adapter import api_manager

print('API Manager çŠ¶æ€:')
print(f'  Mockæ¨¡å¼: {api_manager.is_mock_mode}')
print(f'  Quote API: {api_manager.quote_api}')
print(f'  Trade API: {api_manager.trade_api}')

if api_manager.quote_api is None:
    print('\nâŒ è‡´å‘½é—®é¢˜ï¼šAPIæœªåˆå§‹åŒ–ï¼')
    print('   å®é™…è¿è¡Œæ—¶ä¼šå›é€€åˆ°Mockæ•°æ®ï¼')
    print('   å¿…é¡»å…ˆä¿®å¤APIåˆå§‹åŒ–é—®é¢˜ï¼')
else:
    print('\nâœ… APIå·²åˆå§‹åŒ–')
"

# æµ‹è¯•è·å–çœŸå®æ•°æ®
python3 -c "
from src.tiger1 import get_kline_data
df = get_kline_data('SIL2603', '1min', 100)

# æ£€æŸ¥æ˜¯å¦Mockæ•°æ®
if len(df) > 0:
    first_price = df['close'].iloc[0]
    avg_price = df['close'].mean()
    
    # Mockæ•°æ®ç‰¹å¾ï¼šä»·æ ¼ä»90å¼€å§‹ï¼Œå¹³å‡çº¦92.5
    if abs(first_price - 90.0) < 1 or abs(avg_price - 92.5) < 2:
        print('âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ°Mockæ•°æ®ç‰¹å¾ï¼')
        print(f'  é¦–ä»·: {first_price:.2f} (Mockåº”è¯¥â‰ˆ90)')
        print(f'  å‡ä»·: {avg_price:.2f} (Mockåº”è¯¥â‰ˆ92.5)')
        print('  è¿™ä¸æ˜¯çœŸå®å¸‚åœºæ•°æ®ï¼')
    else:
        print('âœ… æ•°æ®ç‰¹å¾æ­£å¸¸ï¼Œå¯èƒ½æ˜¯çœŸå®æ•°æ®')
        print(f'  é¦–ä»·: {first_price:.2f}')
        print(f'  å‡ä»·: {avg_price:.2f}')
"
```

**å¦‚æœæ£€æµ‹åˆ°Mockæ•°æ®ï¼Œå¿…é¡»å…ˆä¿®å¤APIåˆå§‹åŒ–ï¼**

### Step 2: ä¿®å¤calculate_features_optimized

```python
# åœ¨å¾ªç¯ä¸­æ·»åŠ éªŒè¯
for i in range(min_len, len(df_5m)):
    window_5m = df_5m.iloc[max(0, i-window_size):i+1]
    
    # æ·»åŠ éªŒè¯
    if len(window_5m) < 2:
        print(f"âš ï¸ æ ·æœ¬{i}: window_5mé•¿åº¦ä¸è¶³ ({len(window_5m)})")
        continue  # è·³è¿‡è€Œä¸æ˜¯è¿”å›0
    
    if 'close' not in window_5m.columns:
        raise ValueError(f"æ ·æœ¬{i}: window_5mç¼ºå°‘'close'åˆ—")
    
    # ç»§ç»­è®¡ç®—...
```

### Step 3: æ·»åŠ é‡‡é›†åéªŒè¯

```python
# åœ¨save_datasetsä¹‹å‰
def validate_collected_data(df):
    """éªŒè¯é‡‡é›†çš„æ•°æ®è´¨é‡"""
    feature_cols = ['price_change_1', 'price_change_5', 'volatility', 
                   'rsi_1m', 'rsi_5m', 'atr', 'boll_upper']
    
    for col in feature_cols:
        unique_count = df[col].nunique()
        if unique_count == 1:
            raise ValueError(
                f"âŒ ç‰¹å¾ {col} æ˜¯å¸¸é‡ï¼\n"
                f"   å”¯ä¸€å€¼: {df[col].unique()}\n"
                f"   è¿™è¡¨æ˜ç‰¹å¾è®¡ç®—å¤±è´¥ï¼"
            )
    
    print("âœ… æ•°æ®è´¨é‡éªŒè¯é€šè¿‡")
    return True

# ä½¿ç”¨
df_labeled = generate_labels(df_features)
validate_collected_data(df_labeled)  # â† æ·»åŠ è¿™è¡Œ
train, val, test = split_dataset(df_labeled)
```

---

## 6ï¸âƒ£ æ€»ç»“

### é—®é¢˜1: ä¸ºä»€ä¹ˆé€‰æ‹©æ‰‹å·¥ç‰¹å¾å·¥ç¨‹ï¼Ÿ

**ç­”æ¡ˆ**:
- åˆ©ç”¨é‡‘èé¢†åŸŸçš„æˆç†ŸæŠ€æœ¯æŒ‡æ ‡
- éœ€è¦å¯è§£é‡Šæ€§
- å‚è€ƒç°æœ‰ä»£ç 
- **è¿™ä¸ªé€‰æ‹©æœ¬èº«åˆç†**

### é—®é¢˜2: ä¸ºä»€ä¹ˆç‰¹å¾å·¥ç¨‹å¤±è´¥ï¼Ÿ

**æŠ€æœ¯æ ¹å› **:
1. **æ•°æ®çª—å£é—®é¢˜**: `window_5m`é•¿åº¦ä¸è¶³æˆ–ç¼ºå°‘åˆ—
2. **é»˜è®¤å€¼è¿”å›**: `calculate_indicators`é‡åˆ°é—®é¢˜è¿”å›å¸¸é‡
3. **Mockæ•°æ®**: å¯èƒ½ä½¿ç”¨äº†ä¸å®Œæ•´çš„æ¨¡æ‹Ÿæ•°æ®

**æµç¨‹æ ¹å› **:
1. ç¼ºå°‘æ•°æ®éªŒè¯
2. ç¼ºå°‘ç‰¹å¾éªŒè¯
3. é™é»˜å¤±è´¥ï¼ˆè¿”å›0è€Œä¸æ˜¯æŠ¥é”™ï¼‰
4. æ²¡æœ‰å•å…ƒæµ‹è¯•
5. æ²¡æœ‰å®æ—¶ç›‘æ§

### é—®é¢˜3: å¦‚ä½•é¿å…ï¼Ÿ

**æŠ€æœ¯æªæ–½**:
1. âœ… æ•°æ®æºéªŒè¯ï¼ˆçœŸå®API vs Mockï¼‰
2. âœ… è¾“å…¥æ•°æ®éªŒè¯ï¼ˆè¡Œæ•°ã€åˆ—ã€ç©ºå€¼ã€å¸¸é‡ï¼‰
3. âœ… è¾“å‡ºç‰¹å¾éªŒè¯ï¼ˆå”¯ä¸€å€¼ã€ç»Ÿè®¡åˆ†å¸ƒï¼‰
4. âœ… å¤±è´¥å¿«é€ŸåŸåˆ™ï¼ˆæ˜ç¡®æŠ¥é”™è€Œä¸æ˜¯é™é»˜ï¼‰
5. âœ… å•å…ƒæµ‹è¯•

**æµç¨‹æªæ–½**:
1. âœ… å¼€å‘æ£€æŸ¥æ¸…å•
2. âœ… åˆ†ç¦»å…³æ³¨ç‚¹ï¼ˆé‡‡é›†/è®¡ç®—/éªŒè¯åˆ†ç¦»ï¼‰
3. âœ… å®æ—¶ç›‘æ§ï¼ˆæ¯Næ¡æ£€æŸ¥ä¸€æ¬¡ï¼‰
4. âœ… å¯è§†åŒ–éªŒè¯

---

**æ ¸å¿ƒæ•™è®­**: 

**ä¸è¦ç›²ç›®ä¿¡ä»»ä»£ç **ã€‚åœ¨æ•°æ®å¤„ç†çš„æ¯ä¸ªç¯èŠ‚éƒ½è¦ï¼š
1. **éªŒè¯è¾“å…¥**
2. **éªŒè¯è¾“å‡º**  
3. **æ˜ç¡®å¤±è´¥**ï¼ˆè€Œä¸æ˜¯é™é»˜è¿”å›é»˜è®¤å€¼ï¼‰
4. **æŒç»­ç›‘æ§**
