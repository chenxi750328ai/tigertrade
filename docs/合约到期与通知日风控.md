# 合约到期与通知日风控

风控算法需考虑**合约时间限制**：在通知日/到期日附近提示风险并考虑展期，避免持仓进入交割。

## 一、API 能否获取到期信息

- **能**：`get_future_brief_info(symbol)` 会调用行情接口 `get_future_brief`，返回中若包含 `expire_date`（或 API 文档中的到期日字段），则**优先使用 API 的到期日**。
- **不能或失败时**：使用本地 **FuturesContractManager** 按合约代码（如 SIL2605）解析到期月，并按该月 25 日近似为到期日（COMEX 期货通常在该月第三周附近到期，25 日为保守近似）。
- **配置**：`tiger1.py` 中的 `FUTURE_EXPIRE_DATE` 为兜底默认值；**API 能获取时以 API 为准**。

## 二、通知日到期时的风控行为

在 `check_risk_control` 中已接入合约时间限制：

1. **到期日来源**：每次检查时通过 `get_contract_expiry_risk()` 获取当前合约的到期日（API 优先，否则合约代码推算）。
2. **通知期**：距到期 **≤ NOTICE_DAYS（默认 5 天）** 时视为进入通知期，打日志 **提示风险并建议考虑展期**：
   - 日志示例：`[DFX] 合约通知期风险: 合约即将到期（yyyy-mm-dd，剩余 N 天），请注意通知日风险，考虑展期至下一合约。`
3. **禁止新开多单**：距到期 **≤ EXPIRY_BLOCK_DAYS（默认 2 天）** 时，**禁止新开多单**，避免进入交割；日志中再次提示考虑展期。
4. **已到期**：若 `days_to_expiry ≤ 0`，提示「合约已到期，请切换至下一合约并考虑展期」。

## 三、参数与代码位置

| 参数 | 默认值 | 环境变量 | 说明 |
|------|--------|----------|------|
| `NOTICE_DAYS` | 5 | `NOTICE_DAYS` | 距到期此天数内视为通知期，仅提示风险与展期 |
| `EXPIRY_BLOCK_DAYS` | 2 | `EXPIRY_BLOCK_DAYS` | 距到期不足此天数时禁止新开多单 |

- **实现**：`src/tiger1.py` 中 `get_contract_expiry_risk()`、`check_risk_control()`。
- **通知日/到期日当天**：当剩余天数 ≤ 1 时，除上述逻辑外会再打一条 **【通知日/到期日风险】** 醒目日志，提示「请立即考虑展期或平仓」。
- **展期**：当前为**提示与禁止新开仓**，实际换合约（切换 `FUTURE_SYMBOL` / 平旧仓开新仓）需在策略或运维流程中执行；风控只负责「到期前提醒 + 临到期禁止新多单」。

## 四、与启动时风控的衔接

- 启动时持仓同步见 [启动时持仓同步与风控](启动时持仓同步与风控.md)。
- 若当前交易合约即将到期，建议在切换至下一合约后再次同步持仓，并确认新合约的 `FUTURE_SYMBOL` 与配置一致。
