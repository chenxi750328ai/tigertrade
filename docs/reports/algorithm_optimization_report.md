# 算法优化和收益率分析报告

生成时间: 2026-02-11T12:04:16.253070

**算法版本**: 2.0（重大变更见 [algorithm_versions.md](../algorithm_versions.md)）

## 效果数据来源（本次例行用了啥）

- **DEMO 实盘收益率须以老虎后台为准**，未核对上的数据不得作为实盘收益率。见 docs/DEMO实盘收益率_定义与数据来源.md
- **日志与老虎后台不一致说明**：日志含模拟单与失败单，只有 mode=real 且 status=success 的才在老虎后台；核对规则为「DEMO 的单在老虎都能查到即通过」，老虎可更多（含人工单）。
- 收益率/胜率：API 历史订单 暂无或未解析（原因与后台订单来源见 [为何报告里后台核对数据为空_说明](../为何报告里后台核对数据为空_说明.md)）
- DEMO：多日志汇总（同次运行，四策略共用统计；订单成功、止损止盈等）
- 回测：grid/BOLL 为参数网格回测，moe_transformer/lstm 为 test.csv 信号回测（scripts/backtest_model_strategies.py），产出 num_trades/return_pct/win_rate

**数据来源与指标含义**（return_pct、num_trades、win_rate、demo_sl_tp_log、demo_execute_buy_calls 等）见 [每日例行_效果数据说明](../每日例行_效果数据说明.md)、[需求分析和Feature测试设计](../需求分析和Feature测试设计.md) 附录。

## 本报告空项根因说明

以下为空时，**原因均写明**，便于追根问底、不忽悠。

- **实际收益率（老虎后台核对）为空** → 原因：api_manager 未初始化或 trade_api 无 get_orders；openapicfg_dem: 老虎 API 返回 0 笔订单（该账户/合约可能无订单或未授权）
- **推算收益率（未核对）为空** → 原因：order_log 仅有主单/止损单/止盈单的**提交记录**，无每笔「最后是止损还是止盈」及**平仓价**，无法在无老虎成交或日志平仓记录的前提下做可信推算；若将来实现须与老虎对账验证。详见 [回溯_执行失败为何出现收益率与推算收益率](../回溯_执行失败为何出现收益率与推算收益率.md)。

## 日志与老虎后台差异说明（必读）

系统日志（order_log、DEMO 运行日志）记录的是**本进程的每次下单尝试与结果**，包含：模拟单（未发老虎）、真实但被拒单、真实且成功单。**只有「mode=real 且 status=success」的才会在老虎后台出现**，故日志条数/内容与老虎后台不一致是正常现象。DEMO 实盘收益率须以老虎后台为准；核对规则：**DEMO 运行的单在老虎后台都能查到就算通过**，老虎后台可以更多（含人工单）。详见 [DEMO实盘收益率_定义与数据来源](../DEMO实盘收益率_定义与数据来源.md)、[order_log_analysis](order_log_analysis.md)。

**执行失败（含 API 被拒）**：发了 API 被拒属于**执行失败**，状态页与订单日志分析中会体现「成功 N 笔、失败（含API被拒）M 笔」。**若多为失败则不应有实盘收益率**；今日收益率仅来自老虎后台成交，执行失败时无实盘收益。

## 实盘收益率：实际（老虎核对）与推算（未核对）

| 项目 | 值 | 说明 |
| --- | --- | --- |
| **实际收益率（老虎后台核对）** | —（原因见上方「本报告空项根因说明」） | 仅老虎后台订单/成交计算；未拉取或未核对时见上方空项根因。 |
| **推算收益率（未核对）** | —（原因见上方「本报告空项根因说明」） | 未与老虎核对时的推算值；无推算时见上方空项根因。 |

## 回测与实盘差异说明（必读）

### 回测和实盘应一致才有参考意义

**原则**：回测与实盘**仅允许数据来源不同**（回测用历史切片，实盘用实时行情）；**策略逻辑、运行过程（调用频率、开平仓规则）必须完全一致**，否则回测没有参考意义。

**回测数据量**：历史区间可以很长，回测可用的数据量、可产生的交易次数通常**不少于**实盘某一段的运行；若出现回测笔数远少于实盘，说明回测与实盘**不一致**（例如回测用的是另一套逻辑、或调用方式不同），需要对齐，而不是用「数据粒度」「时间跨度」等借口。

### 回测是否做多+做空（双向）？

**设计**：算法为**双向交易**，可做多与做空。
- **grid/boll**：`parameter_grid_search` 回测内已含 long 与 short 信号，**符合双向设计**。
- **moe_transformer/lstm**：`backtest_model_strategies.py` 已按**双向**实现：信号 1=做多/平空，信号 2=做空/平多，**符合双向设计**。

### 为何 grid/boll 回测有时 1 笔有时 48 笔？

**原因**：当前「最优参数」的选取规则是**优先选 num_trades≥2 的组合，再按收益排序**（见 `scripts/parameter_grid_search.py`）。之前按纯收益排序时，最优的那组参数只产生 1 笔交易；改规则后，展示的是「至少 2 笔里收益最高」的那组，所以变成 48 笔。若需改回「只按收益排序」可改回排序逻辑。

### 回测与实盘代码是否一致？

**grid/boll**：当前回测用的是 **parameter_grid_search**（RSI + 均线 参数网格），与实盘 **grid_trading_strategy_pro1**（网格上下轨 + ATR + RSI + 反弹/量能）**不是同一套逻辑**。要回测有参考意义，需改代码：让回测调用与实盘同一套规则，或直接使用实盘同逻辑回测入口 **`src.tiger1.backtest_grid_trading_strategy_pro1`**。

**moe_transformer/lstm**：回测用 test.csv 的 label/衍生信号模拟多空开平，与实盘模型预测输出是否一致取决于训练与推理是否同源。

## 回测明细（实际成交笔数、总收益、单笔平均、单笔TOP）

| 策略 | 成交笔数 | 总收益率% | 单笔平均% | 单笔TOP% | 胜率% |
| --- | --- | --- | --- | --- | --- |
| moe_transformer | 33.0 | 2.46 | 0.01 | 0.03 | 100.0 |
| lstm | 33.0 | 2.46 | 0.01 | 0.03 | 100.0 |
| grid | 0.0 | 0.0 | 0.0 | 0.0 | 0.0 |
| boll | 11.0 | 7.74 | 0.7 | 7.09 | 36.36 |

说明：**成交笔数**=实际完成的开平仓次数；**总收益率**= (期末资金−10万)/10万×100；**单笔平均**= 总收益/笔数（每笔占初始资金%）；**单笔TOP**= 单笔最大收益占初始资金%。这样看到「1 笔」即表示本轮回测只成交 1 笔，不是算法只开一仓。

## 指标说明（含义与计算方式）

| 指标 | 含义 | 计算方式 / 说明 |
| --- | --- | --- |
| return_pct | 回测收益率 | (期末资金−10万)/10万×100。回测表。 |
| win_rate | 回测/实盘胜率 | 回测表=盈利笔数/完成笔数×100；实盘表=仅 API 历史订单解析。 |
| num_trades | 回测笔数 | 完成的开平仓次数。 |
| yield_verified | 实际收益率（老虎核对） | 老虎后台订单/成交计算；未核对时为 —。 |
| yield_estimated | 推算收益率（未核对） | 未核对时的推算值。 |
| demo_* | DEMO 日志统计 | 主单成功、止损止盈条数等为日志匹配次数，非老虎后台。详见 [每日例行_效果数据说明](../每日例行_效果数据说明.md)。 |

## 优化后的参数

### grid

```json
{
  "source": "backtest_grid_trading_strategy_pro1",
  "same_code_as_live": true
}
```

### boll

```json
{
  "rsi_buy": 30,
  "rsi_sell": 60,
  "ma_short": 10,
  "ma_long": 20,
  "use_or": true
}
```

**回测胜率说明**：本次回测部分策略成交笔数≤1，此时胜率 100% 或 0% 无参考意义，**非算法假定 100% 胜率**；回测逻辑会既有止损也有止盈，多笔时胜率会正常。详见 [回溯_执行失败为何出现收益率与推算收益率](../回溯_执行失败为何出现收益率与推算收益率.md)。

