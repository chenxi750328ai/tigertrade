# QA 深层次问题与用户视角验收测试

**评审角色**：陈正孤（项目 QA）  
**补充日期**：2026-02-08  
**配套**：与《QA评审报告_Tiger项目_陈正孤.md》一并提交陈正霞处理

---

## 一、深层次问题（追加）

以下问题在首轮评审基础上，从**失败模式、数据一致性、可观测性、运维负担、安全与合规**等维度深挖。

### 1. 失败模式与恢复

| 编号 | 严重程度 | 问题描述 | 建议 |
|------|----------|----------|------|
| **DP1** | 高 | **API 部分失败无幂等/重试边界**：若下单请求超时或返回非 2xx 但 broker 侧已成交，当前是否有「查询订单再决定是否重试」的防重复逻辑？重复下单会导致重复持仓。 | 在订单执行路径明确：超时/网络错误后的重试策略（如先 query order 再决定 submit）、幂等键或服务端去重策略，并写入订单执行流程说明。 |
| **DP2** | 中 | **DEMO 进程崩溃后持仓与止损/止盈单状态未在文档中定义**：若 20h DEMO 运行到第 10 小时崩溃，已有持仓的止损/止盈单是否仍挂在 broker 侧、重启后是否需「持仓同步 + 补挂 SL/TP」的 SOP？ | 在 DEMO 运行状态查询指南或启动流程中增加「崩溃/重启后：持仓同步、止损止盈单核对与补挂」的步骤与检查清单。 |
| **DP3** | 中 | **无熔断/降级开关**：当 API 错误率持续升高时，是否有自动暂停下单、仅读行情或降级为模拟的开关？若依赖人工发现再停，实盘风险较大。 | 设计「连续 N 次失败则暂停下单」「配置项 PAUSE_TRADING_ON_ERROR_RATE」等，并在需求/设计中补充可运维性。 |

### 2. 数据一致性与时间语义

| 编号 | 严重程度 | 问题描述 | 建议 |
|------|----------|----------|------|
| **DP4** | 中 | **多数据源时间戳不一致**：K 线、Tick、订单回报可能来自不同 API 或不同时刻，若未统一使用「数据时间」或「事件时间」，策略与风控可能基于不一致的 snapshot 做决策。 | 在数据提供层明确「当前 bar 的 close 是否已收盘」「订单回报与 K 线时间对齐策略」，并在回测/实盘对比文档中说明。 |
| **DP5** | 低 | **报告「今日」依赖运行环境时区**：若例行在 UTC 0 点跑，与「北京时间当日」可能差一天，影响「当日亏损限制」「今日收益率」等语义。 | 报告与例行脚本统一使用显式「数据日」（如北京时间日期）而非「运行时刻的本地日期」。 |

### 3. 可观测性与可审计

| 编号 | 严重程度 | 问题描述 | 建议 |
|------|----------|----------|------|
| **DP6** | 中 | **每笔订单的「决策依据」未结构化落盘**：order_log 有订单结果，但「为何在这一刻下单」（信号、置信度、风控通过原因）若只散落在日志文本中，事后审计与复现困难。 | 在 order_log 或独立 decision_log 中增加结构化字段：signal_reason、confidence、risk_check_result、timestamp，便于回溯与合规。 |
| **DP7** | 低 | **20h 稳定性结果与 CI/状态页未打通**：若 20h 由独立任务跑，结果（通过/失败、错误率）是否写入状态页或 CI 可读的 artifact，便于「发布前必须通过 20h」的关卡。 | 将 stability_report 或 summary 写入固定路径/artifact，CI 或状态页可链接或展示。 |

### 4. 安全与配置

| 编号 | 严重程度 | 问题描述 | 建议 |
|------|----------|----------|------|
| **DP8** | 中 | **配置无效时静默回退到 Mock 的风险**：历史曾出现 openapicfg_dem 为占位符时仍「初始化成功」但用 Mock 数据，易误导为实盘已就绪。 | 启动时显式校验：若为 DEMO/实盘模式且配置为占位符或缺失，**直接失败并报错**，不静默回退；Mock 模式需显式开关。 |
| **DP9** | 低 | **私密文档说明完善但需持续执行**：.gitignore 与私密文档说明已覆盖 API 配置、账单等，需在 onboarding 与例行中强调「提交前检查」，避免误提交。 | 在 PR 模板或 pre-commit 中增加「敏感文件检查」提示或脚本。 |

### 5. 架构与演进

| 编号 | 严重程度 | 问题描述 | 建议 |
|------|----------|----------|------|
| **DP10** | 低 | **回测与实盘共用代码路径的回归风险**：若只改实盘路径未同步回测，会再次出现「回测与实盘不一致」；若共用一个函数，改动时需双路径验证。 | 在开发规范中约定：凡修改策略/风控/订单逻辑，必须同时跑回测与实盘单测（或短时 DEMO），并在 MR 中说明影响范围。 |

---

## 二、用户视角验收测试

站在**使用系统的用户**（如：交易员、运维、产品）角度，对「可用的、可交付的」系统做验收场景与检查项。

### 2.1 角色：想用 DEMO 验证策略的交易员

| 场景 ID | 场景描述 | 验收步骤 | 通过标准 |
|---------|----------|----------|----------|
| **U1** | 从零在本机跑起 DEMO，看到有下单与日志 | 1) 按 QUICK_START 或 README 安装依赖、配置 openapicfg_dem<br>2) 执行 run_moe_demo 或 run_20h_demo<br>3) 查看 run/order_log.jsonl 与 logs | 无 1010/account 为空/AttributeError；order_log 有记录；日志中有「交易循环」「策略/风控/下单」相关输出 |
| **U2** | 在老虎 DEMO 后台看到与系统一致的订单 | 1) DEMO 运行期间产生至少一笔 mode=real&status=success<br>2) 用老虎 DEMO 后台或 API 按 order_id 查询 | 能查到对应 order_id，symbol/方向/数量一致 |
| **U3** | 跑完 20h 后能看到「今日」收益与稳定性结论 | 1) 运行满 20h（或约定时长）<br>2) 查看状态页/报告中的今日收益率、错误率、运行时长 | 报告中有「实际收益率（老虎核对）」或明确说明未核对原因；有稳定性结论（通过/未通过） |

### 2.2 角色：负责例行与发布的运维

| 场景 ID | 场景描述 | 验收步骤 | 通过标准 |
|---------|----------|----------|----------|
| **U4** | 每日例行 7 项可无歧义执行并自检 | 1) 按例行工作清单执行 7 项<br>2) 每项有明确「完成」判定（如：报告已生成、DEMO 已启动、状态页已更新） | 清单中每项有「完成标准」；执行人可自检是否达标 |
| **U5** | 发布前能确认「本次改动未破坏核心流程」 | 1) 跑黑盒 + Feature 测试（不含 real_api 的套件）<br>2) 可选：跑短时 DEMO 或 real_api 子集 | 黑盒与 Feature 全过；若有 real_api 要求则文档说明运行频率与责任人 |
| **U6** | 出问题时能快速定位「是数据、策略、还是执行层」 | 1) 查看 order_log、DEMO 日志、报告中的错误统计与根因说明<br>2) 根据文档回溯（如 1010 根因、无止损止盈根因） | 文档中有「常见现象 → 可能原因 → 排查步骤」；日志中关键操作可追溯 |

### 2.3 角色：关注收益与风险的产品/决策者

| 场景 ID | 场景描述 | 验收步骤 | 通过标准 |
|---------|----------|----------|----------|
| **U7** | 能看懂「当前实盘表现」与「目标 KPI」的差距 | 1) 打开算法优化报告或状态页<br>2) 看到收益率、胜率、回撤等与需求中的 KPI（月盈利率 20% 等）对应关系 | 报告或状态页中有 KPI 对照说明；或有一份「指标说明」文档可查 |
| **U8** | 能区分「回测结果」与「实盘结果」，且知回测是否可参考 | 1) 报告中同时有回测与实盘数据<br>2) 有「回测与实盘逻辑是否一致」的说明或结论 | 报告中有回测/实盘差异说明；若不一致有明确提示「回测仅供参考」或「需对齐后参考」 |

### 2.4 用户验收检查清单（发布前建议勾选）

- [ ] **U1**：新环境能按文档跑起 DEMO 且无禁止项报错  
- [ ] **U2**：至少一笔实单在老虎后台可查且一致  
- [ ] **U3**：20h 或约定时长有稳定性结论与收益/错误率数据  
- [ ] **U4**：例行 7 项有完成标准且可自检  
- [ ] **U5**：黑盒 + Feature 测试通过（及 real_api 按约定执行）  
- [ ] **U6**：常见问题有排查文档与可追溯日志  
- [ ] **U7**：报告/状态页能支撑「当前表现 vs KPI」的阅读  
- [ ] **U8**：回测与实盘关系明确，不误导决策  

---

## 三、与主报告的对应关系

- **深层次问题 DP1～DP10**：与主报告中的 D/C/T/R 编号并列，建议一并纳入项目计划或 Issue 跟踪。  
- **用户验收 U1～U8**：可作为「发布前验收」或「迭代验收」的检查项，由陈正霞或产品在发布前勾选确认。

---

*陈正孤（QA）| 配套主报告：docs/reports/QA评审报告_Tiger项目_陈正孤.md*
