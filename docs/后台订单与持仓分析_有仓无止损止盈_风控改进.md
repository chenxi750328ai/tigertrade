# 后台订单与持仓分析：有仓无止损止盈与风控改进

**问题来源**：从后台看到仍有持仓（如 10 手），但对应的止损单和止盈单都没有了，大部分被系统撤单，可能是**保证金不足被撤**或**强平**导致。当前风控模块可能未覆盖此类情况。

---

## 一、问题描述

- **现象**：老虎后台显示有持仓（例如 10 手），但该持仓对应的止损单、止盈单在后台已不存在（被撤或失效）。
- **可能原因**：
  1. **保证金不足**：交易所/券商因保证金不足自动撤销未成交的止损、止盈单。
  2. **强平/风控撤单**：券商或交易所风控规则触发，撤掉部分挂单。
  3. **订单过期**：部分订单类型有时效，到期自动失效。
- **风险**：持仓处于「裸奔」状态，无自动止损/止盈保护，价格不利时可能造成更大亏损或强平。

---

## 二、当前已做的分析（从后台拉订单 + 持仓）

- **入口**：`scripts/optimize_algorithm_and_profitability.py` 在加载历史订单后，会：
  1. 用 `_fetch_positions_from_tiger_direct()` 拉取老虎持仓（若 API 支持 `get_positions`）。
  2. 用 `analyze_backend_orders_and_positions(orders, positions)` 分析：
     - 持仓数量（来自 get_positions 或从订单推断：已成交买量 − 已成交卖量）；
     - 订单中疑似止损/止盈单的**未撤**与**已撤/拒/过期**笔数；
     - 若**有持仓但无有效止损止盈单**（或大量被撤），则产出告警与风控建议。
- **产出**：
  - `docs/reports/backend_positions_analysis.md`：每次例行生成，含持仓数、止损止盈单统计与告警。
  - 算法优化报告中的「**后台订单与持仓分析**」一节：摘要 + 风控建议（若有告警）。

---

## 三、风控改进建议（待实现）

1. **启动时同步真实持仓**
   - DEMO/实盘启动时，用老虎 API `get_positions`（若可用）拉取当前持仓，同步到进程内 `current_position`（或等价状态），避免进程内持仓与后台不一致导致「以为没仓却实际有仓」或「有仓却未挂止损止盈」。

2. **定期检查：有仓必有止损/止盈**
   - 在策略主循环或独立定时任务中，定期（如每 N 分钟）拉取后台订单与持仓：
     - 若**持仓 > 0** 且**未发现有效止损/止盈单**（或数量明显少于持仓），则：
       - **告警**：打日志并可选推送（如江湖消息、邮件），提示「有仓无止损止盈，可能被撤」；
       - **补单**（若策略允许）：按当前持仓与入场价/风控参数，重新计算并提交止损单、止盈单，并写日志。

3. **保证金与强平预防**
   - 在风控模块中增加对**账户保证金/可用资金**的检查（若 API 提供）：
     - 下单前或定时检查：保证金不足时不再开新仓，并优先建议平掉部分仓位或补足保证金；
     - 若发现止损/止盈单被大量撤单，结合持仓与保证金情况打告警，提示可能为「保证金不足导致撤单」。

4. **与现有风控的结合**
   - 现有 `check_risk_control` 主要做：持仓上限、当日亏损上限、单笔预期损失。建议在上述基础上增加：
     - 「有仓无止损止盈」的**检测与告警**（已通过后台订单与持仓分析产出）；
     - 可选：**自动补挂止损止盈**的逻辑（需明确补单规则与频率，避免重复挂单）。

---

## 四、相关脚本与报告

| 项目 | 说明 |
|------|------|
| `scripts/optimize_algorithm_and_profitability.py` | 例行中调用 `_fetch_positions_from_tiger_direct`、`analyze_backend_orders_and_positions`，写 `backend_positions_analysis.md` 并写入算法报告一节。 |
| `docs/reports/backend_positions_analysis.md` | 每次例行生成，含持仓、止损止盈单统计与风控建议。 |
| `docs/风控_持仓上限回溯.md` | 持仓上限与 DEMO 最大 3 手的说明；可与本文一起作为风控改进依据。 |

---

本文档为「后台订单与持仓分析」与「有仓无止损止盈」风控改进的说明与待办依据；实现上述建议后请更新本文状态与链接。
