# 数据对齐和序列长度总结

**更新时间**: 2026-01-23

---

## 📊 一、数据对齐过程

### 1.1 数据来源

1. **K线数据**: 1分钟K线（OHLCV），从Tiger API获取
2. **Tick数据**: 真实Tick数据，从DEMO账户采集，保存在 `/home/cx/trading_data/ticks/`
3. **技术指标**: 基于K线数据计算（RSI、ATR、布林带）

### 1.2 对齐流程

```
K线数据（1分钟）
    ↓
技术指标计算（RSI、ATR、布林带）
    ↓
Tick数据匹配（K线时间 ± 30秒窗口）
    ↓
特征提取（18维，包含真实Tick数据）
    ↓
序列构建（seq_length个时间步）
    ↓
训练样本 (batch_size, seq_length, 18)
```

### 1.3 关键对齐点

**Tick数据对齐**:
- 对于每个K线时间点，找到该时间窗口内的Tick数据
- 时间窗口: K线时间 ± 30秒
- 使用最新Tick价格作为该K线的Tick价格

**特征对齐**:
- 每个时间点提取18维特征
- 包含K线价格、Tick价格、技术指标等

**序列对齐**:
- 取最近`seq_length`个时间步的特征
- 形成 `(seq_length, 18)` 的序列

---

## 🎯 二、序列长度分析

### 2.1 当前问题

**序列长度10太短**:
- ❌ 无法覆盖完整的技术指标周期（RSI需要14步，布林带需要20步）
- ❌ 无法识别复杂的价格模式（双顶、头肩等）
- ❌ 无法充分利用历史成交信息

### 2.2 理论分析

**技术指标周期**:
- RSI(14): 需要14个时间步
- 布林带(20): 需要20个时间步
- ATR(14): 需要14个时间步

**价格模式识别**:
- 双顶/双底: 需要20-40分钟
- 头肩形态: 需要30-60分钟
- 趋势线: 需要20-30分钟

**结论**: 至少需要**30个时间步**才能有效工作

### 2.3 建议的序列长度

| 序列长度 | 时间跨度 | 适用场景 | 说明 |
|---------|---------|---------|------|
| **10** | 10分钟 | ❌ 不推荐 | 太短，无法覆盖技术指标周期 |
| **20** | 20分钟 | ⚠️ 最小 | 刚好覆盖布林带周期 |
| **30** | 30分钟 | ✅ 最小推荐 | 覆盖主要技术指标 |
| **40-50** | 40-50分钟 | ✅ 推荐 | 平衡性能和计算成本 |
| **50-60** | 50-60分钟 | ✅ 理想 | 包含更多历史信息 |

### 2.4 如何确定合适的序列长度？

**动态测试方法**:
1. 测试不同序列长度（10, 20, 30, 40, 50, 60）
2. 观察性能变化（准确率、收益率、损失值）
3. 找到收敛点（性能不再显著提升）

**测试脚本**: `scripts/analysis/sequence_length_tester.py`

**测试指标**:
- 准确率
- 收益准确率
- 验证损失
- 过拟合程度

---

## 🔧 三、实现建议

### 3.1 修改默认序列长度

**当前代码**:
```python
def train_model(self, df, seq_length=10, ...):
```

**建议修改**:
```python
def train_model(self, df, seq_length=30, ...):  # 从10改为30
```

### 3.2 动态序列长度测试

**测试流程**:
```python
sequence_lengths = [10, 20, 30, 40, 50, 60]
results = []

for seq_len in sequence_lengths:
    # 训练模型
    strategy.train_model(df, seq_length=seq_len)
    
    # 评估性能
    accuracy, profit_accuracy = evaluate_model(strategy, test_df)
    results.append({
        'seq_length': seq_len,
        'accuracy': accuracy,
        'profit_accuracy': profit_accuracy
    })

# 选择最优序列长度
best_seq_len = max(results, key=lambda x: x['profit_accuracy'])['seq_length']
```

### 3.3 序列长度与模型容量

**注意**: 
- 更长的序列需要更大的模型容量
- 可能需要调整LSTM的`hidden_size`和`num_layers`
- 例如：序列长度60可能需要`hidden_size=128`和`num_layers=3`

---

## ✅ 四、总结

### 4.1 数据对齐

✅ **已完成**:
- K线数据获取
- Tick数据对齐（±30秒窗口）
- 技术指标计算
- 特征提取（18维）
- 序列构建

### 4.2 序列长度

✅ **分析完成**:
- 序列长度10太短
- 建议至少30个时间步
- 推荐40-50个时间步
- 理想50-60个时间步

### 4.3 下一步行动

1. ✅ 运行序列长度测试（10, 20, 30, 40, 50, 60）
2. ✅ 分析测试结果，找到最优序列长度
3. ✅ 更新默认序列长度
4. ✅ 考虑实现动态序列长度（根据市场条件调整）

---

**结论**: 
- 数据对齐流程已清晰说明
- 序列长度10确实太短，建议至少30-60个时间步
- 需要通过动态测试确定最优序列长度
