# å¤šAgentç³»ç»Ÿæƒé™æ§åˆ¶æ¶æ„è®¾è®¡

## ğŸ”´ å‘ç°çš„é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š**"å¦ä¸€ä¸ªAIå‘ç³»ç»Ÿé‡Œæ·»åŠ äº†ä»»åŠ¡"**

è¿™æš´éœ²äº†å½“å‰æ¶æ„çš„å…³é”®ç¼ºé™·ï¼š**ç¼ºä¹æƒé™æ§åˆ¶ï¼**

---

## å½“å‰æ¶æ„åˆ†æ

### ç°çŠ¶

```python
# TaskQueue.add_tasks() æ˜¯å…¬å¼€æ–¹æ³•
class TaskQueue:
    def add_tasks(self, tasks):
        # ä»»ä½•Agentéƒ½å¯ä»¥è°ƒç”¨ï¼âš ï¸
        data = json.loads(self.queue_file.read_text())
        data["pending"].extend(tasks)
        self.queue_file.write_text(json.dumps(data))
```

**é—®é¢˜**ï¼š
- âŒ Workerå¯ä»¥æ·»åŠ ä»»åŠ¡
- âŒ æ— æ³•è¿½è¸ªä»»åŠ¡åˆ›å»ºè€…
- âŒ æ— æ³•é˜²æ­¢æ¶æ„ä»»åŠ¡æ³¨å…¥
- âŒ è¿åMaster-Workeræ¶æ„åŸåˆ™

---

## ä¸¤ç§è®¾è®¡å“²å­¦

### æ–¹æ¡ˆAï¼šä¸¥æ ¼æƒé™æ§åˆ¶ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

**åŸåˆ™**ï¼šMasteræ˜¯å”¯ä¸€çš„ä»»åŠ¡åˆ›å»ºè€…

```python
class TaskQueue:
    def __init__(self, creator_id):
        self.creator_id = creator_id  # åªæœ‰Masteræœ‰æƒé™
    
    def add_tasks(self, tasks, requester_id):
        """æ·»åŠ ä»»åŠ¡ï¼ˆéœ€è¦æƒé™éªŒè¯ï¼‰"""
        if requester_id != "master":
            raise PermissionError(f"{requester_id}æ— æƒåˆ›å»ºä»»åŠ¡ï¼")
        
        # è®°å½•åˆ›å»ºè€…
        for task in tasks:
            task["created_by"] = requester_id
            task["created_at"] = time.time()
        
        # æ·»åŠ åˆ°é˜Ÿåˆ—
        data = json.loads(self.queue_file.read_text())
        data["pending"].extend(tasks)
        self.queue_file.write_text(json.dumps(data))

class MasterAgent:
    def create_tasks(self, tasks):
        """Masteråˆ›å»ºä»»åŠ¡"""
        self.task_queue.add_tasks(tasks, requester_id="master")
    
class WorkerAgent:
    def create_tasks(self, tasks):
        """Workerå°è¯•åˆ›å»ºä»»åŠ¡"""
        # æ–¹å¼1: ç›´æ¥æ‹’ç»
        raise PermissionError("Workeræ— æƒåˆ›å»ºä»»åŠ¡ï¼")
        
        # æ–¹å¼2: è½¬æ¢ä¸ºè¯·æ±‚
        self.request_new_tasks(tasks)
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®‰å…¨æ€§é«˜
- âœ… æƒé™æ¸…æ™°
- âœ… æ˜“äºå®¡è®¡

**ç¼ºç‚¹**ï¼š
- âŒ çµæ´»æ€§å·®
- âŒ Workeræ— æ³•ä¸»åŠ¨æå‡ºæ–°ä»»åŠ¡

---

### æ–¹æ¡ˆBï¼šåå•†å¼æ¶æ„ï¼ˆæ›´çµæ´»ï¼Œé€‚åˆAIåä½œï¼‰

**åŸåˆ™**ï¼šWorkerå¯ä»¥**æè®®**ä»»åŠ¡ï¼Œä½†éœ€Masteræ‰¹å‡†

```python
class TaskQueue:
    def __init__(self):
        self.queue_file = Path("/tmp/tigertrade_task_queue.json")
    
    def propose_task(self, task, proposer_id):
        """æè®®æ–°ä»»åŠ¡ï¼ˆéœ€è¦Masteræ‰¹å‡†ï¼‰"""
        data = json.loads(self.queue_file.read_text())
        
        # æ·»åŠ åˆ°æè®®é˜Ÿåˆ—
        if "proposed" not in data:
            data["proposed"] = []
        
        task.update({
            "proposed_by": proposer_id,
            "proposed_at": time.time(),
            "status": "pending_approval",
            "approved_by": None
        })
        
        data["proposed"].append(task)
        self.queue_file.write_text(json.dumps(data, indent=2))
        
        print(f"ğŸ“ {proposer_id} æè®®æ–°ä»»åŠ¡: {task['type']}")
    
    def approve_task(self, task_id, approver_id="master"):
        """æ‰¹å‡†ä»»åŠ¡ï¼ˆåªæœ‰Masterå¯ä»¥ï¼‰"""
        if approver_id != "master":
            raise PermissionError("åªæœ‰Masterå¯ä»¥æ‰¹å‡†ä»»åŠ¡ï¼")
        
        data = json.loads(self.queue_file.read_text())
        
        # æŸ¥æ‰¾æè®®çš„ä»»åŠ¡
        for task in data.get("proposed", []):
            if task.get("task_id") == task_id:
                # ç§»åŠ¨åˆ°pendingé˜Ÿåˆ—
                task["status"] = "approved"
                task["approved_by"] = approver_id
                task["approved_at"] = time.time()
                
                data["pending"].append(task)
                data["proposed"].remove(task)
                
                self.queue_file.write_text(json.dumps(data, indent=2))
                print(f"âœ… Masteræ‰¹å‡†äº†ä»»åŠ¡: {task['type']}")
                return True
        
        return False
    
    def reject_task(self, task_id, reason):
        """æ‹’ç»ä»»åŠ¡"""
        print(f"âŒ Masteræ‹’ç»äº†ä»»åŠ¡ {task_id}: {reason}")

class WorkerAgent:
    def propose_new_task(self, task_type, description):
        """Workeræè®®æ–°ä»»åŠ¡"""
        task = {
            "task_id": f"proposed_{int(time.time()*1000)}",
            "type": task_type,
            "description": description
        }
        
        self.task_queue.propose_task(task, self.worker_id)
        
        # åŒæ—¶å‘é€æ¶ˆæ¯ç»™Master
        self.coordinator.send_message(
            "master",
            "task_proposal",
            {
                "task_id": task["task_id"],
                "type": task_type,
                "description": description,
                "reason": "æˆ‘å‘ç°è¿™ä¸ªä»»åŠ¡å¾ˆé‡è¦"
            }
        )

class MasterAgent:
    def _process_messages(self):
        """å¤„ç†Workerçš„æ¶ˆæ¯"""
        messages = self.coordinator.receive_messages()
        
        for msg in messages:
            if msg['type'] == 'task_proposal':
                # Workeræè®®äº†æ–°ä»»åŠ¡
                task_id = msg['data']['task_id']
                task_type = msg['data']['type']
                reason = msg['data'].get('reason', '')
                
                print(f"\nğŸ“‹ {msg['from']} æè®®æ–°ä»»åŠ¡:")
                print(f"   ç±»å‹: {task_type}")
                print(f"   åŸå› : {reason}")
                
                # Masterå†³å®šæ˜¯å¦æ‰¹å‡†
                if self._should_approve(task_type):
                    self.task_queue.approve_task(task_id)
                    
                    # é€šçŸ¥Worker
                    self.coordinator.send_message(
                        msg['from'],
                        "task_approved",
                        {"task_id": task_id, "message": "ä»»åŠ¡å·²æ‰¹å‡†"}
                    )
                else:
                    self.task_queue.reject_task(task_id, "ä¼˜å…ˆçº§ä¸å¤Ÿ")
                    
                    # é€šçŸ¥Worker
                    self.coordinator.send_message(
                        msg['from'],
                        "task_rejected",
                        {"task_id": task_id, "reason": "ä¼˜å…ˆçº§ä¸å¤Ÿ"}
                    )
    
    def _should_approve(self, task_type):
        """Masterçš„æ‰¹å‡†é€»è¾‘"""
        # å¯ä»¥åŸºäºï¼š
        # 1. ä»»åŠ¡ç±»å‹
        # 2. å½“å‰ç³»ç»Ÿè´Ÿè½½
        # 3. Workerçš„å†å²è¡¨ç°
        # 4. ä»»åŠ¡ä¼˜å…ˆçº§
        return task_type in ["data_clean", "model_train", "backtest"]
```

**ä¼˜ç‚¹**ï¼š
- âœ… çµæ´»ï¼šWorkerå¯ä»¥ä¸»åŠ¨æå‡ºå»ºè®®
- âœ… å®‰å…¨ï¼šMasteræœ‰æœ€ç»ˆå†³å®šæƒ
- âœ… æ™ºèƒ½ï¼šæ”¯æŒAIä¹‹é—´çš„åå•†
- âœ… å¯è¿½è¸ªï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚
- âŒ éœ€è¦MasteræŒç»­è¿è¡Œ

---

## å®Œæ•´çš„æƒé™çŸ©é˜µ

| æ“ä½œ | Master | Worker | è¯´æ˜ |
|------|--------|--------|------|
| **åˆ›å»ºä»»åŠ¡** | âœ… ç›´æ¥åˆ›å»º | âš ï¸ æè®®ï¼ˆéœ€æ‰¹å‡†ï¼‰ | æ–¹æ¡ˆB |
| **æ‰¹å‡†ä»»åŠ¡** | âœ… | âŒ | åªæœ‰Master |
| **æ¥æ”¶ä»»åŠ¡** | âŒ | âœ… | WorkerèŒè´£ |
| **æ‰§è¡Œä»»åŠ¡** | âŒ | âœ… | WorkerèŒè´£ |
| **å®Œæˆä»»åŠ¡** | âŒ | âœ… | WorkeræŠ¥å‘Š |
| **å¤±è´¥ä»»åŠ¡** | âŒ | âœ… | WorkeræŠ¥å‘Š |
| **é‡æ–°åˆ†é…** | âœ… | âŒ | Masterå†³ç­– |
| **è¯·æ±‚å¸®åŠ©** | âŒ | âœ… | Workeræƒåˆ© |
| **æä¾›æŒ‡å¯¼** | âœ… | âŒ | MasterèŒè´£ |

---

## å®ç°å»ºè®®

### çŸ­æœŸï¼ˆç«‹å³ï¼‰

```python
# 1. æ·»åŠ åˆ›å»ºè€…è¿½è¸ª
def add_tasks(self, tasks, created_by="unknown"):
    for task in tasks:
        task["created_by"] = created_by
        task["created_at"] = time.time()
    # ...

# 2. æ·»åŠ æ—¥å¿—
def add_tasks(self, tasks, created_by):
    if created_by != "master":
        print(f"âš ï¸  è­¦å‘Š: {created_by} å°è¯•åˆ›å»ºä»»åŠ¡ï¼")
    # ...
```

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰

å®ç°**æ–¹æ¡ˆBï¼ˆåå•†å¼æ¶æ„ï¼‰**ï¼š
1. æ·»åŠ `proposed`é˜Ÿåˆ—
2. å®ç°`propose_task()`å’Œ`approve_task()`
3. Masterå¤„ç†`task_proposal`æ¶ˆæ¯
4. Workerä½¿ç”¨`propose_new_task()`

### é•¿æœŸï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

1. **åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰**

```python
class Role:
    MASTER = "master"
    WORKER = "worker"
    ADMIN = "admin"

class Permission:
    CREATE_TASK = "create_task"
    APPROVE_TASK = "approve_task"
    EXECUTE_TASK = "execute_task"

ROLE_PERMISSIONS = {
    Role.MASTER: [Permission.CREATE_TASK, Permission.APPROVE_TASK],
    Role.WORKER: [Permission.EXECUTE_TASK],
    Role.ADMIN: [Permission.CREATE_TASK, Permission.APPROVE_TASK]
}

def check_permission(agent_id, permission):
    role = get_agent_role(agent_id)
    return permission in ROLE_PERMISSIONS.get(role, [])
```

2. **å®¡è®¡æ—¥å¿—**

```python
class AuditLog:
    def log_action(self, agent_id, action, details):
        log_entry = {
            "timestamp": time.time(),
            "agent_id": agent_id,
            "action": action,
            "details": details
        }
        # å†™å…¥å®¡è®¡æ—¥å¿—
        self.append_log(log_entry)
```

3. **ç­¾åéªŒè¯**

```python
def add_tasks(self, tasks, requester_id, signature):
    # éªŒè¯ç­¾å
    if not verify_signature(requester_id, tasks, signature):
        raise SecurityError("ç­¾åéªŒè¯å¤±è´¥ï¼")
    # ...
```

---

## å¯¹å½“å‰æƒ…å†µçš„å»ºè®®

### å¦‚æœWorkerå·²ç»æ·»åŠ äº†ä»»åŠ¡

**ç«‹å³è¡ŒåŠ¨**ï¼š
1. æ£€æŸ¥ä»»åŠ¡å†…å®¹æ˜¯å¦åˆç†
2. å¦‚æœåˆç† â†’ å…è®¸æ‰§è¡Œï¼ˆè¿™æ¬¡ï¼‰
3. å¦‚æœä¸åˆç† â†’ æ‰‹åŠ¨åˆ é™¤

**åç»­æªæ–½**ï¼š
1. å®ç°æ–¹æ¡ˆBï¼ˆåå•†å¼æ¶æ„ï¼‰
2. æ›´æ–°Workeræ–‡æ¡£ï¼Œæ˜ç¡®è§„èŒƒ
3. æ·»åŠ æƒé™æ£€æŸ¥

### å¦‚æœWorkeråªæ˜¯åœ¨ç­‰å¾…

**æ­£å¸¸æƒ…å†µ**ï¼š
1. é‡å¯Masteråˆ†é…ä»»åŠ¡
2. ç»§ç»­æ‰§è¡Œ

---

## å·¥ä½œæµç¤ºä¾‹ï¼ˆæ–¹æ¡ˆBï¼‰

```
1. Workerå‘ç°éœ€è¦æ–°ä»»åŠ¡
   â†“
   Worker: propose_task("data_validation")
   â†“
   
2. ä»»åŠ¡è¿›å…¥proposedé˜Ÿåˆ—
   â†“
   Masteræ”¶åˆ°task_proposalæ¶ˆæ¯
   â†“
   
3. Masterè¯„ä¼°ä»»åŠ¡
   â†“
   if (ä»»åŠ¡åˆç†):
       approve_task()
       â†’ ç§»åŠ¨åˆ°pendingé˜Ÿåˆ—
       â†’ é€šçŸ¥Worker: "å·²æ‰¹å‡†"
   else:
       reject_task()
       â†’ é€šçŸ¥Worker: "å·²æ‹’ç»ï¼ŒåŸå› XXX"
   
4. Workeræ”¶åˆ°å›å¤
   â†“
   if (æ‰¹å‡†):
       ç­‰å¾…ä»»åŠ¡è¢«åˆ†é…
   else:
       æ¥å—å†³å®šï¼Œç»§ç»­å…¶ä»–å·¥ä½œ
```

---

## æ€»ç»“

### å½“å‰çŠ¶æ€
- âŒ **ç¼ºä¹æƒé™æ§åˆ¶**
- âŒ **Workerå¯ä»¥æ·»åŠ ä»»åŠ¡**
- âŒ **æ— æ³•è¿½è¸ªä»»åŠ¡æ¥æº**

### æ¨èæ–¹æ¡ˆ
- âœ… **æ–¹æ¡ˆBï¼ˆåå•†å¼ï¼‰**ï¼šçµæ´»ä¸”å®‰å…¨
- âœ… **æ·»åŠ åˆ›å»ºè€…è¿½è¸ª**ï¼šç«‹å³å®æ–½
- âœ… **å®ç°æè®®-æ‰¹å‡†æœºåˆ¶**ï¼šæœ¬å‘¨å®Œæˆ

### å“²å­¦
```
ä¸¥æ ¼æ§åˆ¶ vs æ™ºèƒ½åä½œ

ä¼ ç»Ÿç³»ç»Ÿ: Masterå‘½ä»¤ï¼ŒWorkeræ‰§è¡Œ
AIç³»ç»Ÿ: Workeræè®®ï¼ŒMasterå†³ç­–ï¼Œå…±åŒåä½œ

â†’ æˆ‘ä»¬é€‰æ‹©åè€…ï¼ğŸ¤
```

---

**ä¸‹ä¸€æ­¥ï¼šå®ç°åå•†å¼æ¶æ„ï¼Œè®©AIä¹‹é—´çœŸæ­£åä½œï¼**
