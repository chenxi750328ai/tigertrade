# 订单问题为何测不出来：原因与测试改进

## 一、原因总结

### 1. 真实原因（已修复）

- **生产路径**：`python src/tiger1.py d` 时，api_manager 在**模块加载时**初始化，用的是 `account_from_config = getattr(trade_client.config, 'account', None)`。Tiger SDK 的 `TradeClient` 的 `config` 上可能没有 `account`，所以得到 **None**，导致下单时 account 为空或错误。
- **真实 API 测试路径**：`test_feature_order_execution_real_api` 的 `setUpClass` 里**显式**用 `client_config.account` 并传给 `initialize_real_apis(..., account=client_config.account)`，所以测试里 account **始终有值**。
- **Mock 测试路径**：`test_feature_buy_silver_comprehensive`、`test_account_传递_端到端` 等要么显式 `initialize_mock_apis(account="TEST_ACCOUNT_123")`，要么在用例里用 `client_config.account` 初始化，**从没走过「只从 trade_client.config 取 account」这条生产路径**。

所以：**订单问题（account 为空）只出现在「以 tiger1 为主入口、模块加载时用 trade_client.config.account 初始化」这条路径上，而现有测试都没有覆盖这条路径。**

### 2. 为何“授权失败”测试没把原因说清

- 真实 API 测试**确实会失败**（例如 `test_f3_001_buy_order_e2e` 报 `订单提交失败: 下单异常: ... account is not authorized to the api user`）。
- 但之前返回的是笼统的「下单异常」而不是「授权失败」，所以一眼看不出是 account/授权问题；后来在 `order_executor` 里已改为识别 `not authorized` 并返回「授权失败」提示。

### 3. 为何“后台看不到订单”测不出

- Mock 测试不调真实 API，**不会**在 Tiger 后台产生订单，自然测不到「后台看不到订单」。
- 真实 API 测试若因环境/凭证被 Skip，或只跑 Mock 套件，也不会执行到真实下单和查询，所以这个问题只能在**真实环境、真实下单**下暴露。

---

## 二、测试改进（必须做）

### 1. 增加「tiger1 主入口」下的 account 来源测试

**目标**：保证主入口和真实环境一致——account 来自 **client_config**，而不是仅来自 `trade_client.config`。

**做法**：

- 新增用例（例如在 `test_account_传递_端到端.py` 或专门文件）：
  - **用例 A**：用「仅有 trade_client、且 trade_client.config.account 为 None」的环境调用 `initialize_real_apis(..., account=None)`，断言 `api_manager._account` 为 None（或符合当前实现）。用于说明：**仅靠 trade_client.config 会得到空 account**。
  - **用例 B**：用同一 trade_client，但传入 `account=client_config.account`（client_config 从 openapicfg_dem 加载），再调用 `initialize_real_apis`，断言 `api_manager._account == client_config.account`。用于说明：**必须显式传入 client_config.account 才能保证有值**。
- 可选：在文档或注释中写明「tiger1 主入口必须用 client_config.account 初始化 api_manager，不要只依赖 trade_client.config.account」。

这样一旦有人把 tiger1 的初始化改回只用 `trade_client.config.account`，用例 B 会失败（或用例 A 会暴露“无 client_config 时 account 为空”），从而发现订单问题。

### 2. Mock 下单测试：断言请求里的 account 和 symbol

**目标**：Mock 的 place_order 不仅要“被调用”，还要**请求参数正确**（与原始可成功行为一致）。

**做法**：

- 在调用 `execute_buy` / `place_tiger_order` 的 Mock 测试里，对 `trade_api.place_order` 或 `client.place_order` 做 **spy**（或 Mock 的 `call_args`）：
  - 若调用的是 `place_order(symbol, side, ...)`：断言 `symbol == 'SIL2603'`（或 `_to_api_identifier(FUTURE_SYMBOL)`）。
  - 若调用的是 `place_order(order)`：断言 `order.account` 非空且等于当前期望的 account（例如 api_manager._account 或 client_config.account）。
- 这样若有人误改 account 来源或 symbol 格式，Mock 测试会失败，而不是“仍然通过但实盘/后台出问题”。

### 3. 真实 API 测试的稳定性与可读性

- **保持**「下单失败时识别 not authorized 并 skip + 明确提示」的现有逻辑，避免误报为普通断言失败。
- **建议**：在 CI/每日例行里，若环境允许（有 openapicfg_dem 且网络可达），跑一次真实 API 下单+查询用例，用于回归「后台能看到订单」；若不可用则 Skip 并注明原因（无凭证/网络等）。

### 4. 合约格式与原始行为一致

- 已有约定：下单用 **symbol + currency**（与原始 tiger1 一致），不额外传 expiry/exchange。
- 可加一条**单元测试**：对 `api_adapter` 中构建期货合约的代码，断言对 SIL2603 调用 `future_contract` 时只传 `symbol` 和 `currency`，不传 `expiry`/`exchange`，防止后续改动 reintroduce 合约格式差异。

---

## 三、小结

| 问题 | 原因 | 测试改进 |
|------|------|----------|
| account 为空导致订单失败 | 生产用 trade_client.config.account（为 None），测试用 client_config.account | 加「仅 trade_client.config 时 account 为空」与「传入 client_config.account 后 account 正确」的用例 |
| 授权失败原因不直观 | 异常被包装成「下单异常」 | 已在 order_executor 中识别 not authorized，测试保持对 skip + 提示的依赖 |
| 后台看不到订单 | Mock 不调真实 API；真实测试可能被 Skip | Mock 断言请求参数；真实环境跑真实 API 下单+查询回归 |
| 合约格式与原始不一致 | 曾加 expiry/exchange 导致差异 | 已改回仅 symbol+currency；可加合约构造的单元断言 |

按上述改进后，**订单相关问题**（account 未注入、symbol/合约格式错误、授权失败提示不明确）会在对应测试中暴露，而不是“测不出来”。
