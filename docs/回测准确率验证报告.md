# 回测准确率验证报告

**分析时间**: 2026-01-23  
**问题**: 回测准确率数据是否正确？网格参数计算错误是否影响准确率？

---

## 🔍 一、回测准确率计算方式

### 1.1 标签生成逻辑

**代码位置**: `llm_strategy.py` - `train_model()` 方法

```python
# 生成标签（基于未来look_ahead步的盈利）
current_price = df.iloc[i]['price_current']
future_prices = df.iloc[i+1:i+look_ahead+1]['price_current'].values

max_future_price = max(future_prices)
min_future_price = min(future_prices)

buy_profit = (max_future_price - current_price) / current_price
sell_profit = (current_price - min_future_price) / current_price

profit_threshold = 0.005
min_diff = 0.003

if abs(buy_profit - sell_profit) >= min_diff:
    if buy_profit > sell_profit and buy_profit > profit_threshold:
        label = 1  # 买入
    elif sell_profit > buy_profit and sell_profit > profit_threshold:
        label = 2  # 卖出
    else:
        label = 0  # 持有
```

### 1.2 准确率计算

```python
# 准确率 = 预测动作 == 标签
predictions = torch.argmax(outputs, dim=1)
correct = (predictions == labels).sum().item()
accuracy = correct / total
```

---

## ❌ 二、问题分析

### 2.1 问题1: 标签生成依赖网格参数

**问题**:
- 标签基于未来价格计算，但**不考虑网格参数**
- 如果网格参数不合理，标签可能不准确
- 例如：如果网格间距太大，买入后可能无法及时卖出盈利

**影响**:
- 标签可能不准确
- 模型学习的是"在理想情况下应该做什么"
- 但实际交易中，网格参数限制了交易机会

### 2.2 问题2: 回测使用规则计算的网格参数

**问题**:
- 回测时使用规则计算的网格参数
- 如果网格参数计算错误，回测结果可能不准确
- 回测准确率可能高估或低估实际表现

**影响**:
- 回测结果可能不准确
- 无法真实反映策略表现

### 2.3 问题3: 模型不预测网格参数

**问题**:
- 模型只预测动作，不预测网格参数
- 网格参数通过规则计算
- 如果规则计算错误，模型预测的动作可能也不合理

**影响**:
- 模型无法学习最优网格参数
- 依赖规则计算的网格参数

---

## 📊 三、准确率数据验证

### 3.1 训练准确率

**数据来源**: `all_models_results.json`

```
LSTM模型 (LLM策略):
- 训练准确率: 99.42%（第20个epoch）
- 验证准确率: 99.42%
```

**问题**:
- 准确率非常高（99.42%），但实际回测收益只有2.3%
- 说明：**高准确率 ≠ 高收益**

**原因**:
1. 标签可能不准确（不考虑网格参数）
2. 模型可能过拟合
3. 准确率定义可能不合理

### 3.2 序列长度测试准确率

**数据来源**: `sequence_test_progress_*.json`

```
序列长度10: 准确率 48.05%
序列长度50: 准确率 47.01%
序列长度100: 准确率 46.99%
```

**问题**:
- 准确率只有48%左右，接近随机（33.3%）
- 说明：模型预测能力有限

**原因**:
1. 标签可能不准确
2. 特征可能不够
3. 模型可能不够复杂

---

## 💡 四、应该的设计

### 4.1 模型应该预测网格参数

**当前设计**:
```
输入: 市场数据 + 规则计算的网格参数
输出: 动作（买入/卖出/持有）
```

**应该的设计**:
```
输入: 市场数据
输出: 网格参数（grid_step, grid_upper, grid_lower）+ 动作
```

### 4.2 标签应该考虑网格参数

**当前标签生成**:
```python
# 不考虑网格参数
buy_profit = (max_future_price - current_price) / current_price
```

**应该的标签生成**:
```python
# 考虑网格参数
# 如果买入，计算在网格范围内的实际盈利
# 如果网格参数不合理，标签应该是"持有"
```

### 4.3 回测应该使用模型预测的网格参数

**当前回测**:
```python
# 使用规则计算的网格参数
grid_params = time_period_strategy.get_grid_parameters(current_price)
```

**应该的回测**:
```python
# 使用模型预测的网格参数
grid_params = model.predict_grid_parameters(market_data)
```

---

## 🔧 五、修复建议

### 5.1 立即修复

1. **验证回测代码**
   - 检查回测逻辑是否正确
   - 验证准确率计算

2. **修复网格参数计算** ✅ 已完成
   - 确保网格参数计算合理

### 5.2 短期优化

1. **改进标签生成**
   - 考虑网格参数
   - 使用实际交易成本

2. **改进准确率定义**
   - 使用实际收益而不是动作匹配
   - 考虑交易成本

### 5.3 长期优化

1. **模型预测网格参数**
   - 修改模型架构
   - 训练数据使用历史最优网格参数

2. **端到端学习**
   - 模型同时预测网格参数和动作
   - 使用强化学习优化

---

## ✅ 六、结论

### 6.1 当前问题

1. ✅ **网格参数计算错误** - 已修复
2. ⚠️ **网格参数应该由模型预测** - 需要重新设计
3. ⚠️ **回测准确率可能不准确** - 需要验证
4. ⚠️ **标签生成不考虑网格参数** - 需要改进

### 6.2 准确率数据

- **训练准确率99.42%**: 可能过拟合，或标签不准确
- **序列长度测试48%**: 接近随机，说明模型预测能力有限
- **回测收益2.3%**: 与高准确率不匹配，说明准确率定义有问题

---

**建议**: 
1. 重新设计模型，让模型预测网格参数
2. 改进标签生成，考虑网格参数
3. 改进准确率定义，使用实际收益
