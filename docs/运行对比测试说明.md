# 运行公平对比测试说明

**创建时间**: 2026-01-23  
**目的**: 在相同条件下对比LSTM和Transformer的性能

---

## 🚀 一、快速开始

### 方法1: 使用脚本（推荐）

```bash
cd /home/cx/tigertrade
./scripts/analysis/run_fair_comparison.sh
```

### 方法2: 直接运行Python

```bash
cd /home/cx/tigertrade
python scripts/analysis/fair_model_comparison.py \
    --seq-lengths 10 50 100 \
    --epochs 50
```

### 方法3: 指定数据文件

```bash
python scripts/analysis/fair_model_comparison.py \
    --data-file /path/to/training_data.csv \
    --seq-lengths 10 50 100 \
    --epochs 50
```

---

## 📊 二、测试配置

### 2.1 默认配置

- **序列长度**: 10, 50, 100
- **训练轮次**: 50
- **早停耐心**: 10
- **批次大小**: 16
- **学习率**: 0.001

### 2.2 自定义配置

```bash
python scripts/analysis/fair_model_comparison.py \
    --seq-lengths 10 20 30 50 100 \
    --epochs 100
```

---

## 📈 三、输出结果

### 3.1 控制台输出

```
================================================================================
训练 LSTM 模型
序列长度: 10, 训练轮次: 50, 隐藏层: 64
================================================================================

📊 开始训练...
训练轮次 1/50
  训练 - 损失: 0.9668, 准确率: 0.635
  验证 - 损失: 0.6966, 准确率: 0.657
  ...

✅ 训练完成，耗时: 123.45秒

📊 开始评估...
  传统准确率: 0.4805
  收益加权准确率: 0.5234
  参数量: 53,443
  训练时间: 123.45秒
```

### 3.2 JSON结果文件

保存到: `/home/cx/tigertrade/docs/fair_comparison_results_YYYYMMDD_HHMMSS.json`

**格式**:
```json
[
  {
    "model_type": "lstm",
    "seq_length": 10,
    "epochs": 50,
    "hidden_size": 64,
    "training_time": 123.45,
    "accuracy": 0.4805,
    "profit_accuracy": 0.5234,
    "num_params": 53443
  },
  {
    "model_type": "transformer",
    "seq_length": 10,
    "epochs": 50,
    "hidden_size": 64,
    "training_time": 234.56,
    "accuracy": 0.4523,
    "profit_accuracy": 0.4891,
    "num_params": 125432
  }
]
```

### 3.3 对比表格

```
================================================================================
模型对比结果
================================================================================
模型            序列长度    准确率      收益准确率    参数量          训练时间
--------------------------------------------------------------------------------
lstm            10          0.4805      0.5234        53,443          123.45
transformer     10          0.4523      0.4891        125,432         234.56
lstm            50          0.4165      0.4756        53,443          145.67
transformer     50          0.4234      0.4812        125,432         267.89
...
```

---

## 🔍 四、结果分析

### 4.1 关键指标

1. **传统准确率**: 预测动作 == 标签的比例
2. **收益加权准确率**: `predicted_profit / best_profit`（更贴近实际收益）
3. **参数量**: 模型大小
4. **训练时间**: 训练耗时

### 4.2 分析要点

1. **哪个模型更好？**
   - 对比收益加权准确率（更关键）
   - 考虑训练时间和参数量

2. **哪个序列长度更好？**
   - 观察不同序列长度的表现
   - 验证"越长越好"的假设

3. **理论分析验证**
   - Transformer是否真的更好？
   - 数据量是否足够？
   - 训练是否充分？

---

## ⚠️ 五、注意事项

### 5.1 数据要求

- 需要至少 `seq_length + look_ahead + 20` 条数据
- 建议使用 `training_data_from_klines_*.csv` 文件

### 5.2 训练时间

- LSTM: 约2-5分钟/序列长度
- Transformer: 约5-10分钟/序列长度
- 完整测试（3个序列长度 × 2个模型）: 约30-60分钟

### 5.3 GPU要求

- 建议使用GPU加速
- CPU也可以运行，但速度较慢

---

## 📝 六、示例输出

```
================================================================================
开始公平模型对比测试
序列长度: [10, 50, 100]
训练轮次: 50
================================================================================

================================================================================
训练 LSTM 模型
序列长度: 10, 训练轮次: 50, 隐藏层: 64
================================================================================
✅ 从 /home/cx/trading_data/.../training_data_from_klines_20260123.csv 加载数据: 43180 条

📊 使用序列长度: 10, 需要至少 20 个数据点
📊 训练配置: 最大轮次=50, 早停耐心=10, 网格调整训练=True
标签分布: {0: 12345, 1: 5678, 2: 8901}
✅ 数据准备完成: 训练集形状 torch.Size([34544, 10, 12]), 验证集形状 torch.Size([8636, 10, 12])

训练轮次 1/50
  训练 - 损失: 0.9668, 准确率: 0.635
  验证 - 损失: 0.6966, 准确率: 0.657
  学习率: 0.001000
  🏆 新的最佳验证准确率: 0.657

...

⏹️ 早停于第 23 轮（验证准确率未提升 10 轮）
✅ 训练完成，耗时: 123.45秒

📊 开始评估...
  传统准确率: 0.4805
  收益加权准确率: 0.5234
  参数量: 53,443
  训练时间: 123.45秒

================================================================================
训练 TRANSFORMER 模型
序列长度: 10, 训练轮次: 50, 隐藏层: 64
================================================================================
...
```

---

## ✅ 七、总结

### 7.1 功能

- ✅ 公平对比LSTM和Transformer
- ✅ 测试多个序列长度
- ✅ 使用收益加权准确率
- ✅ 自动保存结果

### 7.2 使用

```bash
./scripts/analysis/run_fair_comparison.sh
```

### 7.3 结果

- JSON结果文件
- 对比表格
- 详细日志

---

**状态**: 测试框架已就绪，可以运行
