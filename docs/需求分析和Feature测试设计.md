# TigerTrade 需求分析和 Feature 测试设计

**设计完备性**：业界方案对比、功能与性能分析设计、DFX 属性设计（可靠性、可用性、易用性、可服务、可维护、可演进、可测试）及对应实现见 **[设计完备性_业界方案与DFX](设计完备性_业界方案与DFX.md)**。

**设计文档总入口（本仓库设计索引）**：  
- **回测 / 实盘 / 训练 输入与流程对比**（建议优先阅读）：[回测与实盘_输入与处理流程对比](strategy_designs/回测与实盘_输入与处理流程对比.md)。含 Grid/BOLL/MoE/LSTM 回测 vs 实盘、训练 vs 推理输入一致性、每日例行优化在干啥、调的是哪些参数；作为「从目的上对齐」的修改依据。  
- **策略与算法设计目录**：[strategy_designs/README](strategy_designs/README.md)。含各策略设计（网格与 BOLL、MoE、LSTM）及本设计总入口链接。  
- **大模型搜参设计方案**（业界方案对比与落地）：[大模型搜参设计方案](strategy_designs/大模型搜参设计方案.md)。  
- 项目状态与计划：**[STATUS](STATUS.md)**、[项目计划_月度周计划](项目计划_月度周计划.md)。

## 一、需求分析

### 1.1 业务目标
- **核心目标**：实现稳定盈利，月盈利率 20%
- **KPI指标**：
  - 月盈利率目标: 20%
  - 夏普比率: > 2.0
  - 最大回撤: < 10%
  - 胜率: > 60%
  - 盈亏比: > 2:1

### 1.2 可靠性目标（金融系统必守）
- **金融系统对可靠性要求高**；**20 小时稳定运行不出错**是项目目标之一，不是「跑一下就行」。
- **目标含义**：系统能够持续运行满 **20 小时**（或约定时长）**不崩溃、不因未处理异常退出**，且满足稳定性指标（如错误率 &lt; 1%、有正常日志与订单输出）。用于验证实盘前系统具备长时间无故障运行能力。
- **需求与设计对应**：Feature 6（交易循环执行）的 AR6.1 要求「系统能够持续运行至少 20 小时不崩溃」；设计与实现须保证异常处理、恢复与日志完整，例行工作中 20h DEMO 既要**启动**，也要**验证运行过程与结果**（运行满 20h、检查日志与稳定性报告），未达标则记为异常并排查。详见 [CI/CD和稳定性测试流程](CI_CD和稳定性测试流程.md)、[例行工作清单](../shared_rag/best_practices/例行工作清单_agent必读.md) 第 4 项。

### 1.3 核心特性（Features）

#### Feature 1: 市场数据采集
**需求描述**：系统能够从Tiger API获取实时和历史市场数据（Tick、K线）

**功能点**：
- F1.1: 获取Tick数据（秒级）
- F1.2: 获取多周期K线数据（1min, 5min, 1h, 1d等）
- F1.3: 数据缓存和去重
- F1.4: 数据格式标准化（时区、时间戳）

**验收标准（AR）**：
- AR1.1: 能够成功获取SIL2603的Tick数据，数据包含price、volume、timestamp
- AR1.2: 能够获取至少5种不同周期的K线数据
- AR1.3: 数据时间戳正确转换为北京时间
- AR1.4: 重复数据能够自动去重

#### Feature 2: 交易策略预测
**需求描述**：系统能够基于市场数据和模型，预测交易动作（买入/卖出/持有）

**功能点**：
- F2.1: 时段自适应网格策略
- F2.2: MoE Transformer模型预测
- F2.3: 多策略融合
- F2.4: 置信度计算

**验收标准（AR）**：
- AR2.1: 策略能够输出明确的交易动作（BUY/SELL/HOLD）
- AR2.2: 每个动作都有对应的置信度（0-1之间）
- AR2.3: 预测结果包含网格参数（上下轨、间距）
- AR2.4: 不同时段能够自动调整策略参数

#### Feature 3: 订单执行
**需求描述**：系统能够根据策略预测，在DEMO账户中执行真实订单

**功能点**：
- F3.1: 买入订单执行
- F3.2: 卖出订单执行
- F3.3: 订单状态查询和验证
- F3.4: 订单错误处理和重试

**验收标准（AR）**：
- AR3.1: 买入订单能够成功提交到Tiger API，返回有效order_id
- AR3.2: 卖出订单能够成功提交到Tiger API，返回有效order_id
- AR3.3: 订单提交后，能够通过API查询到订单状态（SUBMITTED/FILLED/REJECTED）
- AR3.4: 订单被拒绝时，能够获取拒绝原因（code、msg）
- AR3.5: 订单执行后，DEMO账户中能够看到真实订单记录

#### Feature 4: 风险管理
**需求描述**：系统在执行交易前，必须通过风险控制检查

**功能点**：
- F4.1: 仓位限制检查
- F4.2: 单笔损失限制
- F4.3: 日亏损限制
- F4.4: 止损价格计算
- F4.5: 止盈价格计算

**验收标准（AR）**：
- AR4.1: 达到最大仓位时，拒绝新的买入订单
- AR4.2: 单笔预期损失超过阈值时，拒绝订单
- AR4.3: 当日亏损超过限制时，拒绝所有订单
- AR4.4: 止损价格基于ATR和网格下轨计算，不低于最小值
- AR4.5: 止盈价格基于网格上轨和ATR计算

#### Feature 5: 数据提供和特征计算
**需求描述**：系统能够为策略提供计算好的市场特征和技术指标

**功能点**：
- F5.1: K线数据获取和缓存
- F5.2: Tick数据获取
- F5.3: 技术指标计算（ATR、RSI、BOLL等）
- F5.4: 市场趋势判断

**验收标准（AR）**：
- AR5.1: 能够获取最新K线数据，包含OHLCV
- AR5.2: 能够获取最新Tick价格
- AR5.3: 技术指标计算正确（ATR、RSI在合理范围内）
- AR5.4: 市场趋势判断输出（上涨/下跌/震荡）

#### Feature 6: 交易循环执行
**需求描述**：系统能够持续运行，定期获取数据、预测、执行交易

**功能点**：
- F6.1: 定时循环执行
- F6.2: 异常处理和恢复
- F6.3: 统计信息收集
- F6.4: 日志记录

**验收标准（AR）**：
- AR6.1: 系统能够持续运行至少20小时不崩溃
- AR6.2: 遇到API错误时，能够记录日志并继续运行
- AR6.3: 统计信息正确记录（预测次数、订单数、错误数）
- AR6.4: 关键操作都有日志记录

#### Feature 7: 算法改进与优化（含模型超参与搜参）
**需求描述**：一切有助于改进算法、提升收益率的工作均纳入例行与计划；除策略规则参数（如 grid/boll 的 RSI/均线）外，**模型超参**（学习率、层数、hidden size、dropout 等）也需可调优，大模型/Transformer 类策略的搜参有明确设计方案并与业界方案对比。

**功能点**：
- F7.1: 每日/周期性策略规则参数优化（grid/boll 回测与参数网格，已实现）
- F7.2: **模型超参调优**：将 LLM、MoE、LSTM、Enhanced/Large/Huge Transformer 的超参纳入优化流程（如接入 DataDrivenOptimizer 或等价逻辑到每日/周期任务，或独立搜参任务）
- F7.3: **大模型搜参方案**：设计并实现大模型（含 MoE/Transformer 交易模型）的超参搜索方案，含业界方案对比（Grid/Random/Bayesian/Optuna/Ray Tune/PBT/ASHA 等）、选型与落地步骤；设计见 [大模型搜参设计方案](strategy_designs/大模型搜参设计方案.md)

**验收标准（AR）**：
- AR7.1: 每日或周期性运行中至少包含策略规则参数优化（grid/boll）并产出报告
- AR7.2: 模型超参可通过配置或搜参任务影响训练/推理，且与「算法优化」目标一致（提升收益率）
- AR7.3: 大模型搜参有设计文档（含业界对比）并合并或链接到需求与设计总入口

## 二、Feature级测试设计

### 2.1 Feature 1 测试：市场数据采集

**测试用例**：
- **TC-F1-001**: 获取Tick数据
  - 前置条件：API连接正常
  - 执行步骤：调用`get_tick_data('SIL.COMEX.202603')`
  - 预期结果：返回DataFrame，包含price、volume、timestamp字段
  - 验证：AR1.1

- **TC-F1-002**: 获取多周期K线
  - 前置条件：API连接正常
  - 执行步骤：分别获取1min、5min、1h、1d K线
  - 预期结果：每种周期都返回有效DataFrame
  - 验证：AR1.2

- **TC-F1-003**: 时区转换验证
  - 前置条件：获取K线数据
  - 执行步骤：检查时间戳时区
  - 预期结果：时间戳为北京时间（UTC+8）
  - 验证：AR1.3

### 2.2 Feature 2 测试：交易策略预测

**测试用例**：
- **TC-F2-001**: MoE Transformer策略预测
  - 前置条件：模型已加载，市场数据可用
  - 执行步骤：调用`strategy.predict_action(features)`
  - 预期结果：返回action（BUY/SELL/HOLD）和confidence
  - 验证：AR2.1, AR2.2

- **TC-F2-002**: 时段自适应参数调整
  - 前置条件：不同时段（高峰/低波动）
  - 执行步骤：调用策略预测
  - 预期结果：网格参数随时段变化
  - 验证：AR2.4

### 2.3 Feature 3 测试：订单执行（关键）

**测试用例**：
- **TC-F3-001**: 买入订单端到端测试
  - 前置条件：DEMO账户连接，有可用资金
  - 执行步骤：
    1. 调用`order_executor.execute_buy(...)`
    2. 获取返回的order_id
    3. 调用`trade_client.get_orders()`查询订单
  - 预期结果：
    - 订单提交成功，返回order_id
    - 查询API能找到该订单
    - DEMO账户后台能看到订单
  - 验证：AR3.1, AR3.3, AR3.5

- **TC-F3-002**: 卖出订单端到端测试
  - 前置条件：DEMO账户有持仓
  - 执行步骤：同TC-F3-001，但执行卖出
  - 预期结果：同TC-F3-001
  - 验证：AR3.2, AR3.3, AR3.5

- **TC-F3-003**: 订单拒绝处理
  - 前置条件：触发拒绝条件（如account为空）
  - 执行步骤：提交订单
  - 预期结果：返回失败，包含错误code和msg
  - 验证：AR3.4

### 2.4 Feature 4 测试：风险管理

**测试用例**：
- **TC-F4-001**: 仓位限制检查
  - 前置条件：当前持仓达到最大值
  - 执行步骤：尝试买入
  - 预期结果：风控检查返回False，订单被拒绝
  - 验证：AR4.1

- **TC-F4-002**: 止损计算
  - 前置条件：当前价格、ATR、网格下轨已知
  - 执行步骤：调用`compute_stop_loss(...)`
  - 预期结果：止损价格合理（不低于最小值）
  - 验证：AR4.4

### 2.5 Feature 5 测试：数据提供

**测试用例**：
- **TC-F5-001**: 市场数据获取
  - 前置条件：API连接正常
  - 执行步骤：调用`data_provider.get_market_data()`
  - 预期结果：返回包含K线、Tick、指标的数据字典
  - 验证：AR5.1, AR5.2, AR5.3

### 2.6 Feature 6 测试：交易循环

**测试用例**：
- **TC-F6-001**: 长时间运行测试
  - 前置条件：系统初始化完成
  - 执行步骤：运行`trading_executor.run_loop(duration_hours=20)`
  - 预期结果：运行20小时不崩溃，统计信息正确
  - 验证：AR6.1, AR6.3

## 三、Feature测试与代码测试的互补关系

### 3.1 Feature测试（业务视角）
- **关注点**：业务功能是否满足需求
- **测试粒度**：端到端功能
- **验证方式**：AR（验收标准）
- **覆盖范围**：关键业务流程

### 3.2 代码测试（技术视角）
- **关注点**：代码逻辑是否正确
- **测试粒度**：函数/类级别
- **验证方式**：单元测试、边界测试
- **覆盖范围**：所有代码路径

### 3.3 互补关系
- **Feature测试**确保"做对的事情"（业务正确性）
- **代码测试**确保"把事情做对"（技术正确性）
- **两者结合**：Feature测试发现业务问题，代码测试定位技术问题

## 四、测试执行计划

### 阶段1：Feature测试（优先级最高）
1. TC-F3-001, TC-F3-002（订单执行端到端）- **立即执行**
2. TC-F1-001, TC-F1-002（数据采集）
3. TC-F2-001（策略预测）
4. TC-F4-001, TC-F4-002（风险管理）

### 阶段2：代码测试补充
1. 补充`order_executor.py`的单元测试（覆盖所有分支）
2. 补充`trading_executor.py`的单元测试
3. 补充`data_provider.py`的单元测试
4. 补充`api_adapter.py`的单元测试

### 阶段3：集成测试
1. Feature测试用例自动化
2. 持续集成（CI）中运行Feature测试
3. 覆盖率报告包含Feature测试结果

## 附录：数据来源、报告指标含义与测试方法

（数据来源与测试方法以本文与 [每日例行_效果数据说明](每日例行_效果数据说明.md)、[回测数据集说明](回测数据集说明.md)、[DEMO实盘收益率_定义与数据来源](DEMO实盘收益率_定义与数据来源.md) 为准，报告引用上述文档。）

### A. 回测相关
- **return_pct**：回测资金收益率 (%)，公式 `(期末资金 - 10万) / 10万 × 100`。来自 `scripts/parameter_grid_search.py` 的 `backtest_with_params`。
- **num_trades / win_rate**：回测完成笔数、胜率（盈利笔数/完成笔数×100）。回测按 K 线逐根检查入场/平仓（止损或止盈），既有盈也有亏；**若 num_trades 仅为 1**，多为 test.csv 或参数组合下只触发一次完整开平，此时胜率 100% 或 0% 无参考意义。详见 [回溯_执行失败为何出现收益率与推算收益率](回溯_执行失败为何出现收益率与推算收益率.md)。
- **测试方法**：回测用 `data/processed/test.csv`，脚本 `parameter_grid_search.grid_search_optimal_params`；数据来源见 [回测数据集说明](回测数据集说明.md)。

### B. 订单与日志记录
- **order_log（run/order_log.jsonl）**：每行一条订单记录。含 开仓主单（side、qty、price、order_id、status、mode、**stop_loss/take_profit 计划价**、reason、order_type）；若单独下止损/止盈平仓单也会写一条（order_type=stop_loss 或 take_profit）。**能看到开仓及对应的止损/止盈价**；是否另有单独止损/止盈单条取决于代码是否对每次提交 SL/TP 调用 log。
- **DEMO 运行日志（demo_*.log）**：程序 stdout/logger 输出。含「已提交止损单」「已提交止盈单」等打印；**demo_sl_tp_log** = 日志全文中匹配「止损|止盈|STP|止盈单|止损单|已提交止损|已提交止盈」的**次数**（非订单数）。**demo_execute_buy_calls** = 匹配「execute_buy|动作: 买入」的**次数**。DEMO 日志**没有逐笔盈亏**，故**没有**基于 DEMO 的「胜率」计算；报告里的 win_rate 来自回测或 API，不是来自 DEMO 日志。详见 [每日例行_效果数据说明](每日例行_效果数据说明.md)。
