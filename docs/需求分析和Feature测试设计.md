# TigerTrade 需求分析和 Feature 测试设计

## 一、需求分析

### 1.1 业务目标
- **核心目标**：实现稳定盈利，月盈利率 20%
- **KPI指标**：
  - 月盈利率目标: 20%
  - 夏普比率: > 2.0
  - 最大回撤: < 10%
  - 胜率: > 60%
  - 盈亏比: > 2:1

### 1.2 核心特性（Features）

#### Feature 1: 市场数据采集
**需求描述**：系统能够从Tiger API获取实时和历史市场数据（Tick、K线）

**功能点**：
- F1.1: 获取Tick数据（秒级）
- F1.2: 获取多周期K线数据（1min, 5min, 1h, 1d等）
- F1.3: 数据缓存和去重
- F1.4: 数据格式标准化（时区、时间戳）

**验收标准（AR）**：
- AR1.1: 能够成功获取SIL2603的Tick数据，数据包含price、volume、timestamp
- AR1.2: 能够获取至少5种不同周期的K线数据
- AR1.3: 数据时间戳正确转换为北京时间
- AR1.4: 重复数据能够自动去重

#### Feature 2: 交易策略预测
**需求描述**：系统能够基于市场数据和模型，预测交易动作（买入/卖出/持有）

**功能点**：
- F2.1: 时段自适应网格策略
- F2.2: MoE Transformer模型预测
- F2.3: 多策略融合
- F2.4: 置信度计算

**验收标准（AR）**：
- AR2.1: 策略能够输出明确的交易动作（BUY/SELL/HOLD）
- AR2.2: 每个动作都有对应的置信度（0-1之间）
- AR2.3: 预测结果包含网格参数（上下轨、间距）
- AR2.4: 不同时段能够自动调整策略参数

#### Feature 3: 订单执行
**需求描述**：系统能够根据策略预测，在DEMO账户中执行真实订单

**功能点**：
- F3.1: 买入订单执行
- F3.2: 卖出订单执行
- F3.3: 订单状态查询和验证
- F3.4: 订单错误处理和重试

**验收标准（AR）**：
- AR3.1: 买入订单能够成功提交到Tiger API，返回有效order_id
- AR3.2: 卖出订单能够成功提交到Tiger API，返回有效order_id
- AR3.3: 订单提交后，能够通过API查询到订单状态（SUBMITTED/FILLED/REJECTED）
- AR3.4: 订单被拒绝时，能够获取拒绝原因（code、msg）
- AR3.5: 订单执行后，DEMO账户中能够看到真实订单记录

#### Feature 4: 风险管理
**需求描述**：系统在执行交易前，必须通过风险控制检查

**功能点**：
- F4.1: 仓位限制检查
- F4.2: 单笔损失限制
- F4.3: 日亏损限制
- F4.4: 止损价格计算
- F4.5: 止盈价格计算

**验收标准（AR）**：
- AR4.1: 达到最大仓位时，拒绝新的买入订单
- AR4.2: 单笔预期损失超过阈值时，拒绝订单
- AR4.3: 当日亏损超过限制时，拒绝所有订单
- AR4.4: 止损价格基于ATR和网格下轨计算，不低于最小值
- AR4.5: 止盈价格基于网格上轨和ATR计算

#### Feature 5: 数据提供和特征计算
**需求描述**：系统能够为策略提供计算好的市场特征和技术指标

**功能点**：
- F5.1: K线数据获取和缓存
- F5.2: Tick数据获取
- F5.3: 技术指标计算（ATR、RSI、BOLL等）
- F5.4: 市场趋势判断

**验收标准（AR）**：
- AR5.1: 能够获取最新K线数据，包含OHLCV
- AR5.2: 能够获取最新Tick价格
- AR5.3: 技术指标计算正确（ATR、RSI在合理范围内）
- AR5.4: 市场趋势判断输出（上涨/下跌/震荡）

#### Feature 6: 交易循环执行
**需求描述**：系统能够持续运行，定期获取数据、预测、执行交易

**功能点**：
- F6.1: 定时循环执行
- F6.2: 异常处理和恢复
- F6.3: 统计信息收集
- F6.4: 日志记录

**验收标准（AR）**：
- AR6.1: 系统能够持续运行至少20小时不崩溃
- AR6.2: 遇到API错误时，能够记录日志并继续运行
- AR6.3: 统计信息正确记录（预测次数、订单数、错误数）
- AR6.4: 关键操作都有日志记录

## 二、Feature级测试设计

### 2.1 Feature 1 测试：市场数据采集

**测试用例**：
- **TC-F1-001**: 获取Tick数据
  - 前置条件：API连接正常
  - 执行步骤：调用`get_tick_data('SIL.COMEX.202603')`
  - 预期结果：返回DataFrame，包含price、volume、timestamp字段
  - 验证：AR1.1

- **TC-F1-002**: 获取多周期K线
  - 前置条件：API连接正常
  - 执行步骤：分别获取1min、5min、1h、1d K线
  - 预期结果：每种周期都返回有效DataFrame
  - 验证：AR1.2

- **TC-F1-003**: 时区转换验证
  - 前置条件：获取K线数据
  - 执行步骤：检查时间戳时区
  - 预期结果：时间戳为北京时间（UTC+8）
  - 验证：AR1.3

### 2.2 Feature 2 测试：交易策略预测

**测试用例**：
- **TC-F2-001**: MoE Transformer策略预测
  - 前置条件：模型已加载，市场数据可用
  - 执行步骤：调用`strategy.predict_action(features)`
  - 预期结果：返回action（BUY/SELL/HOLD）和confidence
  - 验证：AR2.1, AR2.2

- **TC-F2-002**: 时段自适应参数调整
  - 前置条件：不同时段（高峰/低波动）
  - 执行步骤：调用策略预测
  - 预期结果：网格参数随时段变化
  - 验证：AR2.4

### 2.3 Feature 3 测试：订单执行（关键）

**测试用例**：
- **TC-F3-001**: 买入订单端到端测试
  - 前置条件：DEMO账户连接，有可用资金
  - 执行步骤：
    1. 调用`order_executor.execute_buy(...)`
    2. 获取返回的order_id
    3. 调用`trade_client.get_orders()`查询订单
  - 预期结果：
    - 订单提交成功，返回order_id
    - 查询API能找到该订单
    - DEMO账户后台能看到订单
  - 验证：AR3.1, AR3.3, AR3.5

- **TC-F3-002**: 卖出订单端到端测试
  - 前置条件：DEMO账户有持仓
  - 执行步骤：同TC-F3-001，但执行卖出
  - 预期结果：同TC-F3-001
  - 验证：AR3.2, AR3.3, AR3.5

- **TC-F3-003**: 订单拒绝处理
  - 前置条件：触发拒绝条件（如account为空）
  - 执行步骤：提交订单
  - 预期结果：返回失败，包含错误code和msg
  - 验证：AR3.4

### 2.4 Feature 4 测试：风险管理

**测试用例**：
- **TC-F4-001**: 仓位限制检查
  - 前置条件：当前持仓达到最大值
  - 执行步骤：尝试买入
  - 预期结果：风控检查返回False，订单被拒绝
  - 验证：AR4.1

- **TC-F4-002**: 止损计算
  - 前置条件：当前价格、ATR、网格下轨已知
  - 执行步骤：调用`compute_stop_loss(...)`
  - 预期结果：止损价格合理（不低于最小值）
  - 验证：AR4.4

### 2.5 Feature 5 测试：数据提供

**测试用例**：
- **TC-F5-001**: 市场数据获取
  - 前置条件：API连接正常
  - 执行步骤：调用`data_provider.get_market_data()`
  - 预期结果：返回包含K线、Tick、指标的数据字典
  - 验证：AR5.1, AR5.2, AR5.3

### 2.6 Feature 6 测试：交易循环

**测试用例**：
- **TC-F6-001**: 长时间运行测试
  - 前置条件：系统初始化完成
  - 执行步骤：运行`trading_executor.run_loop(duration_hours=20)`
  - 预期结果：运行20小时不崩溃，统计信息正确
  - 验证：AR6.1, AR6.3

## 三、Feature测试与代码测试的互补关系

### 3.1 Feature测试（业务视角）
- **关注点**：业务功能是否满足需求
- **测试粒度**：端到端功能
- **验证方式**：AR（验收标准）
- **覆盖范围**：关键业务流程

### 3.2 代码测试（技术视角）
- **关注点**：代码逻辑是否正确
- **测试粒度**：函数/类级别
- **验证方式**：单元测试、边界测试
- **覆盖范围**：所有代码路径

### 3.3 互补关系
- **Feature测试**确保"做对的事情"（业务正确性）
- **代码测试**确保"把事情做对"（技术正确性）
- **两者结合**：Feature测试发现业务问题，代码测试定位技术问题

## 四、测试执行计划

### 阶段1：Feature测试（优先级最高）
1. TC-F3-001, TC-F3-002（订单执行端到端）- **立即执行**
2. TC-F1-001, TC-F1-002（数据采集）
3. TC-F2-001（策略预测）
4. TC-F4-001, TC-F4-002（风险管理）

### 阶段2：代码测试补充
1. 补充`order_executor.py`的单元测试（覆盖所有分支）
2. 补充`trading_executor.py`的单元测试
3. 补充`data_provider.py`的单元测试
4. 补充`api_adapter.py`的单元测试

### 阶段3：集成测试
1. Feature测试用例自动化
2. 持续集成（CI）中运行Feature测试
3. 覆盖率报告包含Feature测试结果
