# å‡†ç¡®ç‡å’ŒæŸå¤±å‡½æ•°è¯´æ˜

**æ›´æ–°æ—¶é—´**: 2026-01-23

---

## ğŸ“Š ä¸€ã€å‡†ç¡®ç‡å®šä¹‰

### 1.1 ä¼ ç»Ÿå‡†ç¡®ç‡ï¼ˆAction Accuracyï¼‰

**å®šä¹‰**: é¢„æµ‹åŠ¨ä½œä¸çœŸå®æ ‡ç­¾åŒ¹é…çš„æ¯”ä¾‹

**è®¡ç®—å…¬å¼**:
```
å‡†ç¡®ç‡ = (é¢„æµ‹åŠ¨ä½œ == çœŸå®æ ‡ç­¾) çš„æ•°é‡ / æ€»æ ·æœ¬æ•°
```

**ä»£ç ä½ç½®**: `llm_strategy.py` è®­ç»ƒå¾ªç¯ä¸­

```python
predictions = torch.argmax(outputs, dim=1)
correct_predictions += (predictions == batch_y).sum().item()
total_predictions += batch_y.size(0)
accuracy = correct_predictions / total_predictions
```

**ç‰¹ç‚¹**:
- âœ… ç®€å•ç›´è§‚
- âŒ ä¸è€ƒè™‘å®é™…æ”¶ç›Š
- âŒ å¯èƒ½é«˜ä¼°æ¨¡å‹æ€§èƒ½ï¼ˆå¦‚æœé¢„æµ‹"ä¸æ“ä½œ"å¤šï¼Œå‡†ç¡®ç‡å¯èƒ½è™šé«˜ï¼‰

**ç¤ºä¾‹**:
- å¦‚æœæ¨¡å‹æ€»æ˜¯é¢„æµ‹"ä¸æ“ä½œ"ï¼ˆlabel=0ï¼‰ï¼Œè€Œæ•°æ®ä¸­"ä¸æ“ä½œ"å 50%ï¼Œå‡†ç¡®ç‡å°±æ˜¯50%
- ä½†è¿™ä¸ä»£è¡¨æ¨¡å‹å¥½ï¼Œå› ä¸ºé”™è¿‡äº†æ‰€æœ‰äº¤æ˜“æœºä¼š

---

### 1.2 æ”¶ç›ŠåŠ æƒå‡†ç¡®ç‡ï¼ˆProfit-based Accuracyï¼‰

**å®šä¹‰**: é¢„æµ‹åŠ¨ä½œçš„å®é™…æ”¶ç›Š / æœ€ä¼˜åŠ¨ä½œçš„æœ€å¤§å¯èƒ½æ”¶ç›Š

**è®¡ç®—å…¬å¼**:
```python
æ”¶ç›ŠåŠ æƒå‡†ç¡®ç‡ = æ€»é¢„æµ‹æ”¶ç›Š / æ€»æœ€å¤§å¯èƒ½æ”¶ç›Š

å…¶ä¸­ï¼š
- æ€»é¢„æµ‹æ”¶ç›Š = Î£(é¢„æµ‹åŠ¨ä½œçš„æ”¶ç›Š)
- æ€»æœ€å¤§å¯èƒ½æ”¶ç›Š = Î£(æœ€ä¼˜åŠ¨ä½œçš„æ”¶ç›Š)
```

**ä»£ç ä½ç½®**: `fair_model_comparison.py` çš„ `calculate_profit_based_accuracy()`

```python
def calculate_profit_based_accuracy(self, predictions, labels, prices, grid_params, look_ahead=10):
    total_profit = 0.0
    max_possible_profit = 0.0
    
    for i in range(len(predictions)):
        current_price = prices[i]
        future_prices = prices[i+1:i+look_ahead+1]  # æœªæ¥10æ­¥ä»·æ ¼
        
        # è®¡ç®—æ‰€æœ‰åŠ¨ä½œçš„æ”¶ç›Š
        profits = {
            0: 0.0,  # ä¸æ“ä½œæ”¶ç›Šä¸º0
            1: (max(future_prices) - current_price) / current_price,  # ä¹°å…¥æ”¶ç›Š
            2: (current_price - min(future_prices)) / current_price   # å–å‡ºæ”¶ç›Š
        }
        
        # æœ€ä¼˜åŠ¨ä½œçš„æ”¶ç›Š
        best_action = max(profits, key=profits.get)
        max_possible_profit += profits[best_action]
        
        # é¢„æµ‹åŠ¨ä½œçš„æ”¶ç›Š
        predicted_action = predictions[i]
        total_profit += profits[predicted_action]
    
    # æ”¶ç›ŠåŠ æƒå‡†ç¡®ç‡
    profit_accuracy = total_profit / max_possible_profit
    return profit_accuracy
```

**ç‰¹ç‚¹**:
- âœ… æ›´çœŸå®åæ˜ æ¨¡å‹çš„å®é™…äº¤æ˜“è¡¨ç°
- âœ… è€ƒè™‘å®é™…æ”¶ç›Šï¼Œè€Œä¸æ˜¯ç®€å•çš„åŠ¨ä½œåŒ¹é…
- âœ… å¦‚æœæ¨¡å‹æ€»æ˜¯é¢„æµ‹"ä¸æ“ä½œ"ï¼Œæ”¶ç›Šå‡†ç¡®ç‡ä¼šå¾ˆä½ï¼ˆå› ä¸ºé”™è¿‡äº†æ‰€æœ‰æ”¶ç›Šï¼‰

**ç¤ºä¾‹**:
- å¦‚æœæœ€ä¼˜åŠ¨ä½œèƒ½è·å¾—10%æ”¶ç›Šï¼Œæ¨¡å‹é¢„æµ‹çš„åŠ¨ä½œåªè·å¾—5%æ”¶ç›Šï¼Œæ”¶ç›Šå‡†ç¡®ç‡ = 5% / 10% = 0.5
- å¦‚æœæ¨¡å‹æ€»æ˜¯é¢„æµ‹"ä¸æ“ä½œ"ï¼Œæ”¶ç›Šå‡†ç¡®ç‡ = 0 / 10% = 0

---

## ğŸ”§ äºŒã€æŸå¤±å‡½æ•°ï¼ˆLOSS Functionï¼‰

### 2.1 åŠ¨ä½œåˆ†ç±»æŸå¤±ï¼ˆAction Classification Lossï¼‰

**æŸå¤±å‡½æ•°**: `nn.CrossEntropyLoss`ï¼ˆå¸¦ç±»åˆ«æƒé‡ï¼‰

**ä»£ç ä½ç½®**: `llm_strategy.py` ç¬¬344è¡Œ

```python
# è®¡ç®—ç±»åˆ«æƒé‡ï¼ˆå¤„ç†æ•°æ®ä¸å¹³è¡¡ï¼‰
class_weights = self.calculate_class_weights(y)
# ç±»åˆ«æƒé‡å…¬å¼: weight = total_samples / (num_classes * class_count)

# æ›´æ–°æŸå¤±å‡½æ•°
self.criterion = nn.CrossEntropyLoss(weight=class_weights)
```

**ç±»åˆ«æƒé‡è®¡ç®—**:
```python
def calculate_class_weights(self, y):
    classes, counts = np.unique(y, return_counts=True)
    total_samples = len(y)
    
    weights = []
    for count in counts:
        weight = total_samples / (len(classes) * count)
        weights.append(weight)
    
    class_weights = torch.FloatTensor(weights).to(self.device)
    return class_weights
```

**ä¸ºä»€ä¹ˆéœ€è¦ç±»åˆ«æƒé‡**:
- æ•°æ®ä¸å¹³è¡¡ï¼šä¹°å…¥(44%)ã€å–å‡º(44%)ã€ä¸æ“ä½œ(11%)
- å¦‚æœä¸åŠ æƒï¼Œæ¨¡å‹ä¼šåå‘é¢„æµ‹"ä¹°å…¥"æˆ–"å–å‡º"ï¼Œå¿½ç•¥"ä¸æ“ä½œ"
- åŠ æƒåï¼Œè®©æ¨¡å‹æ›´å…³æ³¨å°‘æ•°ç±»ï¼ˆ"ä¸æ“ä½œ"ï¼‰

---

### 2.2 ç½‘æ ¼è°ƒæ•´ç³»æ•°æŸå¤±ï¼ˆGrid Adjustment Lossï¼‰

**æŸå¤±å‡½æ•°**: `nn.MSELoss`ï¼ˆå‡æ–¹è¯¯å·®ï¼‰

**ä»£ç ä½ç½®**: `llm_strategy.py` ç¬¬345è¡Œ

```python
self.grid_criterion = nn.MSELoss() if train_grid_adjustment else None
```

**ç”¨é€”**: è®­ç»ƒæ¨¡å‹é¢„æµ‹ç½‘æ ¼è°ƒæ•´ç³»æ•°ï¼ˆ0.8-1.2èŒƒå›´ï¼‰

---

### 2.3 ç»„åˆæŸå¤±ï¼ˆCombined Lossï¼‰

**è®¡ç®—å…¬å¼**:
```python
loss = action_loss + 0.1 * grid_loss
```

**ä»£ç ä½ç½®**: `llm_strategy.py` ç¬¬443-449è¡Œ

```python
# åŠ¨ä½œåˆ†ç±»æŸå¤±
action_loss = self.criterion(action_logits, batch_y)

# ç½‘æ ¼è°ƒæ•´ç³»æ•°å›å½’æŸå¤±ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if train_grid_adjustment and batch_y_grid is not None:
    grid_loss = self.grid_criterion(grid_adjustment.squeeze(), batch_y_grid)
    # ç»„åˆæŸå¤±ï¼ˆç½‘æ ¼æŸå¤±æƒé‡0.1ï¼‰
    loss = action_loss + 0.1 * grid_loss
else:
    loss = action_loss
```

**æƒé‡è¯´æ˜**:
- `action_loss`: ä¸»è¦æŸå¤±ï¼ˆæƒé‡1.0ï¼‰
- `grid_loss`: è¾…åŠ©æŸå¤±ï¼ˆæƒé‡0.1ï¼‰
- ç½‘æ ¼è°ƒæ•´ç³»æ•°æ˜¯è¾…åŠ©ä»»åŠ¡ï¼Œä¸åº”è¯¥ä¸»å¯¼è®­ç»ƒ

---

## ğŸ·ï¸ ä¸‰ã€æ ‡ç­¾ï¼ˆLabelsï¼‰

### 3.1 åŠ¨ä½œæ ‡ç­¾ï¼ˆAction Labelsï¼‰

**æ ‡ç­¾å®šä¹‰**:
- `0`: ä¸æ“ä½œï¼ˆHoldï¼‰
- `1`: ä¹°å…¥ï¼ˆBuyï¼‰
- `2`: å–å‡ºï¼ˆSellï¼‰

**æ ‡ç­¾ç”Ÿæˆé€»è¾‘**: `llm_strategy.py` ç¬¬287-302è¡Œ

```python
# è®¡ç®—æœªæ¥10æ­¥çš„ä»·æ ¼å˜åŒ–
look_ahead = 10
current_price = df.iloc[i]['price_current']
future_prices = df.iloc[i+1:i+look_ahead+1]['price_current'].values

# è®¡ç®—ä¹°å…¥å’Œå–å‡ºçš„é¢„æœŸæ”¶ç›Š
max_future_price = max(future_prices)
min_future_price = min(future_prices)

buy_profit = (max_future_price - current_price) / current_price
sell_profit = (current_price - min_future_price) / current_price

# åˆ›å»ºæ ‡ç­¾
profit_threshold = 0.005  # 0.5% æ”¶ç›Šé˜ˆå€¼
min_diff = 0.003          # 0.3% æœ€å°å·®å€¼

if abs(buy_profit - sell_profit) >= min_diff:
    if buy_profit > sell_profit and buy_profit > profit_threshold:
        label = 1  # ä¹°å…¥
    elif sell_profit > buy_profit and sell_profit > profit_threshold:
        label = 2  # å–å‡º
    else:
        label = 0  # ä¸æ“ä½œ
else:
    label = 0  # ä¸æ“ä½œ - å·®å€¼å¤ªå°ï¼Œä¸ç¡®å®šæ€§é«˜
```

**æ ‡ç­¾ç”Ÿæˆè§„åˆ™**:
1. **ä¹°å…¥æ¡ä»¶**: 
   - ä¹°å…¥æ”¶ç›Š > å–å‡ºæ”¶ç›Š
   - ä¹°å…¥æ”¶ç›Š > 0.5%ï¼ˆprofit_thresholdï¼‰
   - ä¹°å–æ”¶ç›Šå·®å€¼ > 0.3%ï¼ˆmin_diffï¼‰

2. **å–å‡ºæ¡ä»¶**:
   - å–å‡ºæ”¶ç›Š > ä¹°å…¥æ”¶ç›Š
   - å–å‡ºæ”¶ç›Š > 0.5%ï¼ˆprofit_thresholdï¼‰
   - ä¹°å–æ”¶ç›Šå·®å€¼ > 0.3%ï¼ˆmin_diffï¼‰

3. **ä¸æ“ä½œæ¡ä»¶**:
   - ä¸æ»¡è¶³ä¹°å…¥æˆ–å–å‡ºæ¡ä»¶
   - æ”¶ç›Šå·®å€¼å¤ªå°ï¼ˆä¸ç¡®å®šæ€§é«˜ï¼‰

**ç‰¹ç‚¹**:
- âœ… åŸºäºæœªæ¥10æ­¥çš„å®é™…ä»·æ ¼å˜åŒ–
- âœ… è€ƒè™‘æ”¶ç›Šé˜ˆå€¼ï¼Œé¿å…é¢‘ç¹äº¤æ˜“
- âœ… è€ƒè™‘æ”¶ç›Šå·®å€¼ï¼Œé¿å…æ¨¡ç³Šæƒ…å†µ

---

### 3.2 ç½‘æ ¼è°ƒæ•´ç³»æ•°æ ‡ç­¾ï¼ˆGrid Adjustment Labelsï¼‰

**æ ‡ç­¾å®šä¹‰**: æµ®ç‚¹æ•°ï¼ŒèŒƒå›´ [0.8, 1.2]

**æ ‡ç­¾ç”Ÿæˆé€»è¾‘**: `llm_strategy.py` ç¬¬308-311è¡Œ

```python
if train_grid_adjustment and self.model.predict_grid_adjustment:
    optimal_adjustment = self.calculate_optimal_grid_adjustment(
        current_price, future_prices, grid_base
    )
    y_grid.append(optimal_adjustment)
```

**æœ€ä¼˜è°ƒæ•´ç³»æ•°è®¡ç®—**: `llm_strategy.py` ç¬¬220-250è¡Œ

```python
def calculate_optimal_grid_adjustment(self, current_price, future_prices, grid_base):
    """
    è®¡ç®—æœ€ä¼˜ç½‘æ ¼è°ƒæ•´ç³»æ•°
    
    ç›®æ ‡ï¼šæ‰¾åˆ°ä½¿æœªæ¥ä»·æ ¼å˜åŒ–èƒ½äº§ç”Ÿæœ€å¤šç½‘æ ¼äº¤æ˜“çš„è°ƒæ•´ç³»æ•°
    """
    if grid_base <= 0:
        return 1.0
    
    # è®¡ç®—æœªæ¥ä»·æ ¼çš„æœ€å¤§æ³¢åŠ¨èŒƒå›´
    price_range = max(future_prices) - min(future_prices)
    
    # ç†æƒ³æƒ…å†µä¸‹ï¼Œç½‘æ ¼é—´è·åº”è¯¥ä½¿å¾—ä»·æ ¼æ³¢åŠ¨èƒ½äº§ç”Ÿ2-3æ¬¡äº¤æ˜“
    # å¦‚æœä»·æ ¼æ³¢åŠ¨å¤§ï¼Œåº”è¯¥å¢å¤§ç½‘æ ¼é—´è·ï¼ˆè°ƒæ•´ç³»æ•°>1ï¼‰
    # å¦‚æœä»·æ ¼æ³¢åŠ¨å°ï¼Œåº”è¯¥å‡å°ç½‘æ ¼é—´è·ï¼ˆè°ƒæ•´ç³»æ•°<1ï¼‰
    
    optimal_spacing = price_range / 3.0  # ç†æƒ³ç½‘æ ¼é—´è·
    adjustment = optimal_spacing / grid_base
    
    # é™åˆ¶åœ¨ [0.8, 1.2] èŒƒå›´å†…
    adjustment = max(0.8, min(1.2, adjustment))
    
    return adjustment
```

**ç‰¹ç‚¹**:
- âœ… åŸºäºæœªæ¥ä»·æ ¼æ³¢åŠ¨åŠ¨æ€è°ƒæ•´
- âœ… é™åˆ¶åœ¨åˆç†èŒƒå›´å†…ï¼ˆ0.8-1.2ï¼‰
- âœ… ç›®æ ‡æ˜¯ä¼˜åŒ–ç½‘æ ¼äº¤æ˜“é¢‘ç‡

---

## ğŸ“Š å››ã€æ€»ç»“å¯¹æ¯”

| æŒ‡æ ‡ | ä¼ ç»Ÿå‡†ç¡®ç‡ | æ”¶ç›ŠåŠ æƒå‡†ç¡®ç‡ |
|------|-----------|---------------|
| **å®šä¹‰** | é¢„æµ‹åŠ¨ä½œ == æ ‡ç­¾ | é¢„æµ‹æ”¶ç›Š / æœ€ä¼˜æ”¶ç›Š |
| **ä¼˜ç‚¹** | ç®€å•ç›´è§‚ | æ›´çœŸå®åæ˜ äº¤æ˜“è¡¨ç° |
| **ç¼ºç‚¹** | ä¸è€ƒè™‘å®é™…æ”¶ç›Š | è®¡ç®—å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | åˆæ­¥è¯„ä¼° | æœ€ç»ˆè¯„ä¼° |

| æŸå¤±å‡½æ•° | åŠ¨ä½œåˆ†ç±»æŸå¤± | ç½‘æ ¼è°ƒæ•´æŸå¤± |
|---------|------------|------------|
| **ç±»å‹** | CrossEntropyLoss | MSELoss |
| **æƒé‡** | 1.0 | 0.1 |
| **ç”¨é€”** | é¢„æµ‹åŠ¨ä½œ | é¢„æµ‹ç½‘æ ¼è°ƒæ•´ç³»æ•° |

| æ ‡ç­¾ç±»å‹ | åŠ¨ä½œæ ‡ç­¾ | ç½‘æ ¼è°ƒæ•´æ ‡ç­¾ |
|---------|---------|------------|
| **èŒƒå›´** | 0, 1, 2 | 0.8 - 1.2 |
| **ç”Ÿæˆæ–¹å¼** | åŸºäºæœªæ¥10æ­¥ä»·æ ¼å˜åŒ– | åŸºäºæœªæ¥ä»·æ ¼æ³¢åŠ¨ |
| **ç”¨é€”** | è®­ç»ƒåŠ¨ä½œåˆ†ç±» | è®­ç»ƒç½‘æ ¼è°ƒæ•´ç³»æ•° |

---

## ğŸ¯ äº”ã€å…³é”®è¦ç‚¹

1. **ä¼ ç»Ÿå‡†ç¡®ç‡å¯èƒ½è™šé«˜**ï¼šå¦‚æœæ¨¡å‹æ€»æ˜¯é¢„æµ‹"ä¸æ“ä½œ"ï¼Œå‡†ç¡®ç‡å¯èƒ½å¾ˆé«˜ï¼Œä½†å®é™…æ”¶ç›Šä¸º0

2. **æ”¶ç›ŠåŠ æƒå‡†ç¡®ç‡æ›´çœŸå®**ï¼šç›´æ¥åæ˜ æ¨¡å‹çš„å®é™…äº¤æ˜“è¡¨ç°

3. **æŸå¤±å‡½æ•°ç»„åˆ**ï¼šä¸»è¦å…³æ³¨åŠ¨ä½œåˆ†ç±»ï¼Œç½‘æ ¼è°ƒæ•´æ˜¯è¾…åŠ©ä»»åŠ¡

4. **æ ‡ç­¾åŸºäºæœªæ¥æ•°æ®**ï¼šè¿™æ˜¯"å›æµ‹"çš„å…³é”®ï¼Œä½¿ç”¨æœªæ¥10æ­¥çš„ä»·æ ¼å˜åŒ–æ¥ç”Ÿæˆæ ‡ç­¾

5. **ç±»åˆ«æƒé‡å¾ˆé‡è¦**ï¼šå¤„ç†æ•°æ®ä¸å¹³è¡¡ï¼Œè®©æ¨¡å‹æ›´å…³æ³¨å°‘æ•°ç±»

---

**çŠ¶æ€**: æ‰€æœ‰å®šä¹‰å’Œå®ç°å·²å®Œå–„
