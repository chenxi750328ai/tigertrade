# 回溯：为何测试和 DEMO 都没发现「无止损止盈、超仓、超时未平」

## 一、为何测试没测出来

### 1. 测试只覆盖「主单成功」，没断言「止损/止盈单也提交」

- **现状**：`test_order_executor_comprehensive.py`、`test_feature_order_execution.py` 等只断言 `execute_buy` 返回成功、或 `trade_api.place_order` 被调用了**一次**（主单）。
- **缺失**：没有任何用例断言「主单成功后，又向交易所提交了止损单（STP）和止盈单（LMT）」——即没有检查 `place_order` 被调用的**次数**或**订单类型**。
- **结果**：OrderExecutor 只下主单、不下 SL/TP，测试照样绿，**测试设计上就漏掉了「每笔买入必须带止损止盈」这一约束**。

### 2. 测试没断言「TradingExecutor 每轮跑看门狗」

- **现状**：`test_trading_executor_comprehensive.py`、`test_executor_100_coverage.py` 里对 `run_loop` 的测试，要么 mock 掉 `get_market_data` / `execute_buy`，要么只跑极短时间（0.0001 小时），只断言 `stats['total_predictions'] >= 0`。
- **缺失**：没有断言「每轮循环内调用了 `run_position_watchdog`（或 `check_active_take_profits` / `check_timeout_take_profits`）」——即**没有把「有仓必查、超时止盈/止损必跑」当成契约来测**。
- **结果**：TradingExecutor 从未调用看门狗，测试也发现不了；**集成测试只关心「能跑起来」，没关心「跑起来后持仓会不会被超时/止损平掉」**。

### 3. 测试没覆盖「DEMO 路径下仓位硬顶 3 手」

- **现状**：`test_run_moe_demo_integration.py` 里设置了 `GRID_MAX_POSITION = 3`，并测了「风控存在」「止损价计算」等，但没有**在 DEMO 入口（TradingExecutor + OrderExecutor）下**模拟「连续买入 4～5 次」，断言第 4 次被风控拒绝或断言最终持仓 ≤ 3。
- **缺失**：没有「DEMO 路径 + 多次买入 + 断言 effective_max=3 / 持仓不超过 3」的集成用例；也没有测「时段自适应把 GRID_MAX_POSITION 改成 8 时，DEMO 仍只允许 3 手」。
- **结果**：时段覆盖导致上限变成 8/10、或风控未在 DEMO 路径生效，测试都发现不了；**测试只验证了「有风控函数」，没验证「DEMO 实际跑时风控会拦超仓」**。

### 4. 小结：测试为何没发现

| 问题 | 测试现状 | 缺什么 |
|------|----------|--------|
| 5 单无止损止盈 | 只断言主单成功，不断言 SL/TP 单 | 断言「主单成功后 place_order 再被调 2 次（STP+LMT）」或「订单类型/参数含止损止盈」 |
| 超时止盈/止损不跑 | 只断言 run_loop 能跑、统计≥0 | 断言「每轮调用了 run_position_watchdog 或等价止盈/止损检查」 |
| 8 手超仓 | 只测风控函数存在、止损价计算 | 「DEMO 路径 + 多次买入」断言持仓≤3、或 effective_max=3 |

根本原因：**测试偏重「代码能跑、接口有返回」，没有把「真实交易可靠性」写成可执行的断言**（每笔买入必带止损止盈、有仓必查超时止损、DEMO 硬顶 3 手）。

---

## 二、为何 DEMO 跑成这样也没发现

### 1. DEMO 没有自动化「结果校验」

- **现状**：DEMO 启动后长时间跑（如 20 小时），日志写进 `demo_run_20h_*.log`，没有配套的脚本在跑完后（或定时）检查：  
  - 是否出现「订单提交成功」但同一时段没有「止损」「止盈」；  
  - 账户持仓是否 > 3；  
  - 是否出现 `AttributeError: check_risk_control` 等异常。
- **缺失**：没有「DEMO 结果校验」步骤：既不基于日志做断言，也不基于 API 查持仓/订单做断言。
- **结果**：DEMO 挂了 5 单、无 SL/TP、甚至 8 手，只要进程没崩，就没人从数据上发现；**没有「跑完 DEMO 必须通过哪些检查」的硬性门槛**。

### 2. 没有对 DEMO 日志做持续监控/告警

- **现状**：有 `monitor_demo_20h.sh`、`cron_routine_monitor.sh` 等，但主要是「进程在不在」「有没有报错」；没有针对「每笔成交是否伴随止损/止盈」「持仓是否超限」的规则。
- **缺失**：没有在监控里加入：  
  - 若存在「订单提交成功」且同轮/同段时间没有「止损」「止盈」→ 告警；  
  - 若 `current_position` 或账户持仓 > 3 → 告警。
- **结果**：DEMO 跑成「有仓无卖、超时不止盈止损、超仓」时，**没有自动发现机制**，只能靠人工看日志或看账户。

### 3. 人工没有定期看 DEMO 日志/账户

- **现状**：DEMO 跑起来后，若无人定期打开日志看「下单与止损止盈是否成对」、或打开账户看「持仓手数」，问题会一直存在。
- **结果**：**没有把「DEMO 可靠性」纳入日常检查**，导致问题积累到 5 单、8 手才被用户发现。

### 4. 小结：为何 DEMO 没发现

| 原因 | 说明 |
|------|------|
| 无自动化结果校验 | 跑完 DEMO 没有「日志/API 断言」步骤，无法自动发现无 SL/TP、超仓 |
| 监控只盯进程/报错 | 没有「每笔成交必带止损止盈」「持仓≤3」的监控规则与告警 |
| 无定期人工复核 | 没有固定节奏看 DEMO 日志或账户，可靠性问题依赖事后才被提起 |

根本原因：**DEMO 被当成「能跑就行」的验证环境，没有把「每笔带止损止盈、不超仓、超时必平」设为必须通过的检查项，也没有自动化或人工的持续复核**。

---

## 三、后续应补的测试与监控

### 1. 测试应补

- **OrderExecutor 路径**：主单成功后，断言（在 mock 下）会再提交止损单、止盈单（例如 `place_order` 调用次数或参数包含 STP/LMT）。
- **TradingExecutor.run_loop**：在单轮或少量轮次内，断言调用了 `run_position_watchdog`（或 `check_active_take_profits` / `check_timeout_take_profits`），可通过对 `tiger1.run_position_watchdog` 做 mock 并断言被调用。
- **DEMO 路径仓位**：在「TradingExecutor + OrderExecutor + 风控用 tiger1」的集成场景下，模拟连续多次买入，断言最终 `current_position` 或风控拒绝次数满足「最多 3 手」。

### 2. DEMO 应补

- **结果校验脚本**：DEMO 跑完（或定时）解析最新 log：若存在「订单提交成功」则检查同段是否有「止损」「止盈」；可选：调 API 查持仓，若 > 3 则报错。
- **监控规则**：在现有 DEMO 监控中加入「无止损止盈」「持仓超限」的检测与告警（哪怕只是打日志 + 发通知）。
- **流程**：把「DEMO 跑完必须通过结果校验」写进文档/流程，必要时与发布或验收挂钩。

---

## 四、总结

- **测试没发现**：因为测试只验证了「能下单、能跑循环」，没有把「每笔带止损止盈」「每轮跑看门狗」「DEMO 硬顶 3 手」写成强制断言。
- **DEMO 没发现**：因为 DEMO 没有自动化结果校验、也没有针对「无止损止盈/超仓」的监控与告警，加上没有固定的人工复核节奏，导致问题一直留到真实暴露才被看到。

要避免类似问题再现，需要把**交易可靠性**（止损止盈、超时平仓、仓位上限）变成**可执行断言 + 自动化/人工复核**，而不是只依赖「代码能跑」。
