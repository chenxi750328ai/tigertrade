# 训练与运行一致性验证

**分析时间**: 2026-01-23  
**问题**: 训练测试和实际DEMO运行的是不是同一个东西？

---

## 🔍 一、模型架构一致性检查

### 1.1 训练时的模型架构

**代码位置**: `llm_strategy.py` - `__init__()`

```python
self.model = TradingLSTM(
    input_size=12,      # 12维特征
    hidden_size=64,
    num_layers=2,
    output_size=3       # 3个动作：0=不操作, 1=买入, 2=卖出
).to(self.device)
```

### 1.2 实际运行时的模型架构

**代码位置**: `tiger1.py` - LLM策略部分

```python
llm_strat = llm_strategy.LLMTradingStrategy()  # 使用相同的类
action, confidence = llm_strat.predict_action(current_data)  # 使用相同的模型
```

**结论**: ✅ **模型架构一致** - 使用同一个类 `LLMTradingStrategy`

---

## 🔍 二、数据格式一致性检查

### 2.1 训练时的数据格式

**代码位置**: `llm_strategy.py` - `train_model()`

```python
# 准备序列特征
sequence = self.prepare_sequence_features(df, i, seq_length)  # 序列长度10
X.append(sequence)

# 标签生成
current_price = df.iloc[i]['price_current']
future_prices = df.iloc[i+1:i+look_ahead+1]['price_current'].values
# 基于未来价格计算标签
```

**特征提取**: `prepare_sequence_features()` → `prepare_features()`
- 输入: `df.iloc[i]` (包含 `price_current`, `atr`, `rsi_1m`, `rsi_5m`, `grid_lower`, `grid_upper` 等)
- 输出: 12维特征向量

### 2.2 实际运行时的数据格式

**代码位置**: `tiger1.py` - LLM策略部分

```python
# 准备当前数据
current_data = {
    'price_current': tick_price,
    'grid_lower': grid_lower_val,
    'grid_upper': grid_upper_val,
    'atr': atr,
    'rsi_1m': rsi_1m,
    'rsi_5m': rsi_5m,
    ...
}

# 构建历史数据序列
historical_data_cache.append(current_data)
if len(historical_data_cache) >= llm_strat._seq_length:
    hist_df = pd.DataFrame(historical_data_cache[-llm_strat._seq_length:])
    llm_strat._historical_data = hist_df

# 预测
action, confidence = llm_strat.predict_action(current_data)
```

**特征提取**: `predict_action()` → `prepare_sequence_features()` → `prepare_features()`
- 输入: `current_data` (字典格式)
- 输出: 12维特征向量

**问题**: ⚠️ **数据格式可能不一致**
- 训练时: `df.iloc[i]` (pandas Series)
- 运行时: `current_data` (字典)

---

## 🔍 三、特征提取一致性检查

### 3.1 训练时的特征提取

**代码位置**: `llm_strategy.py` - `prepare_features()`

```python
def prepare_features(self, row):
    features = [
        row['price_current'],
        row['atr'],
        row['rsi_1m'] if pd.notna(row['rsi_1m']) else 50,
        row['rsi_5m'] if pd.notna(row['rsi_5m']) else 50,
        row['grid_lower'],
        row['grid_upper'],
        (row['price_current'] - row['grid_lower']) / (row['grid_upper'] - row['grid_lower']) if row['grid_upper'] != row['grid_lower'] else 0.5,
        row.get('boll_position', 0.5),
        row.get('volatility', 0.0),
        row.get('volume_ratio', 1.0),
        row.get('trend_strength', 0.0),
        row.get('momentum', 0.0)
    ]
    return features  # 12维特征
```

### 3.2 实际运行时的特征提取

**代码位置**: `llm_strategy.py` - `predict_action()`

```python
def predict_action(self, current_data):
    # 如果提供了历史数据和序列长度，使用序列数据
    if hasattr(self, '_seq_length') and self._seq_length > 1 and hasattr(self, '_historical_data'):
        historical_data = self._historical_data
        seq_length = self._seq_length
        if historical_data is not None and len(historical_data) >= seq_length:
            # 使用历史序列数据
            sequence = self.prepare_sequence_features(historical_data, current_idx, seq_length)
            # ...
        else:
            # 数据不足，使用单点特征
            features = self.prepare_features(current_data)  # ⚠️ 这里可能有问题
```

**问题**: ⚠️ **特征提取可能不一致**
- 训练时: `row` 是 pandas Series，有 `row['price_current']` 等
- 运行时: `current_data` 是字典，有 `current_data['price_current']` 等
- `prepare_features()` 需要同时支持 Series 和字典

---

## 🔍 四、准确率指标定义

### 4.1 训练时的准确率

**代码位置**: `llm_strategy.py` - `train_model()`

```python
# 计算准确率
predictions = torch.argmax(outputs, dim=1)  # 预测动作
correct_predictions += (predictions == batch_y).sum().item()  # 预测动作 == 标签
train_accuracy = correct_predictions / total_predictions
```

**定义**: 准确率 = 预测动作 == 标签的比例

### 4.2 标签生成逻辑

**代码位置**: `llm_strategy.py` - `train_model()`

```python
# 计算未来look_ahead步的盈利
current_price = df.iloc[i]['price_current']
future_prices = df.iloc[i+1:i+look_ahead+1]['price_current'].values

max_future_price = max(future_prices)
min_future_price = min(future_prices)

buy_profit = (max_future_price - current_price) / current_price
sell_profit = (current_price - min_future_price) / current_price

# 创建标签
if buy_profit > sell_profit and buy_profit > profit_threshold:
    label = 1  # 买入
elif sell_profit > buy_profit and sell_profit > profit_threshold:
    label = 2  # 卖出
else:
    label = 0  # 不操作
```

**问题**: ⚠️ **标签生成不考虑网格参数**
- 标签基于未来价格计算，但不考虑网格参数
- 如果网格参数不合理，标签可能不准确

### 4.3 实际运行时的"准确率"

**代码位置**: `tiger1.py` - LLM策略部分

```python
action, confidence = llm_strat.predict_action(current_data)
# 没有计算准确率，只有置信度
```

**问题**: ⚠️ **实际运行时没有准确率指标**
- 只有模型预测的动作和置信度
- 没有与"真实标签"比较（因为未来价格未知）

---

## ❌ 五、发现的问题

### 5.1 数据格式不一致 ⚠️

- 训练时: pandas Series (`df.iloc[i]`)
- 运行时: 字典 (`current_data`)
- `prepare_features()` 需要同时支持两种格式

### 5.2 特征提取可能不一致 ⚠️

- 训练时和运行时使用相同的 `prepare_features()` 函数
- 但如果输入格式不同，可能导致特征提取不一致

### 5.3 准确率定义不合理 ⚠️

- 准确率 = 预测动作 == 标签
- 但标签本身可能不准确（不考虑网格参数）
- 实际运行时没有准确率指标（因为未来价格未知）

### 5.4 网格参数处理不一致 ⚠️

- 训练时: 网格参数来自训练数据（可能是规则计算的）
- 运行时: 网格参数通过 `adjust_grid_interval()` 规则计算
- 如果训练数据和运行时的网格参数计算方式不同，可能导致不一致

---

## ✅ 六、结论

### 6.1 一致性检查结果

| 项目 | 训练时 | 运行时 | 一致性 |
|------|--------|--------|--------|
| **模型架构** | TradingLSTM(12, 64, 2, 3) | TradingLSTM(12, 64, 2, 3) | ✅ 一致 |
| **数据格式** | pandas Series | 字典 | ⚠️ 可能不一致 |
| **特征提取** | prepare_features(row) | prepare_features(current_data) | ⚠️ 可能不一致 |
| **序列长度** | 10 | 10 | ✅ 一致 |
| **网格参数** | 来自训练数据 | 规则计算 | ⚠️ 可能不一致 |

### 6.2 核心问题

1. **数据格式不一致** - 需要统一
2. **特征提取可能不一致** - 需要验证
3. **准确率定义不合理** - 需要改进
4. **网格参数处理不一致** - 需要统一

---

**状态**: 发现多个一致性问题，需要修复
