# 持仓上限 3 手：回溯说明

## 原来就有的代码

- **最初**：`tiger1.py` 里 `GRID_MAX_POSITION = 3`（最大持仓手数）是写死的，风控 `check_risk_control` 用它来拦「持仓 ≥ 3 不再买」。
- 所以 3 手上限**一直存在**，没有从代码里删掉过。

## 什么时候“没了”

- 后来引入了**时段自适应**（`time_period_strategy`）：不同时段有不同的 `max_position`（如 COMEX 欧美高峰 10 手、冬令时 8 手、沪银日盘 3 手等）。
- 在 `adjust_grid_interval()` 里会执行：`GRID_MAX_POSITION = grid_params['max_position']`，用**当前时段的配置覆盖**原来的 3。
- MoE/LLM 主循环每一轮都会调 `adjust_grid_interval(trend, inds)`，所以一旦进入「欧美高峰_冬令时」等时段，`GRID_MAX_POSITION` 就被改成 **8 或 10**。
- 风控仍然用 `current_position >= GRID_MAX_POSITION` 判断，但此时上限已经是 8/10，所以**看起来**“3 手上限没了”——其实是**被时段配置覆盖**了，不是代码被删。

## 结果

- DEMO 在高峰时段跑时，允许买到 8 手甚至更多，导致「整个账户持仓 8 手、大大超标」。

## 已做修复

1. **常量**：新增 `DEMO_MAX_POSITION = 3`，专用于 DEMO/沙箱，不被时段覆盖。
2. **风控**：在 `check_risk_control` 里，DEMO（`RUN_ENV == 'sandbox'`）时**一律用 `DEMO_MAX_POSITION`** 作为上限，不再用 `GRID_MAX_POSITION`（避免时段把它改成 8/10）。
3. **时段赋值**：在 `adjust_grid_interval` 里，DEMO 下把 `GRID_MAX_POSITION` 设为 `min(时段 max_position, DEMO_MAX_POSITION)`，从源头限制 DEMO 最多 3 手。

这样无论当前是哪个时段，DEMO 都只认 3 手上限；实盘仍可用时段的 8/10 等配置。

## 当前账户已 8 手怎么办

- 程序侧：重启 DEMO 后，新逻辑会拦「持仓≥3 再买」；若**进程内** `current_position` 与**交易所实际持仓**不一致（例如之前崩过、或手动在别处下单），需要：
  - 在老虎后台或手工把仓位减到 ≤3，或
  - 启动时从 API 同步一次实际持仓到 `current_position`，再跑策略。
- 建议：DEMO 启动时若检测到实际持仓 > 3，打日志并拒绝继续买入，直到人工处理。
