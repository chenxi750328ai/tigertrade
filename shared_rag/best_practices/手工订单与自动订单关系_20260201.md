# 手工订单与自动订单关系

**时间**: 2026-02-01  
**类别**: best_practices  
**标签**: manual_order, auto_order, risk, position

---

## 1. 关系说明

- **手工订单**：用户通过 `run/manual_orders.json` 下发的条件单（trigger/confirm/entry 或 direct_entry），由 `ManualOrderMonitor` 监控价格并在条件满足时通过回调（如 `on_fill`）**可**触发真实下单。
- **模型自动订单**：策略（如 MoE、网格）根据信号调用 `place_tiger_order` 下单。

**当前实现**：手工订单监控与主循环**未**在代码里绑定——即没有把 `ManualOrderMonitor.on_fill` 接到 `place_tiger_order`。因此：

- 手工订单**不会**自动改写 `current_position`、`position_entry_prices`、`daily_loss` 等；
- 模型自动订单的持仓与风控（如 `GRID_MAX_POSITION`、`DAILY_LOSS_LIMIT`）**不受**手工订单影响。

**若将来把手工单接到 `place_tiger_order`**：则手工单会与自动单共用同一套持仓与风控——手工单建仓会增加 `current_position`，受同一持仓上限和日亏损限制；平仓会减少持仓。建议在接入时明确文档和测试。**下单时需传 `source="manual"`**，以便订单 LOG 中区分手工订单与自动订单。

---

## 2. 风控与持仓

- 自动订单使用：`tiger1.current_position`、`position_entry_prices`、`check_risk_control()`、`GRID_MAX_POSITION`、`DAILY_LOSS_LIMIT`。
- 手工订单在「仅监控、不接 place_tiger_order」的前提下，不参与上述风控与持仓统计；若接入，则与自动单统一风控。

---

## 3. 直接下单（不用 trigger/confirm）

当 **trigger/confirm 无效或不用** 时，可设 `direct_entry: true`，只使用 **entry / stop_loss / take_profit**：

- JSON 示例：`{"direction":"long","entry":28.9,"stop_loss":28.3,"take_profit":29.2,"direct_entry":true}`
- 逻辑：不等 trigger/confirm，价格触及 **entry** 即视为建仓，然后按 **stop_loss** / **take_profit** 监控平仓。
- 回测：`--long-direct entry stop_loss take_profit` 或 JSON 中 `"direct_entry":true`。
